"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[285],{29333:($,I,t)=>{t.d(I,{U:()=>l});var s=t(49962);const l=s.Hr.injectEndpoints({endpoints:m=>({getRuleHistory:m.query({query:({ruleUid:o,from:x,to:d,limit:h=100})=>({url:"/api/v1/rules/history",params:{ruleUID:o,from:x,to:d,limit:h}})})})})},95584:($,I,t)=>{t.d(I,{A:()=>y});var s=t(74848),l=t(96540),m=t(70713),o=t(52622),x=t(40845),d=t(82389),h=t(28895);const f=M=>M,y=(0,l.memo)(({frames:M,timeRange:E})=>{const L=(0,x.$j)();return(0,s.jsx)(m.Ay,{disableHeight:!0,children:({width:B})=>(0,s.jsx)(d.I,{frames:M,timeRange:E,timeZone:"browser",mode:h.pm.Changes,height:18*M.length+50,width:B,showValue:o.yL.Never,theme:L,rowHeight:.8,legend:{calcs:[],displayMode:o.lm.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:L.colors.success.main,yAxis:1},{label:"Pending",color:L.colors.warning.main,yAxis:1},{label:"Firing",color:L.colors.error.main,yAxis:1},{label:"No Data",color:L.colors.info.main,yAxis:1},{label:"Mixed",color:L.colors.text.secondary,yAxis:1}],replaceVariables:f})})});y.displayName="LogTimelineViewer"},285:($,I,t)=>{t.r(I),t.d(I,{default:()=>cs,getStyles:()=>ss,useFrameSubset:()=>_});var s=t(74848),l=t(32196),m=t(2543),o=t(96540),x=t(49785),d=t(47232),h=t(40845),f=t(42418),y=t(67061),M=t(56034),E=t(14578),L=t(55852),B=t(88575),V=t(60029),Q=t(10354),u=t(29333),O=t(98164),N=t(69087),C=t(35108),W=t(72095),D=t(72724),R=t(64149),P=t(8406),b=t(30423),g=t(70026);function v(e){const n=e.reduce((a,r)=>{const p=a.get(r.timestamp);return p?p.push(r):a.set(r.timestamp,[r]),a},new Map);return new Map([...n].sort((a,r)=>r[0]-a[0]))}const U=(0,o.memo)(({records:e,commonLabels:n,onLabelClick:a,onRecordsRendered:r})=>{const p=(0,h.of)(A),S=v(e),c=new Map;return(0,o.useEffect)(()=>{r&&r(c)}),(0,s.jsx)("ul",{className:p.logsScrollable,"aria-label":"State history by timestamp",children:Array.from(S.entries()).map(([j,F])=>(0,s.jsxs)("li",{id:j.toString(10),"data-testid":j,ref:T=>T&&c.set(j,T),className:p.listItemWrapper,children:[(0,s.jsx)(G,{time:j}),(0,s.jsx)("div",{className:p.logsContainer,children:F.map(({line:T})=>(0,s.jsxs)(o.Fragment,{children:[(0,s.jsx)(b.C,{state:T.previous,size:"sm",muted:!0}),(0,s.jsx)(E.I,{name:"arrow-right",size:"sm"}),(0,s.jsx)(b.C,{state:T.current}),(0,s.jsx)(y.B,{children:T.values&&(0,s.jsx)(i,{record:T.values})}),(0,s.jsx)("div",{children:T.labels&&(0,s.jsx)(R.L,{tags:(0,g.$)(Object.entries(T.labels),n).map(([H,X])=>`${H}=${X}`),onClick:a})})]},(0,m.uniqueId)()))})]},j))})});U.displayName="LogRecordViewerByTimestamp";function as({records:e,commonLabels:n}){const a=useStyles2(A),r=groupBy(e,p=>JSON.stringify(p.line.labels));return jsx(Fragment,{children:Object.entries(r).map(([p,S])=>jsxs(Stack,{direction:"column",children:[jsx("h4",{children:jsx(TagList,{tags:omitLabels(Object.entries(S[0].line.labels??{}),n).map(([c,j])=>`${c}=${j}`)})}),jsx("div",{className:a.logsContainer,children:S.map(({line:c,timestamp:j})=>jsxs("div",{children:[jsx(AlertStateTag,{state:c.previous,size:"sm",muted:!0}),jsx(Icon,{name:"arrow-right",size:"sm"}),jsx(AlertStateTag,{state:c.current}),jsx(Stack,{children:c.values&&jsx(i,{record:c.values})}),jsx("div",{children:dateTimeFormat(j)})]},uniqueId()))})]},p))})}const G=({time:e})=>{const n=new Date(e),a=(0,h.of)(A);return(0,s.jsx)("div",{className:a.timestampWrapper,children:(0,s.jsxs)(y.B,{alignItems:"center",gap:1,children:[(0,s.jsx)(E.I,{name:"clock-nine",size:"sm"}),(0,s.jsx)("span",{className:a.timestampText,children:(0,D.LE)(n)}),(0,s.jsxs)("small",{children:["(",(0,W.B)(n)," ago)"]})]})})},i=(0,o.memo)(({record:e})=>{const n=Object.entries(e);return(0,s.jsx)(s.Fragment,{children:n.map(([a,r])=>(0,s.jsx)(P.J,{label:a,value:r},a))})});i.displayName="AlertInstanceValues";const A=e=>({logsContainer:(0,l.css)({display:"grid",gridTemplateColumns:"max-content max-content max-content auto max-content",gap:e.spacing(2,1),alignItems:"center"}),logsScrollable:(0,l.css)({height:"500px",overflow:"scroll",flex:1}),timestampWrapper:(0,l.css)({color:e.colors.text.secondary}),timestampText:(0,l.css)({color:e.colors.text.primary,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightBold}),listItemWrapper:(0,l.css)({background:"transparent",outline:"1px solid transparent",padding:`${e.spacing(1)} ${e.spacing(1.5)}`,[e.transitions.handleMotion("no-preference","reduce")]:{transition:"background 150ms, outline 150ms"}})});var Z=t(95584),z=t(14084);const rs=10*1e3,os=12,ls=({ruleUID:e})=>{const n=(0,h.of)(ss),[a,r]=(0,o.useState)(""),p=(0,o.useRef)(new Map),{getValues:S,setValue:c,register:j,handleSubmit:F}=(0,x.mN)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:T}=u.U,H=(0,o.useMemo)(()=>is(),[]),{currentData:X,isLoading:ms,isError:ds,error:ts}=T({ruleUid:e,from:H.from.unix(),to:H.to.unix(),limit:250},{refetchOnFocus:!0,refetchOnReconnect:!0,pollingInterval:rs}),{dataFrames:Y,historyRecords:us,commonLabels:w,totalRecordsCount:k}=(0,z.mW)(X,a),{frameSubset:J,frameTimeRange:gs}=_(Y),ps=(0,o.useCallback)(K=>{const ns=(0,O.EU)(S("query"),K);r(ns),c("query",ns)},[r,c,S]),es=(0,o.useCallback)(()=>{r(""),c("query","")},[r,c]);if(ms)return(0,s.jsx)("div",{children:"Loading..."});if(ds)return(0,s.jsx)(f.F,{title:"Error fetching the state history",severity:"error",children:ts instanceof Error?ts.message:"Unable to fetch alert state history"});const hs=J.length<Y.length,fs=k>0?`No matches were found for the given filters among the ${k} instances`:"No state transitions have occurred in the last 30 days";return(0,s.jsxs)("div",{className:n.fullSize,children:[(0,s.jsxs)("form",{onSubmit:F(K=>r(K.query)),children:[(0,s.jsx)(q,{...j("query"),showClearFilterSuffix:!!a,onClearFilterClick:es}),(0,s.jsx)("input",{type:"submit",hidden:!0})]}),!(0,m.isEmpty)(w)&&(0,s.jsx)("div",{className:n.commonLabels,children:(0,s.jsxs)(y.B,{gap:1,alignItems:"center",children:[(0,s.jsx)("strong",{children:"Common labels"}),(0,s.jsx)(M.m,{content:"Common labels are the ones attached to all of the alert instances",children:(0,s.jsx)(E.I,{name:"info-circle"})}),(0,s.jsx)(N.m,{labels:(0,m.fromPairs)(w),size:"sm"})]})}),(0,m.isEmpty)(J)?(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("div",{className:n.emptyState,children:[fs,k>0&&(0,s.jsx)(L.$n,{variant:"secondary",type:"button",onClick:es,children:"Clear filters"})]})}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:n.graphWrapper,children:(0,s.jsx)(Z.A,{frames:J,timeRange:gs})}),hs&&(0,s.jsx)("div",{className:n.moreInstancesWarning,children:(0,s.jsxs)(y.B,{direction:"row",alignItems:"center",gap:1,children:[(0,s.jsx)(E.I,{name:"exclamation-triangle",size:"sm"}),(0,s.jsx)("small",{children:`Only showing ${J.length} out of ${Y.length} instances. Click on the labels to narrow down the results`})]})}),(0,s.jsx)(U,{records:us,commonLabels:w,onRecordsRendered:K=>p.current=K,onLabelClick:ps})]})]})};function _(e){return(0,o.useMemo)(()=>{const n=(0,m.take)(e,os),a=(0,m.sortBy)((0,m.uniq)(n.flatMap(F=>F.fields[0].values))),r=Math.min(...a),p=Math.max(...a),S=(0,d.KQ)(r),c=(0,d.KQ)(p);return{frameSubset:n,frameSubsetTimestamps:a,frameTimeRange:{from:S,to:c,raw:{from:S,to:c}}}},[e])}const q=o.forwardRef(({showClearFilterSuffix:e,onClearFilterClick:n,...a},r)=>(0,s.jsx)(B.D,{label:(0,s.jsx)(V.J,{htmlFor:"instancesSearchInput",children:(0,s.jsxs)(y.B,{gap:.5,children:[(0,s.jsx)("span",{children:"Filter instances"}),(0,s.jsx)(C.j,{content:(0,s.jsxs)(s.Fragment,{children:["Use label matcher expression (like ",(0,s.jsx)("code",{children:"{foo=bar}"}),") or click on an instance label to filter instances"]}),children:(0,s.jsx)(E.I,{name:"info-circle",size:"sm"})})]})}),children:(0,s.jsx)(Q.p,{id:"instancesSearchInput",prefix:(0,s.jsx)(E.I,{name:"search"}),suffix:e&&(0,s.jsx)(L.$n,{fill:"text",icon:"times",size:"sm",onClick:n,children:"Clear"}),placeholder:"Filter instances",ref:r,...a})}));q.displayName="SearchFieldInput";function is(){const e=(0,d.KQ)().subtract(30,"days"),n=(0,d.KQ)();return{from:e,to:n,raw:{from:e,to:n}}}const ss=e=>({fullSize:(0,l.css)({minWidth:"100%",height:"100%",display:"flex",flexDirection:"column"}),graphWrapper:(0,l.css)({padding:`${e.spacing()} 0`}),emptyState:(0,l.css)({color:e.colors.text.secondary,display:"flex",flexDirection:"column",gap:e.spacing(2),alignItems:"center",margin:"auto auto"}),moreInstancesWarning:(0,l.css)({color:e.colors.warning.text,padding:e.spacing()}),commonLabels:(0,l.css)({display:"grid",gridTemplateColumns:"max-content auto"}),highlightedLogRecord:(0,l.css)({background:`${e.colors.primary.transparent} !important`,outline:`1px solid ${e.colors.primary.shade} !important`})}),cs=ls},70026:($,I,t)=>{t.d(I,{$:()=>m,Q:()=>o});var s=t(2543),l=t.n(s);function m(x,d){return x.filter(h=>!d.find(f=>JSON.stringify(f)===JSON.stringify(h)))}function o(x){const d=x.flatMap(f=>f);return(0,s.uniqBy)(d.filter(f=>d.filter(M=>(0,s.isEqual)(f,M)).length===Object.keys(x).length),f=>JSON.stringify(f))}},14084:($,I,t)=>{t.d(I,{PA:()=>V,bF:()=>B,mW:()=>L});var s=t(2543),l=t.n(s),m=t(96540),o=t(11261),x=t(57875),d=t(48241),h=t(73134),f=t(40845),y=t(98164),M=t(32642),E=t(70026);function L(u,O){const N=(0,f.$j)();return(0,m.useMemo)(()=>{const C=u?.data?.values[0]??[],W=B(C)?C:[],D=u?.data?.values[1]??[],R=W.reduce((i,A,Z)=>{const z=D[Z];return V(z)&&i.push({timestamp:A,line:z}),i},[]),P=(0,s.groupBy)(R,i=>JSON.stringify(i.line.labels)),g=Object.keys(P).map(i=>Object.entries(JSON.parse(i))),v=(0,E.Q)(g),U=O?(0,M.Zc)(O):[],G=Object.entries(P).filter(([i])=>{const A=JSON.parse(i);return(0,y.Av)(A,U)}).map(([i,A])=>Q(i,A,v,N));return{historyRecords:R.filter(({line:i})=>i.labels&&(0,y.Av)(i.labels,U)),dataFrames:G,commonLabels:v,totalRecordsCount:R.length}},[u,O,N])}function B(u){return u.every(O=>typeof O=="number")}function V(u){return typeof u=="object"&&u!==null&&"current"in u&&"previous"in u}function Q(u,O,N,C){const W=Object.entries(JSON.parse(u)),D={name:"time",type:o.PU.time,values:[...O.map(g=>g.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},R=D.values.map((g,v)=>v);R.sort((0,d.i)(D));const P=[...O.map(g=>g.line.current),O.at(-1)?.line.current],b={fields:[{...D,values:D.values.map((g,v)=>D.values[R[v]])},{name:"State",type:o.PU.string,values:P.map((g,v)=>P[R[v]]),config:{displayName:(0,E.$)(W,N).map(([g,v])=>`${g}=${v}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:h.dM.ValueToText,options:{Alerting:{color:C.colors.error.main},Pending:{color:C.colors.warning.main},Normal:{color:C.colors.success.main},NoData:{color:C.colors.info.main}}}],thresholds:{mode:h.Ol.Absolute,steps:[]}}}],length:D.values.length,name:u};return b.fields.forEach(g=>{g.display=(0,x.J)({field:g,theme:C})}),b}}}]);

//# sourceMappingURL=285.0f53426aebe7f3ec2953.js.map