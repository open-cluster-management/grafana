"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9569],{39569:(Et,Z,s)=>{s.d(Z,{L:()=>Re});var l=s(74848),y=s(96540),z=s(71468),X=s(79971),Q=s(80095),Y=s(94701);function v({children:n,width:t,height:i,onLoad:e,onChange:a}){const o=(0,y.useId)(),[r,d]=(0,y.useState)(!1),[c,h]=(0,y.useState)(!1),p=(0,y.useRef)(null);return(0,Y.A)(()=>{v.addCallback(o,m=>{!r&&m.isIntersecting&&(d(!0),e?.()),h(m.isIntersecting),a?.(m.isIntersecting)});const g=p.current;return g&&v.observer.observe(g),()=>{delete v.callbacks[o],g&&v.observer.unobserve(g),Object.keys(v.callbacks).length===0&&v.observer.disconnect()}}),(0,l.jsx)("div",{id:o,ref:p,style:{width:t,height:i},children:r&&(typeof n=="function"?n({isInView:c}):n)})}const q={};v.callbacks=q,v.addCallback=(n,t)=>v.callbacks[n]=t,v.observer=new IntersectionObserver(n=>{for(const t of n)v.callbacks[t.target.id]&&v.callbacks[t.target.id](t)},{rootMargin:"100px"});var w=s(64423),P=s(39070),O=s(43127),j=s(7376),A=s(91052),x=s(2913),J=s(15054),B=s(40334),b=s(74856),lt=s(36663),Pt=s(72574),V=s(39601),yt=s(32264),_=s(7758),H=s(16560),It=s(32349),Dt=s(8480),R=s(32196),tt=s(43585),dt=s(40845),et=s(56034),K=s(14578),xt=s(15666),U=s(38138),St=s(83122),Tt=s(27746);function Nt({panelLinks:n,onShowPanelLinks:t}){const i=(0,dt.of)(Ot),e=()=>{const a=t();return(0,l.jsx)(U.W,{children:a?.map((o,r)=>(0,l.jsx)(U.W.Item,{label:o.title,url:o.href,target:o.target,onClick:o.onClick},r))})};if(n.length===1){const a=t()[0];return(0,l.jsx)(A.NR.TitleItem,{href:a.href,onClick:a.onClick,target:a.target,title:a.title,children:(0,l.jsx)(K.I,{name:"external-link-alt",size:"md"})})}else return(0,l.jsx)(St.m,{overlay:e,children:(0,l.jsx)(Tt.I,{icon:"external-link-alt",iconSize:"md","aria-label":"panel links",className:i.menuTrigger})})}const Ot=n=>({menuTrigger:(0,R.css)({height:"100%",background:"inherit",border:"none",borderRadius:`${n.shape.radius.default}`,cursor:"context-menu"})});var At=s(2038);function Mt(n){const{alertState:t,data:i,panelId:e,onShowPanelLinks:a,panelLinks:o,angularNotice:r}=n,d=(0,dt.of)(Lt),c=(0,l.jsx)(et.m,{content:t??"unknown",children:(0,l.jsx)(A.NR.TitleItem,{className:(0,R.cx)({[d.ok]:t===tt.O.OK,[d.pending]:t===tt.O.Pending,[d.alerting]:t===tt.O.Alerting}),children:(0,l.jsx)(K.I,{name:t==="alerting"?"heart-break":"heart",size:"md"})})}),h=(0,l.jsx)(l.Fragment,{children:i.request&&i.request.timeInfo&&(0,l.jsx)(et.m,{content:(0,l.jsx)(xt.xS,{timeRange:i.request?.range,timeZone:i.request?.timezone}),children:(0,l.jsxs)(A.NR.TitleItem,{className:d.timeshift,children:[(0,l.jsx)(K.I,{name:"clock-nine",size:"md"})," ",i.request?.timeInfo]})})}),p=`This ${Rt(r)} requires Angular (deprecated).`,g=(0,l.jsx)(et.m,{content:p,children:(0,l.jsx)(A.NR.TitleItem,{className:d.angularNotice,"data-testid":"angular-deprecation-icon",children:(0,l.jsx)(K.I,{name:"exclamation-triangle",size:"md"})})});return(0,l.jsxs)(l.Fragment,{children:[o&&o.length>0&&a&&(0,l.jsx)(Nt,{onShowPanelLinks:a,panelLinks:o}),(0,l.jsx)(At.Z,{panelId:e,frames:i.series}),h,t&&c,r?.show&&g]})}const Rt=n=>n?.isAngularPanel?"panel":n?.isAngularDatasource?"data source":"panel or data source",Lt=n=>({ok:(0,R.css)({color:n.colors.success.text,"&:hover":{color:n.colors.emphasize(n.colors.success.text,.03)}}),pending:(0,R.css)({color:n.colors.warning.text,"&:hover":{color:n.colors.emphasize(n.colors.warning.text,.03)}}),alerting:(0,R.css)({color:n.colors.error.text,"&:hover":{color:n.colors.emphasize(n.colors.error.text,.03)}}),timeshift:(0,R.css)({color:n.colors.text.link,gap:n.spacing(.5),whiteSpace:"nowrap","&:hover":{color:n.colors.emphasize(n.colors.text.link,.03)}}),angularNotice:(0,R.css)({color:n.colors.warning.text})});function ct(n){function t(){return n.data.request&&n.data.request.timeInfo?!1:!n.panel.hasTitle()}const i=()=>{const C=(0,Pt.w)().replace(n.panel.description,n.panel.scopedVars);return(0,lt.G)(C)},e=()=>{const C=(0,It.E7)(n.panel);if(!C)return[];const L=C&&C.getLinks(n.panel.replaceVariables);return L.map(k=>({...k,onClick:(...E)=>{_.c.panelLinkClicked({has_multiple_links:L.length>1}),k.onClick?.(...E)}}))},a=(C,L)=>{C.stopPropagation(),V.Ny.partial({inspect:n.panel.id,inspectTab:L})},o=C=>{C.stopPropagation(),V.Ny.partial({inspect:n.panel.id,inspectTab:H.q.Error}),_.c.panelStatusMessageClicked()},r=()=>{n.panel.getQueryRunner().cancelQuery(),_.c.panelCancelQueryClicked({data_state:n.data.state})},d=n.plugin.noPadding?"none":"md",c=n.data.alertState?.state,h=n.panel.datasource?.uid?(0,Dt.Hv)(n.panel.datasource?.uid):!1,p=n.panel.isAngularPlugin()&&!n.plugin.meta.angular?.hideDeprecation,g=(yt.$.featureToggles.angularDeprecationUI??!1)&&(h||p),D=(n.panel.links&&n.panel.links.length>0&&e||n.data.series.length>0&&n.data.series.some(C=>(C.meta?.notices?.length??0)>0)||n.data.request&&n.data.request.timeInfo||g||c)&&(0,l.jsx)(Mt,{alertState:c,data:n.data,panelId:n.panel.id,panelLinks:n.panel.links,angularNotice:{show:g,isAngularDatasource:h,isAngularPanel:p},onShowPanelLinks:e}),W=n.panel.description?i:void 0,rt=!(n.isViewing||n.isEditing)&&(n.isDraggable??!0)?"grid-drag-handle":"",I=n.panel.getDisplayTitle();return{hasOverlayHeader:t,onShowPanelDescription:i,onShowPanelLinks:e,onOpenInspector:a,onOpenErrorInspect:o,onCancelQuery:r,padding:d,description:W,dragClass:rt,title:I,titleItems:D}}var Ft=s(13544);function Vt({items:n}){const t=i=>i.map(e=>{switch(e.type){case"divider":return(0,l.jsx)(U.W.Divider,{},e.text);case"group":return(0,l.jsx)(U.W.Group,{label:e.text,children:e.subMenu?t(e.subMenu):void 0},e.text);default:return(0,l.jsx)(U.W.Item,{label:e.text,icon:e.iconClassName,childItems:e.subMenu?t(e.subMenu):void 0,url:e.href,onClick:e.onClick,shortcut:e.shortcut,testId:Ft.Tp.components.Panels.Panel.menuItems(e.text)},e.text)}});return(0,l.jsx)(U.W,{children:t(n)})}var Ut=s(74135),jt=s(1933),bt=s(3197),Ht=s(31678),Gt=s(76885),Wt=s(3169),f=s(8484),kt=s(16001),ht=s(16233),zt=s(94954),Qt=s(87490),wt=s(63066),M=s(19752),Jt=s(82792),Bt=s(75462),Kt=s(14348),nt=s(99140),$t=s(75471),Zt=s(29436);function Xt(n,t,i,e){const a=u=>{u.preventDefault(),V.Ny.partial({viewPanel:t.id})},o=u=>{u.preventDefault(),V.Ny.partial({editPanel:t.id})},r=u=>{u.preventDefault(),(0,M.Mc)(n,t)},d=u=>{u.preventDefault(),(0,M.d7)(n,t)},c=u=>{u.preventDefault(),(0,M.ZY)(t)},h=u=>{V.Ny.partial({inspect:t.id,inspectTab:u})},p=u=>{u.preventDefault()},g=u=>{u.preventDefault(),(0,M.iU)(n,t)},m=u=>{u.preventDefault(),(0,M.KJ)(t)},D=u=>{u.preventDefault(),(0,M.FC)(n,t,!0)},W=u=>{u.preventDefault();const T=u.ctrlKey||u.metaKey?N=>window.open(`${x.Ay.appSubUrl}${N}`):void 0;nt.M_.dispatch((0,Zt.ow)(t,{timeRange:(0,b.jG)().timeRange(),getExploreUrl:Qt.Xe,openInNewWindow:T}))},rt=u=>{u.preventDefault(),(0,M.ET)(t)},I=[];t.isEditing||I.push({text:(0,f.t)("panel.header-menu.view","View"),iconClassName:"eye",onClick:a,shortcut:"v"}),n.canEditPanel(t)&&!t.isEditing&&I.push({text:(0,f.t)("panel.header-menu.edit","Edit"),iconClassName:"edit",onClick:o,shortcut:"e"}),I.push({text:(0,f.t)("panel.header-menu.share","Share"),iconClassName:"share-alt",onClick:r,shortcut:"p s"}),ht.TP.hasAccessToExplore()&&!(t.plugin&&t.plugin.meta.skipDataQuery)&&t.datasource?.uid!==Kt.K&&I.push({text:(0,f.t)("panel.header-menu.explore","Explore"),iconClassName:"compass",onClick:W,shortcut:"p x"});const C=[];t.plugin&&!t.plugin.meta.skipDataQuery&&(C.push({text:(0,f.t)("panel.header-menu.inspect-data","Data"),onClick:u=>h(H.q.Data)}),n.meta.canEdit&&C.push({text:(0,f.t)("panel.header-menu.query","Query"),onClick:u=>h(H.q.Query)})),C.push({text:(0,f.t)("panel.header-menu.inspect-json","Panel JSON"),onClick:u=>h(H.q.JSON)}),I.push({type:"submenu",text:(0,f.t)("panel.header-menu.inspect","Inspect"),iconClassName:"info-circle",onClick:u=>{const T=u.currentTarget,N=u.target;(N===T||N instanceof HTMLElement&&N.closest('[role="menuitem"]')===T)&&h()},shortcut:"i",subMenu:C});const L=async()=>{let u;try{u=await(0,wt.mp)(t,n)}catch(N){const F=`Error getting rule values from the panel: ${(0,zt.q)(N)}`;(0,nt.JD)((0,kt.dx)((0,Wt.gi)(F)));return}const T=Gt.kM.renderUrl("/alerting/new",{defaults:JSON.stringify(u),returnTo:location.pathname+location.search});V.Ny.push(T)},k=u=>{u.preventDefault(),L()},E=[],mt=n.canEditPanel(t),Ct=(0,$t.q0)();if(t.isViewing||t.isEditing||(mt?(E.push({text:(0,f.t)("panel.header-menu.duplicate","Duplicate"),onClick:g,shortcut:"p d"}),E.push({text:(0,f.t)("panel.header-menu.copy","Copy"),onClick:m}),(0,Jt.X)(t)?E.push({text:(0,f.t)("panel.header-menu.unlink-library-panel","Unlink library panel"),onClick:c}):E.push({text:(0,f.t)("panel.header-menu.create-library-panel","Create library panel"),onClick:d})):ht.TP.isEditor&&E.push({text:(0,f.t)("panel.header-menu.copy","Copy"),onClick:m})),Ct&&E.push({text:(0,f.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:k}),e){const u=e.getScope(),T=u.$$childHead.ctrl,N=T.getExtendedMenu();for(const F of N){const vt={text:F.text,href:F.href,shortcut:F.shortcut};F.click&&(vt.onClick=()=>{u.$eval(F.click,{ctrl:T})}),E.push(vt)}}return t.options.legend&&E.push({text:t.options.legend.showLegend?(0,f.t)("panel.header-menu.hide-legend","Hide legend"):(0,f.t)("panel.header-menu.show-legend","Show legend"),onClick:rt,shortcut:"p l"}),t.isEditing&&(E.length=0,Ct&&E.push({text:(0,f.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:k})),mt&&t.plugin&&!t.plugin.meta.skipDataQuery&&E.push({text:(0,f.t)("panel.header-menu.get-help","Get help"),onClick:u=>h(H.q.Help)}),i.length>0&&!t.isEditing&&I.push({text:"Extensions",iconClassName:"plug",type:"submenu",subMenu:(0,Bt.N9)(i)}),E.length&&I.push({type:"submenu",text:(0,f.t)("panel.header-menu.more","More..."),iconClassName:"cube",subMenu:E,onClick:p}),n.canEditPanel(t)&&!t.isEditing&&!t.isViewing&&(I.push({type:"divider",text:""}),I.push({text:(0,f.t)("panel.header-menu.remove","Remove"),iconClassName:"trash-alt",onClick:D,shortcut:"p r"})),I}function Yt({panel:n,dashboard:t,loadingState:i,children:e}){const[a,o]=(0,y.useState)([]),r=(0,Ht.useSelector)(h=>(0,B.U)(h,n)?.angularComponent),d=(0,y.useMemo)(()=>qt(n,t),[n,t]),{extensions:c}=(0,bt.vl)({extensionPointId:Ut.S.DashboardPanelMenu,context:d,limitPerPlugin:3});return(0,y.useEffect)(()=>{o(Xt(t,n,c,r))},[t,n,r,i,o,c]),e({items:a})}function qt(n,t){return{id:n.id,pluginId:n.type,title:n.title,timeRange:t.time,timeZone:(0,jt.O)({timeZone:t.timezone}),dashboard:{uid:t.uid,title:t.title,tags:Array.from(t.tags)},targets:n.targets,scopedVars:n.scopedVars,data:n.getQueryRunner().getLastResult()}}function ut({style:n,panel:t,dashboard:i,loadingState:e}){return(0,l.jsx)(Yt,{panel:t,dashboard:i,loadingState:e,children:({items:a})=>(0,l.jsx)(Vt,{style:n,items:a})})}class _t extends y.PureComponent{constructor(t){super(t),this.element=null,this.timeSrv=(0,b.jG)(),this.subs=new w.yU,this.state={data:{state:P.Gu.NotStarted,series:[],timeRange:(0,O.E2)()}}}componentDidMount(){const{panel:t}=this.props;this.loadAngularPanel();const i=t.getQueryRunner();this.subs.add(i.getData({withTransforms:!1,withFieldConfig:!1}).subscribe({next:e=>this.onPanelDataUpdate(e)}))}onPanelDataUpdate(t){let i;if(t.state===P.Gu.Error){const{error:e}=t;e&&i!==e.message&&(i=e.message)}this.setState({data:t,errorMessage:i})}componentWillUnmount(){this.subs.unsubscribe(),this.props.angularComponent&&this.props.angularComponent?.destroy()}componentDidUpdate(t,i){const{plugin:e,height:a,width:o,panel:r}=this.props;t.plugin!==e&&this.loadAngularPanel(),(t.width!==o||t.height!==a)&&this.scopeProps&&(this.scopeProps.size.height=this.getInnerPanelHeight(),this.scopeProps.size.width=this.getInnerPanelWidth(),r.render())}getInnerPanelHeight(){const{plugin:t,height:i}=this.props,{theme:e}=x.Ay,a=this.hasOverlayHeader()?0:e.panelHeaderHeight,o=t.noPadding?0:e.panelPadding;return i-a-o*2-J.IZ}getInnerPanelWidth(){const{plugin:t,width:i}=this.props,{theme:e}=x.Ay,a=t.noPadding?0:e.panelPadding;return i-a*2-J.IZ}loadAngularPanel(){const{panel:t,dashboard:i,setPanelAngularComponent:e}=this.props;if(!this.element)return;const a=(0,j.E)(),o='<plugin-component type="panel" class="panel-height-helper"></plugin-component>';this.scopeProps={panel:t,dashboard:i,size:{width:this.getInnerPanelWidth(),height:this.getInnerPanelHeight()}},e({key:t.key,angularComponent:a.load(this.element,this.scopeProps,o)})}hasOverlayHeader(){const{panel:t}=this.props,{data:i}=this.state;return i.request&&i.request.timeInfo?!1:!t.hasTitle()}render(){const{dashboard:t,panel:i}=this.props,{errorMessage:e,data:a}=this.state,{transparent:o}=i,r=ct({...this.props,data:a}),d=(i.gridPos?.y??0)===0?-16:void 0,c=(0,l.jsx)("div",{"data-testid":"panel-dropdown",children:(0,l.jsx)(ut,{panel:i,dashboard:t,loadingState:a.state})});return(0,l.jsx)(A.NR,{width:this.props.width,height:this.props.height,title:r.title,loadingState:a.state,statusMessage:e,statusMessageOnClick:r.onOpenErrorInspect,description:r.description,titleItems:r.titleItems,menu:this.props.hideMenu?void 0:c,dragClass:r.dragClass,dragClassCancel:"grid-drag-cancel",padding:r.padding,hoverHeaderOffset:d,hoverHeader:r.hasOverlayHeader(),displayMode:o?"transparent":"default",onCancelQuery:r.onCancelQuery,children:()=>(0,l.jsx)("div",{ref:h=>this.element=h,className:"panel-height-helper"})})}}const te=(n,t)=>({angularComponent:(0,B.U)(n,t.panel)?.angularComponent}),ee={setPanelAngularComponent:Q.S3},ne=(0,z.connect)(te,ee)(_t);var se=s(2543),ae=s(94624),G=s(41987),$=s(69129),pt=s(47232),ie=s(22391),oe=s(14236),re=s(3591),le=s(79041),de=s(66602),ce=s(28138),he=s(18898),ue=s(31193),pe=s(26260),ge=s(90478),gt=s(1173),fe=s(24293);const me=(n,t,i)=>{const{overrides:e}=i,a=i.overrides.findIndex(h=>h.matcher.id===gt.Ct.byName&&h.matcher.options===n);if(a<0)return{...i,overrides:[...i.overrides,Ce(n,t)]};const o=Array.from(e),r=o[a],d=r.properties.findIndex(h=>h.id==="color");if(d<0)return o[a]={...r,properties:[...r.properties,st(t)]},{...i,overrides:o};const c=Array.from(r.properties);return c[d]=st(t),o[a]={...r,properties:c},{...i,overrides:o}},Ce=(n,t)=>({matcher:{id:gt.Ct.byName,options:n},properties:[st(t)]}),st=n=>({id:"color",value:{mode:fe.Y.Fixed,fixedColor:n}});var ve=s(28444),at=s(10154),it=s(42972),Ee=s(60444),ft=s(32631),S=(n=>(n.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT="field config overrides changed",n.NEW_PANEL_OPTION_EVENT="new panel option",n.PANEL_OPTION_CHANGED_EVENT="panel option changed",n.NEW_DEFAULT_FIELD_CONFIG_EVENT="new default field config",n.DEFAULT_FIELD_CONFIG_CHANGED_EVENT="default field config changed",n.NEW_CUSTOM_FIELD_CONFIG_EVENT="new custom field config",n.CUSTOM_FIELD_CONFIG_CHANGED_EVENT="custom field config changed",n.MEASURE_PANEL_LOAD_TIME_EVENT="measure panel load time",n.THRESHOLDS_COUNT_CHANGED_EVENT="thresholds count changed",n.THRESHOLDS_MODE_CHANGED_EVENT="thresholds mode changed",n.MAPPINGS_COUNT_CHANGED_EVENT="mappings count changed",n.LINKS_COUNT_CHANGED_EVENT="links count changed",n.PANEL_ERROR="panel error",n))(S||{});const Pe="overrides",ye="custom",Ie=n=>{const t=performance.now();return(0,y.useEffect)(()=>{x.config.grafanaJavascriptAgent.enabled&&requestAnimationFrame(()=>{setTimeout(()=>{ft.P.api.pushMeasurement({type:S.MEASURE_PANEL_LOAD_TIME_EVENT,values:{start_loading_time_ms:t,load_time_ms:performance.now()-t}},{context:{panel_type:n.panelType,panel_id:String(n.panelId),panel_title:n.panelTitle}})},0)})},[]),null};var De=s(91126),ot=s(61582);class xe{constructor(t,i,e){this.logChanges=(a,o)=>{this.logPanelOptionChanges(a,this.initialPanelOptions),this.logFieldConfigChanges(o,this.initialFieldConfig),this.initialPanelOptions=a,this.initialFieldConfig=o},this.logPanelEvent=(a,o,r,d)=>{const c={key:o,newValue:r,oldValue:d??"",panelTitle:this.panelLogInfo.panelTitle,panelId:this.panelLogInfo.panelId,panelType:this.panelLogInfo.panelType};ft.P.api.pushEvent(a,c)},this.logPanelOptionChanges=(a,o)=>{if(typeof a!="object"||a===null||typeof o!="object"||o===null)return;const r={...o};for(const[d,c]of Object.entries(a)){const h=typeof c!="string"?JSON.stringify(c):c,p=typeof c!="string"?JSON.stringify(r[d]):String(r[d]);r[d]===void 0?this.logPanelEvent(S.NEW_PANEL_OPTION_EVENT,d,h):p!==h&&this.logPanelEvent(S.PANEL_OPTION_CHANGED_EVENT,d,h,p)}},this.logFieldConfigChanges=(a,o)=>{const r=JSON.stringify(o.overrides),d=JSON.stringify(a.overrides);r!==d&&this.logPanelEvent(S.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT,Pe,d,r);const c={...o.defaults};for(const[p,g]of Object.entries(a.defaults)){if(p===ye)continue;const m=typeof g!="string"?JSON.stringify(g):g,D=typeof g!="string"?JSON.stringify(c[p]):String(c[p]);c[p]===void 0?this.logPanelEvent(S.NEW_DEFAULT_FIELD_CONFIG_EVENT,p,m):D!==m&&this.logPanelEvent(S.DEFAULT_FIELD_CONFIG_CHANGED_EVENT,p,m,D)}if(!a.defaults.custom||c.custom===void 0)return;const h={...c.custom};for(const[p,g]of Object.entries(a.defaults.custom)){if(c.custom===null||h[p]===null)continue;const m=typeof g!="string"?JSON.stringify(g):g,D=typeof g!="string"?JSON.stringify(h[p]):String(h[p]);h[p]===void 0?this.logPanelEvent(S.NEW_CUSTOM_FIELD_CONFIG_EVENT,p,m):D!==m&&this.logPanelEvent(S.CUSTOM_FIELD_CONFIG_CHANGED_EVENT,p,m,D)}},this.initialPanelOptions=t,this.initialFieldConfig=i,this.panelLogInfo=e}}const Se="Error in plugin";class Te extends y.PureComponent{constructor(t){super(t),this.timeSrv=(0,b.jG)(),this.subs=new w.yU,this.eventFilter={onlyLocal:!0},this.panelOptionsLogger=void 0,this.getSync=()=>this.props.isEditing?ae.y.Off:this.props.dashboard.graphTooltip,this.onInstanceStateChange=e=>{this.props.onInstanceStateChange(e),this.setState({context:{...this.state.context,instanceState:e}})},this.onUpdateData=e=>(0,ge.H)(this.props.panel,e),this.onSeriesColorChange=(e,a)=>{this.onFieldConfigChange(me(e,a,this.props.panel.fieldConfig))},this.onSeriesVisibilityChange=(e,a)=>{this.onFieldConfigChange((0,De.M)(e,a,this.props.panel.fieldConfig,this.state.data.series))},this.onToggleLegendSort=e=>{const a=this.props.panel.options.legend;if(!a)return;let o=a.sortDesc,r=a.sortBy;e!==r&&(o=void 0),o===!1?(r=void 0,o=void 0):(o=!o,r=e),this.onOptionsChange({...this.props.panel.options,legend:{...a,sortBy:r,sortDesc:o}})},this.onRefresh=()=>{const{dashboard:e,panel:a,isInView:o,width:r}=this.props;if(!e.snapshot&&!o){a.refreshWhenInView=!0;return}const d=(0,M.nk)(a,this.timeSrv.timeRange());if(this.wantsQueryExecution){if(r<0)return;a.refreshWhenInView=!1,a.runAllPanelQueries({dashboardUID:e.uid,dashboardTimezone:e.getTimezone(),timeData:d,width:r})}else this.setState({data:{...this.state.data,timeRange:this.timeSrv.timeRange()},renderCounter:this.state.renderCounter+1,liveTime:void 0})},this.onRender=()=>{const e={renderCounter:this.state.renderCounter+1};this.setState(e)},this.onOptionsChange=e=>{this.props.panel.updateOptions(e)},this.onFieldConfigChange=e=>{this.props.panel.updateFieldConfig(e)},this.onPanelError=e=>{x.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===G.Jk.PanelEditor&&this.logPanelChangesOnError();const a=e.message||Se;this.state.errorMessage!==a&&this.setState({errorMessage:a})},this.onPanelErrorRecover=()=>{this.setState({errorMessage:void 0})},this.onAnnotationCreate=async e=>{const a=e.from!==e.to,o={dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:e.from,timeEnd:a?e.to:0,tags:e.tags,text:e.description};await(0,at.vJ)(o),(0,it.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new $.We(o))},this.onAnnotationDelete=async e=>{await(0,at.Xm)({id:e}),(0,it.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new $.We({id:e}))},this.onAnnotationUpdate=async e=>{const a=e.from!==e.to,o={id:e.id,dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:e.from,timeEnd:a?e.to:0,tags:e.tags,text:e.description};await(0,at.rJ)(o),(0,it.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new $.We(o))},this.onChangeTimeRange=e=>{this.timeSrv.setTime({from:(0,pt.yT)(e.from),to:(0,pt.yT)(e.to)})},this.onAddAdHocFilter=e=>{const{key:a,value:o,operator:r}=e,d=(0,ue.tR)().getInstanceSettings(this.props.panel.datasource),c=d&&(0,ie.p$)(d);c&&(0,nt.JD)((0,pe.z_)({datasource:c,key:a,operator:r,value:o}))};const i=t.dashboard.events.newScopedBus(`panel:${t.panel.id}`,this.eventFilter);if(this.debouncedSetPanelAttention=(0,se.debounce)(this.setPanelAttention.bind(this),100),this.state={isFirstLoad:!0,renderCounter:0,context:{eventsScope:"__global_",eventBus:i,app:this.getPanelContextApp(),sync:this.getSync,onSeriesColorChange:this.onSeriesColorChange,onToggleSeriesVisibility:this.onSeriesVisibilityChange,onAnnotationCreate:this.onAnnotationCreate,onAnnotationUpdate:this.onAnnotationUpdate,onAnnotationDelete:this.onAnnotationDelete,onInstanceStateChange:this.onInstanceStateChange,onToggleLegendSort:this.onToggleLegendSort,canAddAnnotations:t.dashboard.canAddAnnotations.bind(t.dashboard),canEditAnnotations:t.dashboard.canEditAnnotations.bind(t.dashboard),canDeleteAnnotations:t.dashboard.canDeleteAnnotations.bind(t.dashboard),onAddAdHocFilter:this.onAddAdHocFilter,onUpdateData:this.onUpdateData},data:this.getInitialPanelDataState()},x.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===G.Jk.PanelEditor){const e={panelId:String(t.panel.id),panelType:t.panel.type,panelTitle:t.panel.title};this.panelOptionsLogger=new xe(t.panel.getOptions(),t.panel.fieldConfig,e)}}getPanelContextApp(){return this.props.isEditing?G.Jk.PanelEditor:this.props.isViewing?G.Jk.PanelViewer:G.Jk.Dashboard}getInitialPanelDataState(){return{state:P.Gu.NotStarted,series:[],timeRange:(0,O.E2)()}}componentDidMount(){const{panel:t,dashboard:i}=this.props;if(this.subs.add(t.events.subscribe(re._,this.onRefresh)),this.subs.add(t.events.subscribe(ve.XM,this.onRender)),i.panelInitialized(this.props.panel),this.hasPanelSnapshot){this.setState({data:(0,Ee.d)(t,i),isFirstLoad:!1});return}this.wantsQueryExecution||this.setState({isFirstLoad:!1}),this.subs.add(t.getQueryRunner().getData({withTransforms:!0,withFieldConfig:!0}).subscribe({next:e=>this.onDataUpdate(e)})),ot.a.listen(this)}componentWillUnmount(){this.subs.unsubscribe(),ot.a.remove(this)}liveTimeChanged(t){const{data:i}=this.state;if(i.timeRange){const e=t.to.valueOf()-i.timeRange.to.valueOf();if(e<100){console.log("Skip tick render",this.props.panel.title,e);return}}this.setState({liveTime:t})}componentDidUpdate(t){const{isInView:i,width:e,panel:a}=this.props,{context:o}=this.state,r=this.getPanelContextApp();o.app!==r&&this.setState({context:{...o,app:r}}),i!==t.isInView&&i&&a.refreshWhenInView&&this.onRefresh(),e!==t.width&&ot.a.updateInterval(this)}onDataUpdate(t){const{dashboard:i,panel:e,plugin:a}=this.props;if(a.meta.skipDataQuery){this.setState({data:this.getInitialPanelDataState()});return}let{isFirstLoad:o}=this.state,r;switch(t.state){case P.Gu.Loading:if(this.state.data.state===P.Gu.Loading)return;break;case P.Gu.Error:const{error:d,errors:c}=t;c?.length?c.length===1?r=c[0].message:r="Multiple errors found. Click for more details":d&&r!==d.message&&(r=d.message);break;case P.Gu.Done:i.snapshot&&(e.snapshotData=t.series.map(h=>(0,oe.Kl)(h))),o&&(o=!1);break}this.setState({isFirstLoad:o,errorMessage:r,data:t,liveTime:void 0})}logPanelChangesOnError(){this.panelOptionsLogger.logChanges(this.props.panel.getOptions(),this.props.panel.fieldConfig)}get hasPanelSnapshot(){const{panel:t}=this.props;return t.snapshotData&&t.snapshotData.length}get wantsQueryExecution(){return!(this.props.plugin.meta.skipDataQuery||this.hasPanelSnapshot)}shouldSignalRenderingCompleted(t,i){return t===P.Gu.Done||t===P.Gu.Streaming||t===P.Gu.Error||i.skipDataQuery}skipFirstRender(t){const{isFirstLoad:i}=this.state;return this.wantsQueryExecution&&i&&(t===P.Gu.Loading||t===P.Gu.NotStarted)}renderPanelContent(t,i){const{panel:e,plugin:a,dashboard:o}=this.props,{renderCounter:r,data:d}=this.state,{state:c}=d;if(this.skipFirstRender(c))return null;this.shouldSignalRenderingCompleted(c,a.meta)&&he.E.renderingCompleted();const h=a.panel,p=this.state.liveTime??d.timeRange??this.timeSrv.timeRange(),g=e.getOptions();return this.eventFilter.onlyLocal=o.graphTooltip===0,(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)(le.XF,{value:this.state.context,children:[(0,l.jsx)(h,{id:e.id,data:d,title:e.title,timeRange:p,timeZone:this.props.dashboard.getTimezone(),options:g,fieldConfig:e.fieldConfig,transparent:e.transparent,width:t,height:i,renderCounter:r,replaceVariables:e.replaceVariables,onOptionsChange:this.onOptionsChange,onFieldConfigChange:this.onFieldConfigChange,onChangeTimeRange:this.onChangeTimeRange,eventBus:o.events}),x.Ay.featureToggles.panelMonitoring&&this.state.errorMessage===void 0&&(0,l.jsx)(Ie,{panelType:a.meta.id,panelId:e.id,panelTitle:e.title})]})})}setPanelAttention(){ce.A.publish(new $.Tp({panelId:this.props.panel.id}))}debouncedSetPanelAttention(){}render(){const{dashboard:t,panel:i,width:e,height:a,plugin:o}=this.props,{errorMessage:r,data:d}=this.state,{transparent:c}=i,h=ct({...this.props,data:d}),p=(i.gridPos?.y??0)===0?-16:void 0,g=(0,l.jsx)("div",{"data-testid":"panel-dropdown",children:(0,l.jsx)(ut,{panel:i,dashboard:t,loadingState:d.state})});return(0,l.jsx)(A.NR,{width:e,height:a,title:h.title,loadingState:d.state,statusMessage:r,statusMessageOnClick:h.onOpenErrorInspect,description:h.description,titleItems:h.titleItems,menu:this.props.hideMenu?void 0:g,dragClass:h.dragClass,dragClassCancel:"grid-drag-cancel",padding:h.padding,hoverHeaderOffset:p,hoverHeader:h.hasOverlayHeader(),displayMode:c?"transparent":"default",onCancelQuery:h.onCancelQuery,onFocus:()=>this.setPanelAttention(),onMouseEnter:()=>this.setPanelAttention(),onMouseMove:()=>this.debouncedSetPanelAttention(),children:(m,D)=>(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(de.tH,{dependencies:[d,o,i.getOptions()],onError:this.onPanelError,onRecover:this.onPanelErrorRecover,children:({error:W})=>W?null:this.renderPanelContent(m,D)})})})}}const Ne=(n,t)=>{const i=n.panels[t.stateKey];return i?{plugin:i.plugin,instanceState:i.instanceState}:{plugin:void 0}},Oe={initPanelState:X.Ap,setPanelInstanceState:Q.nF},Ae=(0,z.connect)(Ne,Oe);class Me extends y.PureComponent{constructor(){super(...arguments),this.onInstanceStateChange=t=>{this.props.setPanelInstanceState({key:this.props.stateKey,value:t})},this.onVisibilityChange=t=>{this.props.panel.isInView=t},this.onPanelLoad=()=>{this.props.plugin||this.props.initPanelState(this.props.panel)},this.renderPanel=({isInView:t})=>{const{dashboard:i,panel:e,isViewing:a,isEditing:o,width:r,height:d,plugin:c,timezone:h,hideMenu:p,isDraggable:g=!0}=this.props;return c?c&&c.angularPanelCtrl?(0,l.jsx)(ne,{plugin:c,panel:e,dashboard:i,isViewing:a,isEditing:o,isInView:t,isDraggable:g,width:r,height:d}):(0,l.jsx)(Te,{plugin:c,panel:e,dashboard:i,isViewing:a,isEditing:o,isInView:t,isDraggable:g,width:r,height:d,onInstanceStateChange:this.onInstanceStateChange,timezone:h,hideMenu:p}):null}}static{this.defaultProps={lazy:!0}}componentDidMount(){this.props.panel.isInView=!this.props.lazy,this.props.lazy||this.onPanelLoad()}render(){const{width:t,height:i,lazy:e}=this.props;return e?(0,l.jsx)(v,{width:t,height:i,onChange:this.onVisibilityChange,onLoad:this.onPanelLoad,children:this.renderPanel}):this.renderPanel({isInView:!0})}}const Re=Ae(Me)},60444:(Et,Z,s)=>{s.d(Z,{d:()=>P});var l=s(14236),y=s(43127),z=s(33948),X=s(39070),Q=s(90708),Y=s(2913),v=s(85595),q=s(74856),w=s(19752);function P(O,j){const A=(0,l.Bt)(O.snapshotData),x=new v.F,J={dashboard:j,range:(0,y.E2)()},B=x.canWork(J)?x.getAnnotationsInSnapshot(j,O.id):[],b=[(0,z.I)(B)];return{timeRange:(0,w.nk)(O,(0,q.jG)().timeRange()).timeRange,state:X.Gu.Done,series:(0,Q.we)({data:A,fieldConfig:{defaults:{},overrides:[]},replaceVariables:O.replaceVariables,fieldConfigRegistry:O.plugin.fieldConfigRegistry,theme:Y.config.theme2,timeZone:j.getTimezone()}),structureRev:1,annotations:b}}}}]);

//# sourceMappingURL=9569.557655dd1a42f4408350.js.map