(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2651],{91062:(ge,Y,p)=>{"use strict";p.d(Y,{A:()=>ue});var P=p(96540),w=p(47433),x=Object.defineProperty,o=Object.defineProperties,S=Object.getOwnPropertyDescriptors,k=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,V=(M,F,L)=>F in M?x(M,F,{enumerable:!0,configurable:!0,writable:!0,value:L}):M[F]=L,J=(M,F)=>{for(var L in F||(F={}))W.call(F,L)&&V(M,L,F[L]);if(k)for(var L of k(F))G.call(F,L)&&V(M,L,F[L]);return M},Q=(M,F)=>o(M,S(F)),oe=(M,F)=>{var L={};for(var D in M)W.call(M,D)&&F.indexOf(D)<0&&(L[D]=M[D]);if(M!=null&&k)for(var D of k(M))F.indexOf(D)<0&&G.call(M,D)&&(L[D]=M[D]);return L};const ue=M=>{var F=M,{children:L}=F,D=oe(F,["children"]);return P.createElement(w.x,Q(J({},D),{kind:"section"}),L)}},47433:(ge,Y,p)=>{"use strict";p.d(Y,{x:()=>M});var P=p(96540),w=p(32196),x=p(40845),o=p(29158),S=Object.defineProperty,k=Object.defineProperties,W=Object.getOwnPropertyDescriptors,G=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,Q=(F,L,D)=>L in F?S(F,L,{enumerable:!0,configurable:!0,writable:!0,value:D}):F[L]=D,oe=(F,L)=>{for(var D in L||(L={}))V.call(L,D)&&Q(F,D,L[D]);if(G)for(var D of G(L))J.call(L,D)&&Q(F,D,L[D]);return F},ue=(F,L)=>k(F,W(L));const M=({children:F,title:L,description:D,isCollapsible:ve=!1,isInitiallyOpen:ee=!0,kind:K="section",className:X})=>{const{colors:_,typography:ae,spacing:Ne}=(0,x.$j)(),[Ae,ke]=(0,P.useState)(ve?ee:!0),tt=Ae?"angle-up":"angle-down",rt=K==="sub-section",xt=`${Ae?"Collapse":"Expand"} section ${L}`,Oe={header:(0,w.css)({display:"flex",justifyContent:"space-between",alignItems:"center"}),title:(0,w.css)({margin:0}),subtitle:(0,w.css)({margin:0,fontWeight:ae.fontWeightRegular}),descriptionText:(0,w.css)(ue(oe({marginTop:Ne(rt?.25:.5),marginBottom:0},ae.bodySmall),{color:_.text.secondary})),content:(0,w.css)({marginTop:Ne(2)})};return P.createElement("div",{className:X},P.createElement("div",{className:Oe.header},K==="section"?P.createElement("h3",{className:Oe.title},L):P.createElement("h6",{className:Oe.subtitle},L),ve&&P.createElement(o.K,{name:tt,onClick:()=>ke(!Ae),type:"button",size:"xl","aria-label":xt})),D&&P.createElement("p",{className:Oe.descriptionText},D),Ae&&P.createElement("div",{className:Oe.content},F))}},6191:(ge,Y,p)=>{"use strict";p.d(Y,{X:()=>o});var P=p(32196),w=p(96540),x=p(40845);const o=({children:k})=>{const W=(0,x.of)(S);return w.createElement("div",{className:W.root},k)},S=k=>({root:(0,P.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:k.spacing(3),minHeight:k.spacing(4)})})},31347:(ge,Y,p)=>{"use strict";p.d(Y,{Z:()=>w});var P=p(96540);const w=({grow:x,shrink:o})=>P.createElement("div",{style:{display:"block",flexGrow:x,flexShrink:o}})},22354:(ge,Y,p)=>{"use strict";p.d(Y,{W:()=>L});var P=p(32196),w=p(96540),x=p(40845),o=p(90182),S=p(4603),k=Object.defineProperty,W=Object.defineProperties,G=Object.getOwnPropertyDescriptors,V=Object.getOwnPropertySymbols,J=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable,oe=(K,X,_)=>X in K?k(K,X,{enumerable:!0,configurable:!0,writable:!0,value:_}):K[X]=_,ue=(K,X)=>{for(var _ in X||(X={}))J.call(X,_)&&oe(K,_,X[_]);if(V)for(var _ of V(X))Q.call(X,_)&&oe(K,_,X[_]);return K},M=(K,X)=>W(K,G(X)),F=(K,X)=>{var _={};for(var ae in K)J.call(K,ae)&&X.indexOf(ae)<0&&(_[ae]=K[ae]);if(K!=null&&V)for(var ae of V(K))X.indexOf(ae)<0&&Q.call(K,ae)&&(_[ae]=K[ae]);return _};function L(K){var X=K,{label:_}=X,ae=F(X,["label"]);const Ne=(0,x.of)(ee),[Ae]=(0,w.useState)(()=>Math.random().toString(16).slice(2)),ke={SelectContainer:D,ValueContainer:ve,SingleValue:ve};return w.createElement("div",{className:Ne.root},_&&w.createElement("label",{className:Ne.label,htmlFor:Ae},_,":","\xA0"),w.createElement(o.l6,M(ue({openMenuOnFocus:!0,inputId:Ae},ae),{components:ke})))}const D=K=>{const{children:X}=K,_=(0,x.of)(ee);return w.createElement(S.K,M(ue({},K),{className:(0,P.cx)(K.className,_.container)}),X)},ve=K=>{const{className:X,children:_}=K,ae=(0,x.of)(ee);return w.createElement("div",{className:(0,P.cx)(X,ae.valueContainer)},_)},ee=K=>({root:(0,P.css)({display:"flex",fontSize:12,alignItems:"center"}),label:(0,P.css)({color:K.colors.text.secondary,whiteSpace:"nowrap"}),container:(0,P.css)({background:"none",borderColor:"transparent"}),valueContainer:(0,P.css)({display:"flex",alignItems:"center",flex:"initial",color:K.colors.text.secondary,fontSize:12})})},85232:(ge,Y,p)=>{"use strict";p.r(Y),p.d(Y,{AND:()=>M,ASC:()=>G,BY:()=>k,COMPARISON_OPERATORS:()=>ve,DESC:()=>W,EQUALS:()=>L,FROM:()=>w,GROUP:()=>o,KEYWORDS:()=>oe,LIMIT:()=>V,LOGICAL_OPERATORS:()=>F,NOT_EQUALS:()=>D,ORDER:()=>S,SCHEMA:()=>Q,SELECT:()=>P,STATISTICS:()=>ue,WHERE:()=>x,WITH:()=>J,conf:()=>K,language:()=>ee});const P="SELECT",w="FROM",x="WHERE",o="GROUP",S="ORDER",k="BY",W="DESC",G="ASC",V="LIMIT",J="WITH",Q="SCHEMA",oe=[P,w,x,o,S,k,W,G,V,J,Q],ue=["AVG","COUNT","MAX","MIN","SUM"],M="AND",F=[M],L="=",D="!=",ve=[L,D],ee={defaultToken:"",tokenPostfix:".sql",ignoreCase:!0,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"}],keywords:oe,operators:F,builtinFunctions:ue,tokenizer:{root:[[/\$[a-zA-Z0-9-_]+/,"variable"],{include:"@comments"},{include:"@whitespace"},{include:"@numbers"},{include:"@strings"},{include:"@complexIdentifiers"},[/[;,.]/,"delimiter"],[/[()]/,"@brackets"],[/[\w@#$]+/,{cases:{"@keywords":"keyword","@operators":"operator","@builtinFunctions":"predefined","@default":"identifier"}}],[/[=!%&+\-*/|~^]/,"operator"]],whitespace:[[/\s+/,"white"]],comments:[[/--+.*/,"comment"]],comment:[[/[^*/]+/,"comment"],[/./,"comment"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/N'/,{token:"string",next:"@string"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/[^']+/,"string"],[/''/,"string"],[/'/,{token:"string",next:"@pop"}]],string_double:[[/[^\\"]+/,"type"],[/"/,"type","@pop"]],complexIdentifiers:[[/\[/,{token:"identifier.quote",next:"@bracketedIdentifier"}],[/"/,{token:"identifier.quote",next:"@quotedIdentifier"}]],bracketedIdentifier:[[/[^\]]+/,"identifier"],[/]]/,"identifier"],[/]/,{token:"identifier.quote",next:"@pop"}]],quotedIdentifier:[[/[^"]+/,"identifier"],[/""/,"identifier"],[/"/,{token:"identifier.quote",next:"@pop"}]]}},K={comments:{lineComment:"--",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]}},64698:(ge,Y,p)=>{"use strict";p.r(Y),p.d(Y,{DYNAMIC_LABEL_PATTERNS:()=>w,conf:()=>o,language:()=>x});var P=p(32264);const w=["${DATAPOINT_COUNT}","${FIRST}","${FIRST_LAST_RANGE}","${FIRST_LAST_TIME_RANGE}","${FIRST_TIME}","${FIRST_TIME_RELATIVE}","${LABEL}","${LAST}","${LAST_TIME}","${LAST_TIME_RELATIVE}","${MAX}","${MAX_TIME}","${MAX_TIME_RELATIVE}","${MIN}","${MIN_MAX_RANGE}","${MIN_MAX_TIME_RANGE}","${MIN_TIME}","${MIN_TIME_RELATIVE}","${PROP('AccountId')}","${PROP('MetricName')}","${PROP('Namespace')}","${PROP('Period')}","${PROP('Region')}","${PROP('Stat')}","${SUM}",...P.$.featureToggles.cloudWatchCrossAccountQuerying?["${PROP('AccountLabel')}"]:[]],x={id:"dynamicLabels",ignoreCase:!1,tokenizer:{root:[{include:"@whitespace"},{include:"@builtInFunctions"},{include:"@string"},[/\$\{PROP\('Dim.[a-zA-Z0-9-_]?.*'\)\}+/,"predefined"]],builtInFunctions:[[w.map(S).join("|"),"predefined"]],whitespace:[[/\s+/,"white"]],string:[]}},o={};function S(k){return k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},89089:(ge,Y,p)=>{"use strict";p.r(Y),p.d(Y,{DEDUP:()=>V,DISPLAY:()=>P,FIELDS:()=>w,FILTER:()=>x,LIMIT:()=>W,LOGS_COMMANDS:()=>J,LOGS_FUNCTION_OPERATORS:()=>oe,LOGS_KEYWORDS:()=>M,LOGS_LOGIC_OPERATORS:()=>Q,PARSE:()=>G,PATTERN:()=>o,SORT:()=>k,SORT_DIRECTION_KEYWORDS:()=>ue,STATS:()=>S,conf:()=>L,language:()=>F});const P="display",w="fields",x="filter",o="pattern",S="stats",k="sort",W="limit",G="parse",V="dedup",J=[P,w,x,o,S,k,W,G,V],Q=["and","or","not"],oe=["abs","ceil","floor","greatest","least","log","sqrt","bin","datefloor","dateceil","fromMillis","toMillis","ispresent","coalesce","isValidIp","isValidIpV4","isValidIpV6","isIpInSubnet","isIpv4InSubnet","isIpv6InSubnet","avg","count","count_distinct","max","min","pct","stddev","sum","earliest","latest","sortsFirst","sortsLast","isempty","isblank","concat","ltrim","rtrim","trim","strlen","toupper","tolower","substr","replace","strcontains","unmask"],ue=["asc","desc"],M=["like","by","in","as",...ue],F={defaultToken:"invalid",id:"logs",ignoreCase:!0,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"}],commands:[...J,...M],operators:Q,builtinFunctions:oe,tokenizer:{root:[{include:"@comments"},{include:"@regexes"},{include:"@whitespace"},{include:"@fieldNames"},{include:"@variables"},{include:"@strings"},{include:"@numbers"},[/\|\|/,"operator"],[/[,.:\|]/,"delimiter"],[/[()\[\]]/,"delimiter.parenthesis"],[/[\w@#$]+/,{cases:{"@commands":"keyword","@builtinFunctions":"predefined","@operators":"operator","@default":"identifier"}}],[/[+\-*/^%=!<>]/,"operator"]],variables:[[/\${/,{token:"variable",next:"@variable_bracket"}],[/\$[a-zA-Z0-9-_]+/,"variable"]],variable_bracket:[[/[a-zA-Z0-9-_:]+/,"variable"],[/}/,{token:"variable",next:"@pop"}]],fieldNames:[[/(@[_a-zA-Z]+[_.0-9a-zA-Z]*)|(`((\\`)|([^`]))*?`)/,"identifier"]],whitespace:[[/\s+/,"white"]],comments:[[/^#.*/,"comment"],[/\s+#.*/,"comment"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/'/,{token:"string",next:"@string"}],[/"/,{token:"string",next:"@string_double"}],[/`/,{token:"identifier",next:"@string_backtick"}]],string:[[/[^']+/,"string"],[/''/,"string"],[/'/,{token:"string",next:"@pop"}]],string_double:[[/[^\\"]+/,"string"],[/"/,"string","@pop"]],string_backtick:[[/[^\\`]+/,"identifier"],[/`/,"identifier","@pop"]],regexes:[[/\/.*?\/(?=\s*\||\s*$|,)/,"regexp"]]}},L={comments:{lineComment:"#"},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"},{open:"`",close:"`"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"},{open:"`",close:"`"}]}},74746:(ge,Y,p)=>{"use strict";p.r(Y),p.d(Y,{METRIC_MATH_FNS:()=>P,METRIC_MATH_KEYWORDS:()=>x,METRIC_MATH_OPERATORS:()=>o,METRIC_MATH_PERIODS:()=>S,METRIC_MATH_STATISTIC_KEYWORD_STRINGS:()=>w,conf:()=>W,language:()=>k});const P=["ABS","ANOMALY_DETECTION_BAND","AVG","CEIL","DATAPOINT_COUNT","DB_PERF_INSIGHTS","DIFF","DIFF_TIME","FILL","FIRST","LAST","FLOOR","IF","INSIGHT_RULE_METRIC","LOG","LOG10","MAX","METRIC_COUNT","METRICS","MIN","MINUTE","HOUR","DAY","DATE","MONTH","YEAR","EPOCH","PERIOD","RATE","REMOVE_EMPTY","RUNNING_SUM","SEARCH","SERVICE_QUOTA","SLICE","SORT","STDDEV","SUM","TIME_SERIES"],w=["Average","Maximum","Minimum","Sum","SampleCount"],x=["REPEAT","LINEAR","ASC","DSC"],o=["+","-","*","/","^","==","!=","<=",">=","<",">","AND","&&","OR","||"],S=[10,60,300,900,3e3,21600,86400],k={id:"metricMath",ignoreCase:!1,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"},{open:"{",close:"}",token:"delimiter.curly"}],tokenizer:{root:[{include:"@nonNestableStates"},{include:"@strings"}],nonNestableStates:[{include:"@variables"},{include:"@macros"},{include:"@whitespace"},{include:"@numbers"},{include:"@assignment"},{include:"@keywords"},{include:"@operators"},{include:"@builtInFunctions"},[/[;,.]/,"delimiter"],[/[(){}\[\]]/,"@brackets"]],keywords:[[x.map(G).join("|"),"keyword"]],operators:[[o.map(G).join("|"),"operator"]],builtInFunctions:[[P.map(G).join("|"),"predefined"]],variables:[[/\$[a-zA-Z0-9-_]+/,"variable"]],macros:[[/\$__[a-zA-Z0-9-_]+/,"type"]],whitespace:[[/\s+/,"white"]],assignment:[[/=/,"tag"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/{/,{token:"delimiter.curly",next:"@nestedCurly"}],[/\(/,{token:"delimiter.parenthesis",next:"@nestedParens"}],[/"/,{token:"type",next:"@string_double"}],[/'/,{token:"string",next:"@pop"}],{include:"@nonNestableStates"},[/[^']/,"string"]],string_double:[[/[^"]/,"type"],[/"/,{token:"type",next:"@pop"}]],nestedCurly:[[/}/,{token:"delimiter.curly",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],nestedParens:[[/\)/,{token:"delimiter.parenthesis",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]]}},W={brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]};function G(V){return V.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},92651:(ge,Y,p)=>{"use strict";p.r(Y),p.d(Y,{plugin:()=>Eo});var P=p(40187),w=p(69129),x=p(3591),o=p(74848),S=p(32196),k=function(){function t(e,r){for(var n=0;n<r.length;n++){var s=r[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),W=G(["",""],["",""]);function G(t,e){return Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(e)}}))}function V(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var J=function(){function t(){for(var e=this,r=arguments.length,n=Array(r),s=0;s<r;s++)n[s]=arguments[s];return V(this,t),this.tag=function(i){for(var a=arguments.length,l=Array(a>1?a-1:0),c=1;c<a;c++)l[c-1]=arguments[c];return typeof i=="function"?e.interimTag.bind(e,i):typeof i=="string"?e.transformEndResult(i):(i=i.map(e.transformString.bind(e)),e.transformEndResult(i.reduce(e.processSubstitutions.bind(e,l))))},n.length>0&&Array.isArray(n[0])&&(n=n[0]),this.transformers=n.map(function(i){return typeof i=="function"?i():i}),this.tag}return k(t,[{key:"interimTag",value:function(r,n){for(var s=arguments.length,i=Array(s>2?s-2:0),a=2;a<s;a++)i[a-2]=arguments[a];return this.tag(W,r.apply(void 0,[n].concat(i)))}},{key:"processSubstitutions",value:function(r,n,s){var i=this.transformSubstitution(r.shift(),n);return"".concat(n,i,s)}},{key:"transformString",value:function(r){var n=function(i,a){return a.onString?a.onString(i):i};return this.transformers.reduce(n,r)}},{key:"transformSubstitution",value:function(r,n){var s=function(a,l){return l.onSubstitution?l.onSubstitution(a,n):a};return this.transformers.reduce(s,r)}},{key:"transformEndResult",value:function(r){var n=function(i,a){return a.onEndResult?a.onEndResult(i):i};return this.transformers.reduce(n,r)}}]),t}();const Q=J;var oe={separator:"",conjunction:"",serial:!1},ue=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:oe;return{onSubstitution:function(n,s){if(Array.isArray(n)){var i=n.length,a=e.separator,l=e.conjunction,c=e.serial,d=s.match(/(\n?[^\S\n]+)$/);if(d?n=n.join(a+d[1]):n=n.join(a+" "),l&&i>1){var u=n.lastIndexOf(a);n=n.slice(0,u)+(c?a:"")+" "+l+n.slice(u+1)}}return n}}};const M=ue;function F(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}else return Array.from(t)}var L=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"initial";return{onEndResult:function(n){if(e==="initial"){var s=n.match(/^[^\S\n]*(?=\S)/gm),i=s&&Math.min.apply(Math,F(s.map(function(l){return l.length})));if(i){var a=new RegExp("^.{"+i+"}","gm");return n.replace(a,"")}return n}if(e==="all")return n.replace(/^[^\S\n]+/gm,"");throw new Error("Unknown type: "+e)}}};const D=L;var ve=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"";return{onEndResult:function(n){if(e==="")return n.trim();if(e=e.toLowerCase(),e==="start"||e==="left")return n.replace(/^\s*/,"");if(e==="end"||e==="right")return n.replace(/\s*$/,"");throw new Error("Side not supported: "+e)}}};const ee=ve;var K=new Q(M({separator:","}),D,ee);const X=null;var _=new Q(M({separator:",",conjunction:"and"}),D,ee);const ae=null;var Ne=new Q(M({separator:",",conjunction:"or"}),D,ee);const Ae=null;var ke=function(e){return{onSubstitution:function(n,s){if(e!=null&&typeof e=="string")typeof n=="string"&&n.includes(e)&&(n=n.split(e));else throw new Error("You need to specify a string character to split by.");return n}}};const tt=ke;var rt=function(e){return e!=null&&!Number.isNaN(e)&&typeof e!="boolean"},xt=function(){return{onSubstitution:function(r){return Array.isArray(r)?r.filter(rt):rt(r)?r:""}}};const Oe=xt;var wo=new Q(tt(`
`),Oe,M,D,ee);const Ro=null;var Qr=function(e,r){return{onSubstitution:function(s,i){if(e==null||r==null)throw new Error("replaceSubstitutionTransformer requires at least 2 arguments.");return s==null?s:s.toString().replace(e,r)}}};const De=Qr;var Oo=new Q(tt(`
`),M,D,ee,De(/&/g,"&amp;"),De(/</g,"&lt;"),De(/>/g,"&gt;"),De(/"/g,"&quot;"),De(/'/g,"&#x27;"),De(/`/g,"&#x60;"));const Lo=null;var Ur=function(e,r){return{onEndResult:function(s){if(e==null||r==null)throw new Error("replaceResultTransformer requires at least 2 arguments.");return s.replace(e,r)}}};const je=Ur;var Mo=new Q(je(/(?:\n(?:\s*))+/g," "),ee);const Fo=null;var No=new Q(je(/(?:\n\s*)/g,""),ee);const Do=null;var jo=new Q(M({separator:","}),je(/(?:\s+)/g," "),ee);const Po=null;var Wo=new Q(M({separator:",",conjunction:"or"}),je(/(?:\s+)/g," "),ee);const Go=null;var $o=new Q(M({separator:",",conjunction:"and"}),je(/(?:\s+)/g," "),ee);const Ko=null;var ko=new Q(M,D,ee);const Vo=null;var Bo=new Q(M,je(/(?:\s+)/g," "),ee);const Qo=null;var zr=new Q(D,ee);const Hr=zr;var Yr=new Q(D("all"),ee);const z=Yr;var Xr=p(28848),Ut=p.n(Xr),f=p(96540),he=p(40845),zt=p(82762),Zr=p(41781);const Ht=[{label:"fields",documentation:"Retrieves the specified fields from log events"},{label:"display",documentation:"Specifies which fields to display in the query results"},{label:"filter",documentation:"Filters the results of a query based on one or more conditions"},{label:"stats",documentation:"Calculates aggregate statistics based on the values of log fields"},{label:"sort",documentation:"Sorts the retrieved log events"},{label:"limit",documentation:"Specifies the number of log events returned by the query"},{label:"parse",documentation:"Extracts data from a log field, creating one or more ephemeral fields that you can process further in the query"}],Uo=null,zo=null,Yt=[{label:"abs",detail:"abs(a)",documentation:"Absolute value."},{label:"ceil",detail:"ceil(a)",documentation:"Round to ceiling (the smallest integer that is greater than the value of a)."},{label:"floor",detail:"floor(a)",documentation:"Round to floor (the largest integer that is smaller than the value of a)."},{label:"greatest",detail:"greatest(a,b, ... z)",documentation:"Returns the largest value."},{label:"least",detail:"least(a, b, ... z)",documentation:"Returns the smallest value."},{label:"log",detail:"log(a)",documentation:"Natural logarithm."},{label:"sqrt",detail:"sqrt(a)",documentation:"Square root."}],Jr=[{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"coalesce",detail:"coalesce(fieldname1, fieldname2, ... fieldnamex)",documentation:"Returns the first non-null value from the list."}],Xt=[{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"concat",detail:"concat(string1, string2, ... stringz)",documentation:"Concatenates the strings."},{label:"ltrim",detail:"ltrim(string) or ltrim(string1, string2)",documentation:"Remove white space from the left of the string. If the function has a second string argument, it removes the characters of string2 from the left of string1."},{label:"rtrim",detail:"rtrim(string) or rtrim(string1, string2)",documentation:"Remove white space from the right of the string. If the function has a second string argument, it removes the characters of string2 from the right of string1."},{label:"trim",detail:"trim(string) or trim(string1, string2)",documentation:"Remove white space from both ends of the string. If the function has a second string argument, it removes the characters of string2 from both sides of string1."},{label:"strlen",detail:"strlen(string)",documentation:"Returns the length of the string in Unicode code points."},{label:"toupper",detail:"toupper(string)",documentation:"Converts the string to uppercase."},{label:"tolower",detail:"tolower(string)",documentation:"Converts the string to lowercase."},{label:"substr",detail:"substr(string1, x), or substr(string1, x, y)",documentation:"Returns a substring from the index specified by the number argument to the end of the string. If the function has a second number argument, it contains the length of the substring to be retrieved."},{label:"replace",detail:"replace(string1, string2, string3)",documentation:"Replaces all instances of string2 in string1 with string3."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."}],Zt=[{label:"bin",detail:"bin(period)",documentation:"Rounds the value of @timestamp to the given period and then truncates."},{label:"datefloor",detail:"datefloor(a, period)",documentation:"Truncates the timestamp to the given period."},{label:"dateceil",detail:"dateceil(a, period)",documentation:"Rounds up the timestamp to the given period and then truncates."},{label:"fromMillis",detail:"fromMillis(fieldname)",documentation:"Interprets the input field as the number of milliseconds since the Unix epoch and converts it to a timestamp."},{label:"toMillis",detail:"toMillis(fieldname)",documentation:"Converts the timestamp found in the named field into a number representing the milliseconds since the Unix epoch."}],bt=[{label:"isValidIp",detail:"isValidIp(fieldname)",documentation:"Returns true if the field is a valid v4 or v6 IP address."},{label:"isValidIpV4",detail:"isValidIpV4(fieldname)",documentation:"Returns true if the field is a valid v4 IP address."},{label:"isValidIpV6",detail:"isValidIpV6(fieldname)",documentation:"Returns true if the field is a valid v6 IP address."},{label:"isIpInSubnet",detail:"isIpInSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 or v6 IP address within the specified v4 or v6 subnet."},{label:"isIpv4InSubnet",detail:"isIpv4InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 IP address within the specified v4 subnet."},{label:"isIpv6InSubnet",detail:"isIpv6InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v6 IP address within the specified v6 subnet."}],Jt=[{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."},...bt],_t=[{label:"avg",detail:"avg(NumericFieldname)",documentation:"The average of the values in the specified field."},{label:"count",detail:"count(fieldname) or count(*)",documentation:"Counts the log records."},{label:"count_distinct",detail:"count_distinct(fieldname)",documentation:"Returns the number of unique values for the field."},{label:"max",detail:"max(fieldname)",documentation:"The maximum of the values for this log field in the queried logs."},{label:"min",detail:"min(fieldname)",documentation:"The minimum of the values for this log field in the queried logs."},{label:"pct",detail:"pct(fieldname, value)",documentation:"A percentile indicates the relative standing of a value in a datas."},{label:"stddev",detail:"stddev(NumericFieldname)",documentation:"The standard deviation of the values in the specified field."},{label:"sum",detail:"sum(NumericFieldname)",documentation:"The sum of the values in the specified field."}],_r=[{label:"earliest",detail:"earliest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the earliest time stamp in the queried logs."},{label:"latest",detail:"latest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the latest time stamp in the queried logs."},{label:"sortsFirst",detail:"sortsFirst(fieldname)",documentation:"Returns the value of fieldName that sorts first in the queried logs."},{label:"sortsLast",detail:"sortsLast(fieldname)",documentation:"Returns the value of fieldName that sorts last in the queried logs."}],qr=[..._t,..._r],en=["as","like","by","in","desc","asc"],qt=[...Yt,...Jr,...Xt,...Zt,...bt],tn=[...qt,...qr],er={comment:{pattern:/^#.*/,greedy:!0},backticks:{pattern:/`.*?`/,alias:"string",greedy:!0},quote:{pattern:/".*?"/,alias:"string",greedy:!0},regex:{pattern:/\/.*?\/(?=\||\s*$|,)/,greedy:!0},"query-command":{pattern:new RegExp(`\\b(?:${Ht.map(t=>t.label).join("|")})\\b`,"i"),alias:"function"},function:{pattern:new RegExp(`\\b(?:${tn.map(t=>t.label).join("|")})\\b`,"i")},keyword:{pattern:new RegExp(`(\\s+)(${en.join("|")})(?=\\s+)`,"i"),lookbehind:!0},"field-name":{pattern:/(@?[_a-zA-Z]+[_.0-9a-zA-Z]*)|(`((\\`)|([^`]))*?`)/,greedy:!0},number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,"command-separator":{pattern:/\|/,alias:"punctuation"},"comparison-operator":{pattern:/([<>]=?)|(!?=)/},punctuation:/[{}()`,.]/,whitespace:/\s+/},rn=[{category:"Lambda",examples:[{title:"View latency statistics for 5-minute intervals",expr:z`filter @type = "REPORT" |
                           stats avg(@duration), max(@duration), min(@duration) by bin(5m)`},{title:"Determine the amount of overprovisioned memory",expr:Hr`filter @type = "REPORT"
        | stats max(@memorySize / 1000 / 1000) as provisionedMemoryMB,
          min(@maxMemoryUsed / 1000 / 1000) as smallestMemoryRequestMB,
          avg(@maxMemoryUsed / 1000 / 1000) as avgMemoryUsedMB,
          max(@maxMemoryUsed / 1000 / 1000) as maxMemoryUsedMB,
          provisionedMemoryMB - maxMemoryUsedMB as overProvisionedMB
        `},{title:"Find the most expensive requests",expr:z`filter @type = "REPORT"
        | fields @requestId, @billedDuration
        | sort by @billedDuration desc`}]},{category:"VPC Flow Logs",examples:[{title:"Average, min, and max byte transfers by source and destination IP addresses",expr:"stats avg(bytes), min(bytes), max(bytes) by srcAddr, dstAddr"},{title:"IP addresses using UDP transfer protocol",expr:"filter protocol=17 | stats count(*) by srcAddr"},{title:"Top 10 byte transfers by source and destination IP addresses",expr:z`stats sum(bytes) as bytesTransferred by srcAddr, dstAddr |
                           sort bytesTransferred desc |
                           limit 10`},{title:"Top 20 source IP addresses with highest number of rejected requests",expr:z`filter action="REJECT" |
                           stats count(*) as numRejections by srcAddr |
                           sort numRejections desc |
                           limit 20`},{title:"Find the top 15 packet transfers across hosts",expr:z`stats sum(packets) as packetsTransferred by srcAddr, dstAddr
        | sort packetsTransferred  desc
        | limit 15`},{title:"Find the IP addresses where flow records were skipped during the capture window",expr:z`filter logStatus="SKIPDATA"
        | stats count(*) by bin(1h) as t
        | sort t`}]},{category:"CloudTrail",examples:[{title:"Number of log entries by service, event type, and region",expr:"stats count(*) by eventSource, eventName, awsRegion"},{title:"Number of log entries by region and EC2 event type",expr:z`filter eventSource="ec2.amazonaws.com" |
                           stats count(*) as eventCount by eventName, awsRegion |
                           sort eventCount desc`},{title:"Regions, usernames, and ARNs of newly created IAM users",expr:z`filter eventName="CreateUser" |
                           fields awsRegion, requestParameters.userName, responseElements.user.arn`},{title:"Find EC2 hosts that were started or stopped in a given AWS Region",expr:z`filter (eventName="StartInstances" or eventName="StopInstances") and region="us-east-2"`},{title:"Find the number of records where an exception occurred while invoking the UpdateTrail API",expr:z`filter eventName="UpdateTrail" and ispresent(errorCode) | stats count(*) by errorCode, errorMessage`},{title:"Find log entries where TLS 1.0 or 1.1 was used",expr:z`filter tlsDetails.tlsVersion in [ "TLSv1", "TLSv1.1" ]
        | stats count(*) as numOutdatedTlsCalls by userIdentity.accountId, recipientAccountId, eventSource, eventName, awsRegion, tlsDetails.tlsVersion, tlsDetails.cipherSuite, userAgent
        | sort eventSource, eventName, awsRegion, tlsDetails.tlsVersion`},{title:"Find the number of calls per service that used TLS versions 1.0 or 1.1",expr:z`filter tlsDetails.tlsVersion in [ "TLSv1", "TLSv1.1" ]
        | stats count(*) as numOutdatedTlsCalls by eventSource
        | sort numOutdatedTlsCalls desc`}]},{category:"Common Queries",examples:[{title:"25 most recently added log events",expr:z`fields @timestamp, @message |
                           sort @timestamp desc |
                           limit 25`},{title:"Number of exceptions logged every 5 minutes",expr:z`filter @message like /Exception/ |
                           stats count(*) as exceptionCount by bin(5m) |
                           sort exceptionCount desc`},{title:"List of log events that are not exceptions",expr:"fields @message | filter @message not like /Exception/"},{title:"To parse and count fields",expr:z`fields @timestamp, @message
        | filter @message like /User ID/
        | parse @message "User ID: *" as @userId
        | stats count(*) by @userId`},{title:"To Identify faults on any API calls",expr:z`filter Operation = <operation> AND Fault > 0
        | fields @timestamp, @logStream as instanceId, ExceptionMessage`},{title:"To get the number of exceptions logged every 5 minutes using regex where exception is not case sensitive",expr:z`filter @message like /(?i)Exception/
        | stats count(*) as exceptionCount by bin(5m)
        | sort exceptionCount desc`},{title:"To parse ephemeral fields using a glob expression",expr:z`parse @message "user=*, method:*, latency := *" as @user, @method, @latency
        | stats avg(@latency) by @method, @user`},{title:"To parse ephemeral fields using a glob expression using regular expression",expr:z`parse @message /user=(?<user2>.*?), method:(?<method2>.*?), latency := (?<latency2>.*?)/
        | stats avg(latency2) by @method2, @user2`},{title:"To extract ephemeral fields and display field for events that contain an ERROR string",expr:z`fields @message
        | parse @message "* [*] *" as loggingTime, loggingType, loggingMessage
        | filter loggingType IN ["ERROR"]
        | display loggingMessage, loggingType = "ERROR" as isError`},{title:"To trim whitespaces from query results",expr:z`fields trim(@message) as trimmedMessage
        | parse trimmedMessage "[*] * * Retrieving CloudWatch Metrics for AccountID : *, CloudWatch Metric : *, Resource Type : *, ResourceID : *" as level, time, logId, accountId, metric, type, resourceId
        | display level, time, logId, accountId, metric, type, resourceId
        | filter level like "INFO"`}]},{category:"Route 53",examples:[{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) by queryType, bin(10m)"},{title:"Number of unsuccessful requests by domain",expr:'filter responseCode="SERVFAIL" | stats count(*) by queryName'},{title:"Top 10 DNS resolver IPs with highest number of requests",expr:"stats count(*) as numRequests by resolverIp | sort numRequests desc | limit 10"}]},{category:"AWS AppSync",examples:[{title:"Number of unique HTTP status codes",expr:z`fields ispresent(graphQLAPIId) as isApi |
                           filter isApi |
                           filter logType = "RequestSummary" |
                           stats count() as statusCount by statusCode |
                           sort statusCount desc`},{title:"Top 10 resolvers with maximum latency",expr:z`fields resolverArn, duration |
                           filter logType = "Tracing" |
                           sort duration desc |
                           limit 10`},{title:"Most frequently invoked resolvers",expr:z`fields ispresent(resolverArn) as isRes |
                           stats count() as invocationCount by resolverArn |
                           filter isRes |
                           filter logType = "Tracing" |
                           sort invocationCount desc |
                           limit 10`},{title:"Resolvers with most errors in mapping templates",expr:z`fields ispresent(resolverArn) as isRes |
                           stats count() as errorCount by resolverArn, logType |
                           filter isRes and (logType = "RequestMapping" or logType = "ResponseMapping") and fieldInError |
                           sort errorCount desc |
                           limit 10`},{title:"Field latency statistics",expr:z`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`},{title:"Resolver latency statistics",expr:z`fields ispresent(resolverArn) as isRes |
                           filter isRes |
                           filter logType = "Tracing" |
                           stats min(duration), max(duration), avg(duration) as avgDur by resolverArn |
                           sort avgDur desc |
                           limit 10`},{title:"Top 10 requests with maximum latency",expr:z`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`}]}],nn=[{category:"fields",examples:[{description:"Retrieve one or more log fields. You can also use functions and operations such as abs(a+b), sqrt(a/b), log(a)+log(b), strlen(trim()), datefloor(), isPresent(), and others in this command.",expr:"fields @log, @logStream, @message, @timestamp"}]},{category:"filter",examples:[{description:"Retrieve log fields based on one or more conditions. You can use comparison operators such as =, !=, >, >=, <, <=, boolean operators such as and, or, and not, and regular expressions in this command.",expr:"filter @message like /(?i)(Exception|error|fail|5dd)/"}]},{category:"stats",examples:[{description:"Calculate aggregate statistics such as sum(), avg(), count(), min() and max() for log fields.",expr:"stats count() by bin(5m)"}]},{category:"sort",examples:[{description:"Sort the log fields in ascending or descending order.",expr:"sort @timestamp asc"}]},{category:"limit",examples:[{description:"Limit the number of log events returned by a query.",expr:"limit 10"}]},{category:"parse",examples:[{description:"Create one or more ephemeral fields, which can be further processed by the query. The following example will extract the ephemeral fields host, identity, dateTimeString, httpVerb, url, protocol, statusCode, bytes from @message, and return the url, max(bytes), and avg(bytes) fields sorted by max(bytes) in descending order.",expr:z`parse '* - * [*] "* * *" * *' as host, identity, dateTimeString, httpVerb, url, protocol, statusCode, bytes
        | stats max(bytes) as maxBytes, avg(bytes) by url
        | sort maxBytes desc`}]}];function tr(t,e){const r=er,s=(0,Zr.R)(Ut().tokenize(t,r)).filter(i=>typeof i!="string").map((i,a)=>(0,o.jsx)("span",{className:`prism-token token ${i.types.join(" ")} ${i.aliases.join(" ")}`,children:i.content},`${e}-token-${a}`));return(0,o.jsx)("div",{className:"slate-query-field",children:s})}const sn=t=>{const[e,r]=(0,f.useState)(!1),[n,s]=(0,f.useState)(!1),i=(0,he.of)(on);return(0,o.jsxs)("div",{children:[(0,o.jsx)("h3",{children:"CloudWatch Logs cheat sheet"}),(0,o.jsx)(zt.S,{label:"Commands",collapsible:!0,isOpen:e,onToggle:a=>r(a),children:(0,o.jsx)(o.Fragment,{children:nn.map((a,l)=>(0,o.jsxs)("div",{children:[(0,o.jsx)("h5",{children:a.category}),a.examples.map((c,d)=>(0,o.jsxs)("div",{children:[(0,o.jsx)("p",{children:c.description}),(0,o.jsx)("button",{type:"button",className:i.cheatSheetExample,onClick:()=>t.onClickExample({refId:t.query.refId??"A",expression:c.expr,queryMode:"Logs",region:t.query.region,id:t.query.refId??"A",logGroupNames:"logGroupNames"in t.query?t.query.logGroupNames:[],logGroups:"logGroups"in t.query?t.query.logGroups:[]}),children:(0,o.jsx)("pre",{children:tr(c.expr,`item-${d}`)})},c.expr)]},`item-${d}`))]},`cat-${l}`))})}),(0,o.jsx)(zt.S,{label:"Queries",collapsible:!0,isOpen:n,onToggle:a=>s(a),children:rn.map((a,l)=>(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:(0,S.cx)(i.cheatSheetItemTitle,i.exampleCategory),children:a.category}),a.examples.map((c,d)=>(0,o.jsxs)("div",{className:i.cheatSheetItem,children:[(0,o.jsx)("h4",{children:c.title}),(0,o.jsx)("button",{type:"button",className:i.cheatSheetExample,onClick:()=>t.onClickExample({refId:t.query.refId??"A",expression:c.expr,queryMode:"Logs",region:t.query.region,id:t.query.refId??"A",logGroupNames:"logGroupNames"in t.query?t.query.logGroupNames:[],logGroups:"logGroups"in t.query?t.query.logGroups:[]}),children:(0,o.jsx)("pre",{children:tr(c.expr,`item-${d}`)})},c.expr)]},`item-${d}`))]},`cat-${l}`))}),(0,o.jsxs)("div",{children:["Note: If you are seeing masked data, you may have CloudWatch logs data protection enabled."," ",(0,o.jsx)("a",{className:i.link,href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/#cloudwatch-logs-data-protection",target:"_blank",rel:"noreferrer",children:"See documentation for details"}),"."]})]})},on=t=>({exampleCategory:(0,S.css)({marginTop:"5px"}),link:(0,S.css)({textDecoration:"underline"}),cheatSheetItem:(0,S.css)({margin:t.spacing(3,0)}),cheatSheetItemTitle:(0,S.css)({fontSize:t.typography.h3.fontSize}),cheatSheetExample:(0,S.css)({margin:t.spacing(.5,0),textAlign:"left",border:"none",background:"transparent",display:"block"})});var an=p(40996),ln=p(19045),Ve=p(22391),St=p(65879),At=p(91062),cn=p(44027),q=p(32264),It=p(19347),xe=p(42418),Be=p(88575),pe=p(10354),rr=p(25994),te=p(2543),Qe=p(62467),un=p(44240),Ie=p(39070),dn=p(26657),Te=p(72574),nr=p(6191),nt=p(22354),Ce=p(9e4),U=p(81580),Tt=p(79458),be=p(68402);const Ue=t=>t.queryMode==="Logs",Le=t=>t.queryMode==="Metrics"||!t.hasOwnProperty("queryMode"),sr=t=>t.queryMode==="Annotations",mn=t=>t.target?.queryMode==="Annotations";var pn=p(45214),Ct=p(41053),re=p(50877),y=p(25640);const ze=t=>({label:t,value:t}),fe=(t,e)=>[...e,{label:"Template Variables",options:t.getVariables().map(ze)}],ir=t=>{const{region:e,metricQueryType:r,metricEditorMode:n,expression:s,metricName:i,namespace:a,sqlExpression:l,statistic:c}=t;return e?r===y.d$.Search&&n===y.Rx.Builder?!!a&&!!i&&!!c:r===y.d$.Search&&n===y.Rx.Code?!!s:r===y.d$.Insights?!!l:!1:!1},Et=t=>{const[e,r]=(0,f.useState)(!1),[n,s]=(0,f.useState)([{label:"default",value:"default"}]);return(0,f.useEffect)(()=>{r(!0);const i={label:"Template Variables",options:t.getVariables().map(re.z)};t.resources.getRegions().then(a=>s([...a,i])).finally(()=>r(!1))},[t]),[n,e]},wt=t=>{const[e,r]=(0,f.useState)([]);return(0,f.useEffect)(()=>{t.resources.getNamespaces().then(n=>{r(fe(t,n))})},[t]),e},Rt=(t,{region:e,namespace:r,accountId:n})=>{const[s,i]=(0,f.useState)([]);return e&&(e=t.templateSrv.replace(e,{})),r&&(r=t.templateSrv.replace(r,{})),n&&(n=t.templateSrv.replace(n,{})),(0,f.useEffect)(()=>{t.resources.getMetrics({namespace:r,region:e,accountId:n}).then(a=>{i(fe(t,a))})},[t,e,r,n]),s},He=(t,{region:e,namespace:r,metricName:n,dimensionFilters:s,accountId:i})=>{const[a,l]=(0,f.useState)([]);return e&&(e=t.templateSrv.replace(e,{})),r&&(r=t.templateSrv.replace(r,{})),n&&(n=t.templateSrv.replace(n,{})),i&&(i=t.templateSrv.replace(i,{})),s&&(s=t.resources.convertDimensionFormat(s,{},!1)),(0,pn.A)(()=>{t.resources.getDimensionKeys({namespace:r,region:e,metricName:n,accountId:i,dimensionFilters:s},!1).then(c=>{l(fe(t,c))})},[t,r,e,n,i,s]),a},Ye=(t,e)=>{const[r,n]=(0,f.useState)(""),s=t.templateSrv.replace(e);return(0,f.useEffect)(()=>{if(t.resources.isVariableWithMultipleOptionsSelected(e)){const i=`Template variables with multiple selected options are not supported for ${e}`;r!==i&&n(i);return}r&&n("")},[t.resources,e,s,r]),r},or=(t,e)=>{const[r,n]=(0,f.useState)(!1);return e&&(e=t.templateSrv.replace(e,{})),(0,f.useEffect)(()=>{q.$.featureToggles.cloudWatchCrossAccountQuerying&&t.isMonitoringAccount(e).then(s=>n(s))},[e,t]),r},st=(t,e)=>{e&&(e=t?.templateSrv.replace(e,{})??"");const r=async()=>{if(!q.$.featureToggles.cloudWatchCrossAccountQuerying)return Promise.resolve([]);const i=await t?.getAccounts({region:e})??[];if(i.length===0)return[];const a=i.map(d=>({label:d.label,value:d.id,description:d.id})),c={label:"Template Variables",options:t?.getVariables().map(re.z)||[]};return[...a,c]},[n,s]=(0,Ct.A)(r,[t,e]);return(0,f.useEffect)(()=>{s()},[t,e,s]),n};var ar=p(71087),it=p(97801),ne=p(90182);const ot=["Average","Maximum","Minimum","Sum","SampleCount","IQM"],Pe={label:"All",value:"all",description:"Target all linked accounts"};function Ot({accountId:t,onChange:e,accountOptions:r}){const n=(0,f.useMemo)(()=>r.find(s=>s.options?s.options.find(a=>a.value===t):s.value===t),[r,t]);return r.length===0?null:(0,o.jsx)(U.c,{label:"Account",width:26,tooltip:"A CloudWatch monitoring account views data from source accounts so you can centralize monitoring and troubleshooting activities across multiple accounts. Go to the CloudWatch settings page in the AWS console for more details.",children:(0,o.jsx)(ne.l6,{"aria-label":"Account Selection",value:n?t:Pe.value,options:[Pe,...r],onChange:({value:s})=>{e(s)}})})}var at=p(85269),Xe=p(81392),Ze=p(3721);const lr={value:"*",label:"*"},gn=(t,e)=>Object.entries(t??{}).reduce((r,[n,s])=>n!==e?{...r,[n]:s}:r,{}),hn=({filter:t,metricStat:e,datasource:r,disableExpressions:n,onChange:s,onDelete:i})=>{const{region:a,namespace:l,metricName:c,dimensions:d,accountId:u}=e,g=Ye(r,t.key),m=(0,f.useMemo)(()=>gn(d??{},t.key),[d,t]),A=He(r,{...e,dimensionFilters:m}),v=async()=>t.key?r.resources.getDimensionValues({dimensionKey:t.key,dimensionFilters:m,region:a,namespace:l,metricName:c,accountId:u}).then(E=>(E.length&&!n&&!E.some($=>$.value===lr.value)&&E.unshift(lr),fe(r,E))):[],[R,I]=(0,Ct.A)(v,[t.key,d,a,l,c,u]),T=(0,he.of)(fn);return(0,o.jsxs)("div",{className:T.container,"data-testid":"cloudwatch-dimensions-filter-item",children:[(0,o.jsxs)(Xe.M,{children:[(0,o.jsx)(ne.l6,{"aria-label":"Dimensions filter key",inputId:"cloudwatch-dimensions-filter-item-key",width:"auto",value:t.key?(0,re.z)(t.key):null,allowCustomValue:!0,options:A,onChange:E=>{E.label&&s({key:E.label,value:void 0})}}),(0,o.jsx)("span",{className:(0,S.cx)(T.root),children:"="}),(0,o.jsx)(ne.l6,{"aria-label":"Dimensions filter value",inputId:"cloudwatch-dimensions-filter-item-value",onOpenMenu:I,width:"auto",value:t.value?(0,re.z)(t.value):null,allowCustomValue:!0,isLoading:R.loading,options:R.value,onChange:E=>{E.value&&s({...t,value:E.value})}}),(0,o.jsx)(Ze.Z,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:i,type:"button"})]}),g&&(0,o.jsx)(xe.F,{className:T.alert,title:g,severity:"error",topSpacing:1})]})},fn=t=>({root:(0,S.css)({padding:t.spacing(0,1),alignSelf:"center"}),container:(0,S.css)({display:"inline-block"}),alert:(0,S.css)({minWidth:"100%",width:"min-content"})}),yn=t=>Object.entries(t??{}).reduce((e,[r,n])=>{if(!n)return e;let s="";if(typeof n=="string"?s=n:Array.isArray(n)&&typeof n[0]=="string"&&(s=n[0]),!s)return e;const i={key:r,value:s,operator:"="};return[...e,i]},[]),vn=t=>t.reduce((e,{key:r,value:n})=>r&&n?{...e,[r]:n}:e,{}),cr=({metricStat:t,datasource:e,disableExpressions:r,onChange:n})=>{const s=(0,f.useMemo)(()=>yn(t.dimensions),[t.dimensions]),[i,a]=(0,f.useState)(s),l=c=>{a(c);const d=vn(c);(0,te.isEqual)(d,t.dimensions)||n(d)};return(0,o.jsx)(at.o,{items:i,onChange:l,renderItem:xn(e,t,r)})};function xn(t,e,r){function n(s,i,a){return(0,o.jsx)(hn,{filter:s,onChange:l=>i(l),datasource:t,metricStat:e,disableExpressions:r,onDelete:a})}return n}const bn=/^(p|tm|tc|ts|wm)\d{2}(?:\.\d{1,2})?$/,Sn="\\d*(\\.\\d+)?%?:\\d*(\\.\\d+)?%?",An=new RegExp(`^(PR|TM|TC|TS|WM)\\((${Sn})\\)$`),ur=({refId:t,metricStat:e,datasource:r,disableExpressions:n=!1,onChange:s})=>{const i=wt(r),a=Rt(r,e),l=st(r.resources,e.region);(0,f.useEffect)(()=>{r.resources.isMonitoringAccount(e.region).then(u=>{u&&!l.loading&&l.value?.length&&!e.accountId&&s({...e,accountId:"all"}),!l.loading&&l.value&&!l.value.length&&e.accountId&&s({...e,accountId:void 0})})},[l,e,s,r.resources]);const c=async u=>{const g=await d(u);s(g)},d=async u=>{let{metricName:g,namespace:m,region:A}=u;return g?(await r.resources.getMetrics({namespace:m,region:A}).then(v=>{v.find(R=>R.value===g)||(g="")}),{...u,metricName:g}):u};return(0,o.jsxs)(ar.D,{children:[(0,o.jsxs)(Ce.U,{children:[!n&&q.$.featureToggles.cloudWatchCrossAccountQuerying&&(0,o.jsx)(Ot,{accountId:e.accountId,onChange:u=>{s({...e,accountId:u})},accountOptions:l?.value||[]}),(0,o.jsxs)(it.B,{children:[(0,o.jsx)(U.c,{label:"Namespace",width:26,children:(0,o.jsx)(ne.l6,{"aria-label":"Namespace",value:e?.namespace&&ze(e.namespace),allowCustomValue:!0,options:i,onChange:({value:u})=>{u&&c({...e,namespace:u})}})}),(0,o.jsx)(U.c,{label:"Metric name",width:16,children:(0,o.jsx)(ne.l6,{"aria-label":"Metric name",value:e?.metricName&&ze(e.metricName),allowCustomValue:!0,options:a,onChange:({value:u})=>{u&&s({...e,metricName:u})}})}),(0,o.jsx)(U.c,{label:"Statistic",width:16,children:(0,o.jsx)(ne.l6,{inputId:`${t}-metric-stat-editor-select-statistic`,allowCustomValue:!0,value:ze(e.statistic??ot[0]),options:fe(r,ot.filter(u=>u!==e.statistic).map(ze)),onChange:({value:u})=>{!u||!ot.includes(u)&&!(bn.test(u)||An.test(u))&&!r.templateSrv.containsTemplate(u)||s({...e,statistic:u})}})})]})]}),(0,o.jsxs)(Ce.U,{children:[(0,o.jsx)(U.c,{label:"Dimensions",children:(0,o.jsx)(cr,{metricStat:e,onChange:u=>s({...e,dimensions:u}),disableExpressions:n,datasource:r})}),!n&&(0,o.jsx)(U.c,{label:"Match exact",optional:!0,tooltip:(0,o.jsxs)(o.Fragment,{children:["Only show metrics that contain exactly the dimensions defined in the query and match the specified values. If this is enabled, all dimensions of the metric being queried must be specified so that the ",(0,o.jsx)("a",{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/search-expression-syntax.html",target:"_blank",rel:"noreferrer",children:"metric schema"})," matches exactly. If this is disabled, metrics that match the schema and have additional dimensions will also be returned."]}),tooltipInteractive:!0,children:(0,o.jsx)(Tt.C,{id:`${t}-cloudwatch-match-exact`,value:!!e.matchExact,onChange:u=>{s({...e,matchExact:u.currentTarget.checked})}})})]})]})},In=t=>{const{query:e,onChange:r,datasource:n}=t,[s,i]=Et(n);return sr(e)?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(nr.X,{children:(0,o.jsx)(nt.W,{label:"Region",value:s.find(a=>a.value===e.region),placeholder:"Select region",allowCustomValue:!0,onChange:({value:a})=>a&&r({...e,region:a}),options:s,isLoading:i})}),(0,o.jsx)(be.$,{v:.5}),(0,o.jsx)(ur,{...t,refId:e.refId,metricStat:e,disableExpressions:!0,onChange:a=>r({...e,...a})}),(0,o.jsx)(be.$,{v:.5}),(0,o.jsxs)(Ce.U,{children:[(0,o.jsx)(U.c,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,o.jsx)(pe.p,{value:e.period||"",placeholder:"auto",onChange:a=>r({...e,period:a.target.value})})}),(0,o.jsx)(U.c,{label:"Enable Prefix Matching",optional:!0,children:(0,o.jsx)(Tt.C,{value:e.prefixMatching,onChange:a=>{r({...e,prefixMatching:a.currentTarget.checked})}})}),(0,o.jsx)(U.c,{label:"Action",optional:!0,disabled:!e.prefixMatching,children:(0,o.jsx)(pe.p,{value:e.actionPrefix||"",onChange:a=>r({...e,actionPrefix:a.target.value})})}),(0,o.jsx)(U.c,{label:"Alarm Name",optional:!0,disabled:!e.prefixMatching,children:(0,o.jsx)(pe.p,{value:e.alarmNamePrefix||"",onChange:a=>r({...e,alarmNamePrefix:a.target.value})})})]})]}):(0,o.jsx)(xe.F,{severity:"error",title:"Invalid annotation query",topSpacing:2,children:JSON.stringify(e,null,4)})},dr={queryMode:"Metrics",namespace:"",metricName:"",expression:"",dimensions:{},region:"default",id:"",statistic:"Average",period:"",metricQueryType:y.d$.Search,metricEditorMode:y.Rx.Builder,sql:void 0,sqlExpression:"",matchExact:!0},Lt={queryMode:"Annotations",namespace:"",region:"default",statistic:"Average"},Tn=`fields @timestamp, @message |
 sort @timestamp desc |
 limit 20`,Cn=(t,e)=>({id:"",region:"default",logGroupNames:e,logGroups:t??[]}),En={queryType:y.b4.Regions,region:"default"},wn={prepareAnnotation:t=>mn(t)?t:{datasource:t.datasource,enable:t.enable,iconColor:t.iconColor,name:t.name,builtIn:t.builtIn,hide:t.hide,target:{...t.target,...t,statistic:t.statistic||Lt.statistic,region:t.region||Lt.region,queryMode:"Annotations",refId:t.refId||"annotationQuery"}},prepareQuery:t=>{if(!t.target)return;const{prefixMatching:e,actionPrefix:r,alarmNamePrefix:n,statistic:s,namespace:i,metricName:a,dimensions:l={}}=t.target,c=!!e&&!!r&&!!n,d=!e&&!!i&&!!a&&!!s&&!!Object.values(l).length;if(c||d)return t.target},getDefaultQuery(){return Lt},QueryEditor:In};var mr=p(75505),Me=p(75071);const pr=/\$(\w+)|\[\[(\w+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::([^\}]+))?}/g,Rn=t=>(pr.lastIndex=0,pr.exec(t)),lt=t=>{const e=Rn(t);return e?e.slice(1).find(n=>n!==void 0):null},Mt=(t,e,r,n)=>{n=n??"value";const s=n==="value"?"pipe":"text";let i=[];for(const a of e){const l=lt(a),c=t.getVariables().find(({name:d})=>d===l);if(c&&"current"in c&&On(c.current)){const d=c.current[n];if(Array.isArray(d)){const u=s==="text"?" + ":"|";i.push(...t.replace(a,r,s).split(u))}else typeof d=="string"&&i.push(t.replace(a,r,s))}else i.push(a)}return i},gr=(t,e)=>{const r=lt(e);return t.getVariables().some(({name:n})=>n===r)},On=t=>t.hasOwnProperty("value")&&t.hasOwnProperty("text");class Ln extends P.Is{constructor(e,r,n){super(),this.started=!1,this.cleanText=s=>s.replace(/[()]/g,"").trim(),this.request=(s,i)=>(0,mr.s)(this.datasource.logsQueryRunner.awsRequest(s,i)),this.start=()=>(this.startTask||(this.startTask=Promise.resolve().then(()=>(this.started=!0,[]))),this.startTask),this.fetchFields=async(s,i)=>{const a=Mt(this.templateSrv,s.map(c=>c.name),{},"text");return(await Promise.all(a.map(c=>this.datasource.resources.getLogGroupFields({logGroupName:c,region:i}).then(d=>d.filter(u=>u).map(u=>u.value.name??""))))).flat()},this.handleKeyword=async s=>{const i=await this.getFieldCompletionItems(s?.logGroups,s?.region||"default"),a=[{searchFunctionType:Me.T.Prefix,label:"Functions",items:Xt.concat(Zt,bt)}];return i.suggestions.push(...a),i},this.handleCommand=async(s,i,a)=>{const l=s.content.toLowerCase(),c=We(i),d=c===s;if(l==="sort")return this.handleSortCommand(d,i,a);if(l==="parse"&&d)return await this.getFieldCompletionItems(a?.logGroups??[],a?.region||"default");const u=Ee(s.next,"whitespace")&&!s.next?.next,g=u||Mn(s)===i,m=Ee(i,"punctuation",","),A=m||Ee(c,"punctuation",",");if(!(g||A))return{suggestions:[]};if(["display","fields"].includes(l)){const v=await this.getFieldCompletionItems(a?.logGroups??[],a?.region||"default");return v.suggestions.push(...this.getFieldAndFilterFunctionCompletionItems().suggestions),v}if(l==="stats"){const v=this.getStatsAggCompletionItems();return(m||u)&&v?.suggestions.forEach(R=>{R.skipFilter=!0}),v}if(l==="filter"&&d){const v=await this.getFieldCompletionItems(a?.logGroups,a?.region||"default"),R=this.getBoolFuncCompletionItems();return v.suggestions.push(...R.suggestions),v}return{suggestions:[]}},this.handleComparison=async s=>{const i=await this.getFieldCompletionItems(s?.logGroups,s?.region||"default"),a=this.getComparisonCompletionItems();return i.suggestions.push(...a.suggestions),i},this.getCommandCompletionItems=()=>({suggestions:[{searchFunctionType:Me.T.Prefix,label:"Commands",items:Ht}]}),this.getFieldAndFilterFunctionCompletionItems=()=>({suggestions:[{searchFunctionType:Me.T.Prefix,label:"Functions",items:qt}]}),this.getStatsAggCompletionItems=()=>({suggestions:[{searchFunctionType:Me.T.Prefix,label:"Functions",items:_t}]}),this.getBoolFuncCompletionItems=()=>({suggestions:[{searchFunctionType:Me.T.Prefix,label:"Functions",items:Jt}]}),this.getComparisonCompletionItems=()=>({suggestions:[{searchFunctionType:Me.T.Prefix,label:"Functions",items:Yt.concat(Jt)}]}),this.getFieldCompletionItems=async(s,i)=>s?{suggestions:[{label:"Fields",items:(await this.fetchFields(s,i)).map(l=>({label:l,insertText:l.match(/@?[_a-zA-Z]+[_.0-9a-zA-Z]*/)?void 0:`\`${l}\``}))}]}:{suggestions:[]},this.datasource=e,this.templateSrv=r??(0,Te.w)(),Object.assign(this,n)}getSyntax(){return er}isStatsQuery(e){const r=this.getSyntax();return!!(Ut().tokenize(e,r)??[]).find(s=>typeof s!="string"&&s.content.toString().toLowerCase()==="stats"&&s.type==="query-command")}async provideCompletionItems(e,r){const{value:n}=e,s=n?.data.get("tokens");if(!s||!s.length)return{suggestions:[]};const i=s.filter(u=>u.offsets.start<=n.selection?.start?.offset&&u.offsets.end>=n.selection?.start?.offset)[0],a=!i.prev,l=We(i);if(a||!a&&l?.types.includes("command-separator"))return this.getCommandCompletionItems();if(Dn(i))return await this.getFieldCompletionItems(r?.logGroups,r?.region||"default");if(jn("by",i))return this.handleKeyword(r);if(l?.types.includes("comparison-operator"))return this.handleComparison(r);const d=Fn(i);return d?await this.handleCommand(d,i,r):{suggestions:[]}}async handleSortCommand(e,r,n){return e?await this.getFieldCompletionItems(n?.logGroups,n?.region||"default"):Ee(We(r),"field-name")?{suggestions:[{searchFunctionType:Me.T.Prefix,label:"Sort Order",items:[{label:"asc"},{label:"desc"}]}]}:{suggestions:[]}}}function Mn(t){let e=t;for(;e.next;)if(e.next.types.includes("whitespace"))e=e.next;else return e.next;return null}function We(t){let e=t;for(;e.prev;)if(Ee(e.prev,"whitespace"))e=e.prev;else return e.prev;return null}function Fn(t){let e=t;for(;e.prev;)if(e=e.prev,e.types.includes("query-command")&&(!e.prev||Ee(We(e),"command-separator")))return e;return null}const Nn=["avg","count","count_distinct","earliest","latest","sortsFirst","sortsLast","max","min","pct","stddev","ispresent","fromMillis","toMillis","isempty","isblank","isValidIp","isValidIpV4","isValidIpV6","isIpInSubnet","isIpv4InSubnet","isIpv6InSubnet"].map(t=>t.toLowerCase());function Dn(t){const e=We(t);if(!e)return!1;const r=t.content==="("?t:e.content==="("?e:void 0;if(r){const n=We(r);if(n)return Nn.includes(n.content.toLowerCase())&&n.types.includes("function")}return!1}function jn(t,e){const r=hr(e,["whitespace","function","punctuation","field-name","number"]);if(Ee(r,"keyword","by")){const n=hr(e,["whitespace"]);if(n===r||Ee(n,"punctuation",","))return!0}return!1}function Ee(t,e,r){return!(!t?.types.includes(e)||r&&t?.content.toLowerCase()!==r)}function hr(t,e){let r=t.prev;e:for(;r;){for(const n of e)if(typeof n=="string"){if(r.types.includes(n)){r=r.prev;continue e}}else if(r.types.includes(n.type)&&r.content.toLowerCase()===n.value){r=r.prev;continue e}break}return r}class Pn{constructor(e,r,n,s,i,a){this.type=e,this.value=r,this.range=n,this.previous=s,this.next=i,this.tokenTypes=a}isKeyword(){return this.type===this.tokenTypes.Keyword}isWhiteSpace(){return this.type===this.tokenTypes.Whitespace}isParenthesis(){return this.type===this.tokenTypes.Parenthesis}isIdentifier(){return this.type===this.tokenTypes.Identifier}isString(){return this.type===this.tokenTypes.String}isDoubleQuotedString(){return this.type===this.tokenTypes.Type}isVariable(){return this.type===this.tokenTypes.Variable}isFunction(){return this.type===this.tokenTypes.Function}isNumber(){return this.type===this.tokenTypes.Number}is(e,r){const n=this.type===e;return r!==void 0?n&&this.value===r:n}endsWith(e){return this.value===e||this.value[this.value.length-1]===e}getPreviousNonWhiteSpaceToken(){let e=this.previous;for(;e!=null;){if(!e.isWhiteSpace())return e;e=e.previous}return null}getPreviousOfType(e,r){let n=this.previous;for(;n!=null;){const s=n.type===e;if(r!==void 0?s&&n.value===r:s)return n;n=n.previous}return null}getPreviousUntil(e,r,n){let s=[],i=this.previous;for(;i!=null;){if(r.some(l=>l===i?.type)){i=i.previous;continue}const a=i.type===e;if(n!==void 0?a&&i.value===n:a)return s;i.isWhiteSpace()||s.push(i),i=i.previous}return s}getNextUntil(e,r,n){let s=[],i=this.next;for(;i!=null;){if(r.some(l=>l===i?.type)){i=i.next;continue}const a=i.type===e;if(n!==void 0?a&&i.value===n:a)return s;i.isWhiteSpace()||s.push(i),i=i.next}return s}getPreviousKeyword(){let e=this.previous;for(;e!=null;){if(e.isKeyword())return e;e=e.previous}return null}getNextNonWhiteSpaceToken(){let e=this.next;for(;e!=null;){if(!e.isWhiteSpace())return e;e=e.next}return null}getNextOfType(e,r){let n=this.next;for(;n!=null;){const s=n.type===e;if(r!==void 0?s&&n.value===r:s)return n;n=n.next}return null}}function fr(t,e,r,n,s){let i=null,a=null;const l=t.editor.tokenize(r.getValue()??"",e.id);for(let c=0;c<l.length;c++){const d=l[c];if(!d.length&&a){const u={offset:0,type:s.Whitespace,language:e.id,_tokenBrand:void 0};d.push(u)}for(let u=0;u<d.length;u++){const g=d[u];let m=d.length>u+1?d[u+1].offset+1:r.getLineLength(c+1)+1;const A={startLineNumber:c+1,startColumn:g.offset===0?0:g.offset+1,endLineNumber:c+1,endColumn:m},v=r.getValueInRange(A),R=new Pn(g.type,v,A,a,null,s);t.Range.containsPosition(A,n)&&(i=R),a&&(a.next=R),a=R}}return i}var h=(t=>(t[t.Unknown=0]="Unknown",t[t.SelectKeyword=1]="SelectKeyword",t[t.AfterSelectKeyword=2]="AfterSelectKeyword",t[t.AfterSelectFuncFirstArgument=3]="AfterSelectFuncFirstArgument",t[t.AfterFromKeyword=4]="AfterFromKeyword",t[t.SchemaFuncFirstArgument=5]="SchemaFuncFirstArgument",t[t.SchemaFuncExtraArgument=6]="SchemaFuncExtraArgument",t[t.FromKeyword=7]="FromKeyword",t[t.AfterFrom=8]="AfterFrom",t[t.WhereKey=9]="WhereKey",t[t.WhereComparisonOperator=10]="WhereComparisonOperator",t[t.WhereValue=11]="WhereValue",t[t.AfterWhereValue=12]="AfterWhereValue",t[t.AfterGroupByKeywords=13]="AfterGroupByKeywords",t[t.AfterGroupBy=14]="AfterGroupBy",t[t.AfterOrderByKeywords=15]="AfterOrderByKeywords",t[t.AfterOrderByFunction=16]="AfterOrderByFunction",t[t.AfterOrderByDirection=17]="AfterOrderByDirection",t[t.PredefinedFunction=18]="PredefinedFunction",t[t.SearchFuncSecondArg=19]="SearchFuncSecondArg",t[t.SearchFuncThirdArg=20]="SearchFuncThirdArg",t[t.PredefinedFuncSecondArg=21]="PredefinedFuncSecondArg",t[t.AfterFunction=22]="AfterFunction",t[t.WithinString=23]="WithinString",t[t.NewCommand=24]="NewCommand",t[t.Comment=25]="Comment",t[t.DedupKeyword=26]="DedupKeyword",t[t.AfterDedupKeyword=27]="AfterDedupKeyword",t[t.DisplayKeyword=28]="DisplayKeyword",t[t.AfterDisplayKeyword=29]="AfterDisplayKeyword",t[t.FieldsKeyword=30]="FieldsKeyword",t[t.AfterFieldsKeyword=31]="AfterFieldsKeyword",t[t.FilterKeyword=32]="FilterKeyword",t[t.AfterFilterKeyword=33]="AfterFilterKeyword",t[t.FilterArg=34]="FilterArg",t[t.LimitKeyword=35]="LimitKeyword",t[t.AfterLimitKeyword=36]="AfterLimitKeyword",t[t.ParseKeyword=37]="ParseKeyword",t[t.AfterParseKeyword=38]="AfterParseKeyword",t[t.SortKeyword=39]="SortKeyword",t[t.AfterSortKeyword=40]="AfterSortKeyword",t[t.SortArg=41]="SortArg",t[t.StatsKeyword=42]="StatsKeyword",t[t.AfterStatsKeyword=43]="AfterStatsKeyword",t[t.AsKeyword=44]="AsKeyword",t[t.AfterAsKeyword=45]="AfterAsKeyword",t[t.ByKeyword=46]="ByKeyword",t[t.AfterByKeyword=47]="AfterByKeyword",t[t.InKeyword=48]="InKeyword",t[t.AfterInKeyword=49]="AfterInKeyword",t[t.LikeKeyword=50]="LikeKeyword",t[t.AfterLikeKeyword=51]="AfterLikeKeyword",t[t.Function=52]="Function",t[t.FunctionArg=53]="FunctionArg",t[t.CommandArg=54]="CommandArg",t[t.AfterCommand=55]="AfterCommand",t[t.ArithmeticOperator=56]="ArithmeticOperator",t[t.ArithmeticOperatorArg=57]="ArithmeticOperatorArg",t[t.BooleanOperator=58]="BooleanOperator",t[t.BooleanOperatorArg=59]="BooleanOperatorArg",t[t.ComparisonOperator=60]="ComparisonOperator",t[t.ComparisonOperatorArg=61]="ComparisonOperatorArg",t))(h||{}),C=(t=>(t[t.SelectKeyword=0]="SelectKeyword",t[t.FunctionsWithArguments=1]="FunctionsWithArguments",t[t.Metrics=2]="Metrics",t[t.FromKeyword=3]="FromKeyword",t[t.SchemaKeyword=4]="SchemaKeyword",t[t.Namespaces=5]="Namespaces",t[t.LabelKeys=6]="LabelKeys",t[t.WhereKeyword=7]="WhereKeyword",t[t.GroupByKeywords=8]="GroupByKeywords",t[t.OrderByKeywords=9]="OrderByKeywords",t[t.FunctionsWithoutArguments=10]="FunctionsWithoutArguments",t[t.LimitKeyword=11]="LimitKeyword",t[t.SortOrderDirectionKeyword=12]="SortOrderDirectionKeyword",t[t.ComparisonOperators=13]="ComparisonOperators",t[t.LabelValues=14]="LabelValues",t[t.LogicalOperators=15]="LogicalOperators",t[t.KeywordArguments=16]="KeywordArguments",t[t.Operators=17]="Operators",t[t.Statistic=18]="Statistic",t[t.Period=19]="Period",t[t.Command=20]="Command",t[t.Function=21]="Function",t[t.InKeyword=22]="InKeyword",t))(C||{}),se=(t=>(t.High="a",t.MediumHigh="d",t.Medium="g",t.MediumLow="k",t.Low="q",t))(se||{});class Ft{constructor(e,r=(0,Te.w)()){this.resources=e,this.templateSrv=r,this.templateSrv=r,this.tokenTypes={Parenthesis:"delimiter.parenthesis",Whitespace:"white",Keyword:"keyword",Delimiter:"delimiter",Operator:"operator",Identifier:"identifier",Type:"type",Function:"predefined",Number:"number",String:"string",Variable:"variable",Comment:"comment",Regexp:"regexp"}}getStatementPosition(e){return h.Unknown}getSuggestionKinds(e){return[]}getSuggestions(e,r,n,s,i){return Promise.reject([])}getCompletionProvider(e,r){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(n,s)=>{const i=fr(e,r,n,s,this.tokenTypes),a=this.getStatementPosition(i),l=this.getSuggestionKinds(a);return{suggestions:await this.getSuggestions(e,i,l,a,s)}}}}}const Z={id:"editor.action.triggerSuggest",title:""};var b=p(85232);const B={Parenthesis:"delimiter.parenthesis.sql",Whitespace:"white.sql",Keyword:"keyword.sql",Delimiter:"delimiter.sql",Operator:"operator.sql",Identifier:"identifier.sql",Type:"type.sql",Function:"predefined.sql",Number:"number.sql",String:"string.sql",Variable:"variable.sql",Comment:"comment.sql",Regexp:"regexp.sql"};function Wn(t){const e=t?.getPreviousNonWhiteSpaceToken(),r=t?.getPreviousKeyword(),n=t?.getPreviousNonWhiteSpaceToken()?.is(B.Operator,"/");return t===null||t.isWhiteSpace()&&t.previous===null||t.is(B.Keyword,b.SELECT)&&t.previous===null||n||t.isIdentifier()&&(n||t?.previous===null)?h.SelectKeyword:e?.value===b.SELECT?h.AfterSelectKeyword:(e?.is(B.Parenthesis,"(")||t?.is(B.Parenthesis,"()"))&&r?.value===b.SELECT?h.AfterSelectFuncFirstArgument:r?.value===b.SELECT&&e?.isParenthesis()?h.FromKeyword:e?.value===b.FROM?h.AfterFromKeyword:(e?.is(B.Parenthesis,"(")||t?.is(B.Parenthesis,"()"))&&r?.value===b.SCHEMA?h.SchemaFuncFirstArgument:r?.value===b.SCHEMA&&e?.is(B.Delimiter,",")?h.SchemaFuncExtraArgument:r?.value===b.FROM&&e?.isDoubleQuotedString()||r?.value===b.FROM&&e?.isVariable()||r?.value===b.SCHEMA&&e?.is(B.Parenthesis,")")?h.AfterFrom:r?.value===b.WHERE&&(e?.isKeyword()||e?.is(B.Parenthesis,"(")||e?.is(B.Operator,b.AND))?h.WhereKey:r?.value===b.WHERE&&(e?.isIdentifier()||e?.isDoubleQuotedString())?h.WhereComparisonOperator:r?.value===b.WHERE&&(e?.is(B.Operator,b.EQUALS)||e?.is(B.Operator,b.NOT_EQUALS))?h.WhereValue:r?.value===b.WHERE&&(e?.isString()||e?.is(B.Parenthesis,")"))?h.AfterWhereValue:r?.is(B.Keyword,b.BY)&&r?.getPreviousKeyword()?.is(B.Keyword,b.GROUP)&&(e?.is(B.Keyword,b.BY)||e?.is(B.Delimiter,","))?h.AfterGroupByKeywords:r?.is(B.Keyword,b.BY)&&r?.getPreviousKeyword()?.is(B.Keyword,b.GROUP)&&(e?.isIdentifier()||e?.isDoubleQuotedString())?h.AfterGroupBy:e?.is(B.Keyword,b.BY)&&e?.getPreviousKeyword()?.is(B.Keyword,b.ORDER)?h.AfterOrderByKeywords:r?.is(B.Keyword,b.BY)&&r?.getPreviousKeyword()?.is(B.Keyword,b.ORDER)&&e?.is(B.Parenthesis)&&e?.getPreviousNonWhiteSpaceToken()?.is(B.Function)?h.AfterOrderByFunction:r?.is(B.Keyword,b.DESC)||r?.is(B.Keyword,b.ASC)?h.AfterOrderByDirection:h.Unknown}function Gn(t){switch(t){case h.SelectKeyword:return[C.SelectKeyword];case h.AfterSelectKeyword:return[C.FunctionsWithArguments];case h.AfterSelectFuncFirstArgument:return[C.Metrics];case h.AfterFromKeyword:return[C.Namespaces,C.SchemaKeyword];case h.SchemaFuncFirstArgument:return[C.Namespaces];case h.SchemaFuncExtraArgument:return[C.LabelKeys];case h.FromKeyword:return[C.FromKeyword];case h.AfterFrom:return[C.WhereKeyword,C.GroupByKeywords,C.OrderByKeywords,C.LimitKeyword];case h.WhereKey:return[C.LabelKeys];case h.WhereComparisonOperator:return[C.ComparisonOperators];case h.WhereValue:return[C.LabelValues];case h.AfterWhereValue:return[C.LogicalOperators,C.GroupByKeywords,C.OrderByKeywords,C.LimitKeyword];case h.AfterGroupByKeywords:return[C.LabelKeys];case h.AfterGroupBy:return[C.OrderByKeywords,C.LimitKeyword];case h.AfterOrderByKeywords:return[C.FunctionsWithoutArguments];case h.AfterOrderByFunction:return[C.SortOrderDirectionKeyword,C.LimitKeyword];case h.AfterOrderByDirection:return[C.LimitKeyword]}return[]}const yr=t=>t?.getPreviousOfType(B.Keyword,b.SELECT)??null,$n=t=>{const e=yr(t)?.getNextNonWhiteSpaceToken();return e?.isVariable()||e?.isFunction()?e:null},Nt=t=>{const e=$n(t)?.next?.next;return e?.isVariable()||e?.isIdentifier()?e:null},Kn=t=>yr(t)?.getNextOfType(B.Keyword,b.FROM),Dt=t=>{const r=Kn(t)?.getNextNonWhiteSpaceToken();if(r?.isDoubleQuotedString()||r?.isVariable()&&r?.value.toUpperCase()!==b.SCHEMA)return r;if(r?.isKeyword()&&r.next?.is(B.Parenthesis,"(")){const n=r.next?.next;if(n?.isDoubleQuotedString()||n?.isVariable())return n}return null};class kn extends Ft{constructor(e,r=(0,Te.w)()){super(e,r),this.region=e.getActualRegion()??"",this.getStatementPosition=Wn,this.getSuggestionKinds=Gn,this.tokenTypes=B}setRegion(e){this.region=e}async getSuggestions(e,r,n,s,i){let a=[];const c=r?.isWhiteSpace()||r?.isParenthesis()||!r?.range?e.Range.fromPositions(i):r?.range,d=(g,m={})=>({label:g,insertText:g,kind:e.languages.CompletionItemKind.Field,range:c,sortText:se.Medium,...m});function u(g,m={}){a=[...a,d(g,m)]}for(const g of n)switch(g){case C.SelectKeyword:u(b.SELECT,{insertText:`${b.SELECT} $0`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,kind:e.languages.CompletionItemKind.Keyword,command:Z});break;case C.FunctionsWithArguments:b.STATISTICS.map(v=>u(v,{insertText:`${v}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Z,kind:e.languages.CompletionItemKind.Function}));break;case C.FunctionsWithoutArguments:b.STATISTICS.map(v=>u(v,{insertText:`${v}() `,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Z,kind:e.languages.CompletionItemKind.Function}));break;case C.Metrics:{const v=Dt(r);if(v?.value)(await this.resources.getMetrics({namespace:v?.value.replace(/\"/g,""),region:this.region})).forEach(I=>I.value&&u(I.value));else{const R=await this.resources.getAllMetrics({region:this.region});(0,te.uniq)(R.map(I=>I.metricName)).forEach(I=>I&&u(I,{insertText:I}))}}break;case C.FromKeyword:u(b.FROM,{insertText:`${b.FROM} `,command:Z});break;case C.SchemaKeyword:u(b.SCHEMA,{sortText:se.High,insertText:`${b.SCHEMA}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Z,kind:e.languages.CompletionItemKind.Function});break;case C.Namespaces:const m=Nt(r);let A=[];if(m?.value){const v=await this.resources.getMetrics({region:this.region}),R=this.templateSrv.replace(m.value);A=v.filter(I=>I.metricName===R).map(I=>I.namespace)}else A=(await this.resources.getNamespaces()).map(R=>R.value);A.map(v=>u(`"${v}"`,{insertText:`"${v}"`}));break;case C.LabelKeys:{const v=Nt(r),R=Dt(r);if(R?.value){let I={},T;s===h.SchemaFuncExtraArgument?T=R?.getNextUntil(this.tokenTypes.Parenthesis,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace]):s===h.AfterGroupByKeywords&&(T=r?.getPreviousUntil(this.tokenTypes.Keyword,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace])),I=(T||[]).reduce(($,le)=>({...$,[le.value]:null}),{}),(await this.resources.getDimensionKeys({namespace:this.templateSrv.replace(R.value.replace(/\"/g,"")),region:this.templateSrv.replace(this.region),metricName:v?.value,dimensionFilters:I},!1)).map($=>{const le=/[\s\.-]/.test($.value??"")?`"${$.value}"`:$.value;le&&u(le)})}}break;case C.LabelValues:{const v=Dt(r),R=Nt(r),I=r?.getPreviousNonWhiteSpaceToken()?.getPreviousNonWhiteSpaceToken();v?.value&&I?.value&&R?.value&&(await this.resources.getDimensionValues({region:this.region,namespace:v.value.replace(/\"/g,""),metricName:R.value,dimensionKey:I.value})).map(E=>u(`'${E.value}'`,{insertText:`'${E.value}' `,command:Z}))}break;case C.LogicalOperators:b.LOGICAL_OPERATORS.map(v=>u(`${v}`,{insertText:`${v} `,command:Z,sortText:se.MediumHigh}));break;case C.WhereKeyword:u(`${b.WHERE}`,{insertText:`${b.WHERE} `,command:Z,sortText:se.High});break;case C.ComparisonOperators:b.COMPARISON_OPERATORS.map(v=>u(`${v}`,{insertText:`${v} `,command:Z}));break;case C.GroupByKeywords:u(`${b.GROUP} ${b.BY}`,{insertText:`${b.GROUP} ${b.BY} `,command:Z,sortText:se.MediumHigh});break;case C.OrderByKeywords:u(`${b.ORDER} ${b.BY}`,{insertText:`${b.ORDER} ${b.BY} `,command:Z,sortText:se.Medium});break;case C.LimitKeyword:u(b.LIMIT,{insertText:`${b.LIMIT} `,sortText:se.MediumLow});break;case C.SortOrderDirectionKeyword:[b.ASC,b.DESC].map(v=>u(v,{insertText:`${v} `,command:Z}));break}return this.templateSrv.getVariables().map(g=>{const m=`$${g.name}`;u(m,{range:c,label:m,insertText:m,kind:e.languages.CompletionItemKind.Variable,sortText:se.Low})}),a}}var H=p(89089);const de="cloudwatch-logs",jt={id:de,extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(p.bind(p,89089))},ce={Parenthesis:`delimiter.parenthesis.${de}`,Whitespace:`white.${de}`,Keyword:`keyword.${de}`,Delimiter:`delimiter.${de}`,Operator:`operator.${de}`,Identifier:`identifier.${de}`,Type:`type.${de}`,Function:`predefined.${de}`,Number:`number.${de}`,String:`string.${de}`,Variable:`variable.${de}`,Comment:`comment.${de}`,Regexp:`regexp.${de}`},Vn=t=>{const e=t?.getPreviousNonWhiteSpaceToken(),r=t?.getNextNonWhiteSpaceToken(),n=t?.value?.toLowerCase(),s=e?.value?.toLowerCase();if(t?.is(ce.Comment))return h.Comment;if(t?.isFunction())return h.Function;if(t===null||t?.isWhiteSpace()&&e===null&&r===null||e?.is(ce.Delimiter,"|")&&t?.isWhiteSpace()||t?.isIdentifier()&&(e?.is(ce.Delimiter,"|")||e===null))return h.NewCommand;if(t?.is(ce.Delimiter,")")||t?.isWhiteSpace()&&e?.is(ce.Delimiter,")")){const a=t?.getPreviousOfType(ce.Delimiter,"(")?.getPreviousNonWhiteSpaceToken()?.value?.toLowerCase();if(a){if(H.LOGS_COMMANDS.includes(a))return h.AfterCommand;if(H.LOGS_FUNCTION_OPERATORS.includes(a))return h.AfterFunction}}if(t?.isKeyword()&&n)switch(n){case H.DEDUP:return h.DedupKeyword;case H.DISPLAY:return h.DisplayKeyword;case H.FIELDS:return h.FieldsKeyword;case H.FILTER:return h.FilterKeyword;case H.LIMIT:return h.LimitKeyword;case H.PARSE:return h.ParseKeyword;case H.STATS:return h.StatsKeyword;case H.SORT:return h.SortKeyword;case"as":return h.AsKeyword;case"by":return h.ByKeyword;case"in":return h.InKeyword;case"like":return h.LikeKeyword}if(t?.isWhiteSpace()&&e?.isKeyword&&s)switch(s){case H.DEDUP:return h.AfterDedupKeyword;case H.DISPLAY:return h.AfterDisplayKeyword;case H.FIELDS:return h.AfterFieldsKeyword;case H.FILTER:return h.AfterFilterKeyword;case H.LIMIT:return h.AfterLimitKeyword;case H.PARSE:return h.AfterParseKeyword;case H.STATS:return h.AfterStatsKeyword;case H.SORT:return h.AfterSortKeyword;case"as":return h.AfterAsKeyword;case"by":return h.AfterByKeyword;case"in":return h.AfterInKeyword;case"like":return h.AfterLikeKeyword}if(t?.is(ce.Operator)&&n){if(["+","-","*","/","^","%"].includes(n))return h.ArithmeticOperator;if(["=","!=","<",">","<=",">="].includes(n))return h.ComparisonOperator;if(H.LOGS_LOGIC_OPERATORS.includes(n))return h.BooleanOperator}if(e?.is(ce.Operator)&&s){if(["+","-","*","/","^","%"].includes(s))return h.ArithmeticOperatorArg;if(["=","!=","<",">","<=",">="].includes(s))return h.ComparisonOperatorArg;if(H.LOGS_LOGIC_OPERATORS.includes(s))return h.BooleanOperatorArg}if(t?.isIdentifier()||t?.isNumber()||t?.is(ce.Parenthesis,"()")||t?.is(ce.Delimiter,",")||t?.is(ce.Parenthesis,")")||t?.isWhiteSpace()&&e?.is(ce.Delimiter,",")||t?.isWhiteSpace()&&e?.isIdentifier()||t?.isWhiteSpace()&&e?.isKeyword()&&s&&H.LOGS_COMMANDS.includes(s)){const i=t?.getPreviousOfType(ce.Keyword),a=t?.getPreviousOfType(ce.Function);if(i!==null&&a===null)return i.value===H.SORT?h.SortArg:i.value===H.FILTER?h.FilterArg:h.CommandArg;if(a!==null&&i===null)return h.FunctionArg;if(i!==null&&a!==null){if(i.range.startLineNumber>a.range.startLineNumber||i.range.endColumn>a.range.endColumn)return i.value===H.SORT?h.SortArg:i.value===H.FILTER?h.FilterArg:h.CommandArg;if(a.range.startLineNumber>i.range.startLineNumber||a.range.endColumn>i.range.endColumn)return h.FunctionArg}}return h.Unknown};function Bn(t){switch(t){case h.NewCommand:return[C.Command];case h.AfterSortKeyword:case h.SortArg:return[C.SortOrderDirectionKeyword,C.Function];case h.AfterDisplayKeyword:case h.AfterFieldsKeyword:case h.AfterFilterKeyword:case h.AfterStatsKeyword:case h.AfterLimitKeyword:case h.AfterParseKeyword:case h.AfterDedupKeyword:case h.CommandArg:case h.FunctionArg:case h.ArithmeticOperatorArg:case h.BooleanOperatorArg:case h.ComparisonOperatorArg:return[C.Function];case h.FilterArg:return[C.InKeyword,C.Function]}return[]}function Qn(t,e=(0,Te.w)()){return r=>new Un(t,e,r)}class Un extends Ft{constructor(e,r=(0,Te.w)(),n){super(e,r),this.fetchFields=async(s,i)=>{const a=await Promise.all(s.map(l=>this.resources.getLogGroupFields({logGroupName:l.name,arn:l.arn,region:i}).then(c=>c.filter(d=>d).map(d=>d.value.name??""))));return[...new Set(a.flat())]},this.getStatementPosition=Vn,this.getSuggestionKinds=Bn,this.tokenTypes=ce,this.queryContext=n}async getSuggestions(e,r,n,s,i){const a=[],c=r?.isWhiteSpace()||r?.isParenthesis()||!r?.range?e.Range.fromPositions(i):r?.range;function d(g,m={}){return{label:g,insertText:g,kind:e.languages.CompletionItemKind.Field,range:c,sortText:se.Medium,...m}}function u(g,m={}){a.push(d(g,m))}for(const g of n)switch(g){case C.Command:H.LOGS_COMMANDS.forEach(m=>{u(m,{insertText:`${m} $0`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Z,kind:e.languages.CompletionItemKind.Method})});break;case C.Function:if(H.LOGS_FUNCTION_OPERATORS.forEach(m=>{u(m,{insertText:`${m}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Z,kind:e.languages.CompletionItemKind.Function})}),this.queryContext.logGroups&&this.queryContext.logGroups.length>0){let m=await this.fetchFields(this.queryContext.logGroups,this.queryContext.region);m.push("@log"),m.forEach(A=>{A!==""&&u(A,{range:c,label:A,insertText:A,kind:e.languages.CompletionItemKind.Field,sortText:se.High})})}break;case C.SortOrderDirectionKeyword:H.SORT_DIRECTION_KEYWORDS.forEach(m=>{u(m,{sortText:se.High,kind:e.languages.CompletionItemKind.Operator})});break;case C.InKeyword:u("in []",{insertText:'in ["$0"]',insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,kind:e.languages.CompletionItemKind.Snippet,sortText:se.High});break}return this.templateSrv.getVariables().map(g=>{const m=`$${g.name}`;u(m,{range:c,label:m,insertText:m,kind:e.languages.CompletionItemKind.Variable,sortText:se.Low})}),a}}var Je=p(74746);const _e={Parenthesis:"delimiter.parenthesis.cloudwatch-MetricMath",Whitespace:"white.cloudwatch-MetricMath",Keyword:"keyword.cloudwatch-MetricMath",Delimiter:"delimiter.cloudwatch-MetricMath",Operator:"operator.cloudwatch-MetricMath",Identifier:"identifier.cloudwatch-MetricMath",Type:"type.cloudwatch-MetricMath",Function:"predefined.cloudwatch-MetricMath",Number:"number.cloudwatch-MetricMath",String:"string.cloudwatch-MetricMath",Variable:"variable.cloudwatch-MetricMath",Comment:"comment.cloudwatch-MetricMath",Regexp:"regexp.cloudwatch-MetricMath"};function zn(t){const e=t?.getPreviousNonWhiteSpaceToken();if(t&&t.isString())return h.WithinString;if(t&&e){const r=t.getPreviousOfType(_e.Function),n=e.is(_e.Delimiter,","),s=r&&r.value==="SEARCH",i=t.getPreviousUntil(_e.Function,[],"SEARCH")||[];if(s){if(i.filter(({value:l})=>l==="'").length===1)return h.WithinString;const a=e.getPreviousOfType(_e.Delimiter,",");return a&&a.range.startColumn>r.range.startColumn&&a.range.startLineNumber>=r.range.startLineNumber?h.SearchFuncThirdArg:h.SearchFuncSecondArg}if(!s&&n)return h.PredefinedFuncSecondArg}return e?.endsWith(")")?h.AfterFunction:!t||!t.isString()?h.PredefinedFunction:h.Unknown}function Hn(t){switch(t){case h.PredefinedFunction:return[C.FunctionsWithArguments];case h.PredefinedFuncSecondArg:return[C.FunctionsWithArguments,C.KeywordArguments];case h.AfterFunction:return[C.Operators];case h.SearchFuncSecondArg:return[C.Statistic];case h.SearchFuncThirdArg:return[C.Period]}return[]}class Yn extends Ft{constructor(e,r=(0,Te.w)()){super(e,r),this.getStatementPosition=zn,this.getSuggestionKinds=Hn,this.tokenTypes=_e}async getSuggestions(e,r,n,s,i){let a=[];const c=r?.isWhiteSpace()||r?.isParenthesis()||!r?.range?e.Range.fromPositions(i):r?.range,d=(g,m={})=>({label:g,insertText:g,kind:e.languages.CompletionItemKind.Field,range:c,sortText:se.Medium,...m});function u(g,m={}){a=[...a,d(g,m)]}for(const g of n)switch(g){case C.FunctionsWithArguments:Je.METRIC_MATH_FNS.map(m=>u(m,{insertText:m==="SEARCH"?`${m}('$0')`:`${m}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Z,kind:e.languages.CompletionItemKind.Function}));break;case C.KeywordArguments:Je.METRIC_MATH_KEYWORDS.map(m=>u(m,{insertText:m,command:Z,kind:e.languages.CompletionItemKind.Keyword,sortText:se.MediumHigh}));break;case C.Statistic:Je.METRIC_MATH_STATISTIC_KEYWORD_STRINGS.map(m=>u(m,{insertText:`'${m}', `,command:Z}));break;case C.Operators:Je.METRIC_MATH_OPERATORS.map(m=>u(m,{insertText:`${m} `,command:Z}));break;case C.Period:u("$__period_auto",{kind:e.languages.CompletionItemKind.Variable,sortText:"a",detail:"Sets period dynamically to adjust to selected time range."}),Je.METRIC_MATH_PERIODS.map((m,A)=>u(m.toString(),{kind:e.languages.CompletionItemKind.Value,sortText:String.fromCharCode(97+A)}));break}return this.templateSrv.getVariables().map(g=>{const m=`$${g.name}`;u(m,{range:c,label:m,insertText:m,kind:e.languages.CompletionItemKind.Variable,sortText:se.Low})}),a}}var ct=p(26272),vr=p(17172);const xr=(t,e=7e3)=>{const r=(0,te.memoize)((...n)=>(0,te.debounce)(t,e,{leading:!0}),(...n)=>JSON.stringify(n));return(...n)=>r(...n)(...n)};class ut{constructor(e,r){this.instanceSettings=e,this.dsQueryEndpoint="/api/ds/query",this.debouncedCustomAlert=xr(Xn),this.templateSrv=r,this.ref=(0,Ve.p$)(e)}awsRequest(e,r,n={}){const s={method:"POST",url:e,data:r,headers:n};return(0,vr.AI)().fetch(s)}convertDimensionFormat(e,r,n=!0){return Object.entries(e).reduce((s,[i,a])=>{if(i=this.replaceVariableAndDisplayWarningIfMulti(i,r,n,"dimension keys"),Array.isArray(a))return{...s,[i]:a};if(!a)return{...s,[i]:null};const l=this.expandVariableToArray(a,r);return{...s,[i]:l}},{})}expandVariableToArray(e,r){const n=lt(e),s=this.templateSrv.getVariables().find(({name:i})=>i===n);return n&&s?(s?.type==="custom"||s?.type==="query"||s?.type==="datasource")&&s.multi?this.templateSrv.replace(e,r,"pipe").split("|"):[this.templateSrv.replace(e,r)]:[e]}convertMultiFilterFormat(e,r){return Object.entries(e).reduce((n,[s,i])=>{const a=this.replaceVariableAndDisplayWarningIfMulti(s,{},!0,r);if(!i)return{...n,[a]:null};const l=[],c=i.reduce((d,u)=>{const g=this.expandVariableToArray(u,{});return[...d,...g]},l);return{...n,[a]:c}},{})}isMultiVariable(e){if(e){const n=this.templateSrv.getVariables().find(({name:i})=>i===lt(e)),s=n?.type;return(s==="custom"||s==="query"||s==="datasource")&&n?.multi}return!1}isVariableWithMultipleOptionsSelected(e,r){return!e||!this.isMultiVariable(e)?!1:this.expandVariableToArray(e,r||{}).length>1}replaceVariableAndDisplayWarningIfMulti(e,r,n,s){return n&&this.isVariableWithMultipleOptionsSelected(e)&&this.debouncedCustomAlert("CloudWatch templating error",`Multi template variables are not supported for ${s||e}`),this.templateSrv.replace(e,r)}getActualRegion(e){return e==="default"||e===void 0||e===""?this.instanceSettings.jsonData.defaultRegion??"":e}getVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}}const Xn=(t,e)=>(0,x.J7)().publish({type:ct.r1.alertError.name,payload:[t,e]});class Zn extends ut{constructor(e,r){super(e,r)}handleAnnotationQuery(e,r,n){return n({...r,targets:e.map(s=>({...s,statistic:this.templateSrv.replace(s.statistic),region:this.templateSrv.replace(this.getActualRegion(s.region)),namespace:this.templateSrv.replace(s.namespace),metricName:this.templateSrv.replace(s.metricName),dimensions:this.convertDimensionFormat(s.dimensions??{},{}),period:s.period??"",actionPrefix:s.actionPrefix??"",alarmNamePrefix:s.alarmNamePrefix??"",type:"annotationQuery",datasource:this.ref}))})}}var br=p(69862),Sr=p(65474),Jn=p(95864),_n=p(31731),Ar=p(1005),qe=p(81160),qn=p(29405),es=p(43431),ts=p(59099),rs=p(46662),ns=p(69850),Pt=p(88483),Wt=p(9557),ss=p(43127);const is=p(50287),os="console.aws.amazon.com",as="console.amazonaws-us-gov.com",ls="console.amazonaws.cn";function cs(t){let e=os;return t.startsWith("us-gov-")&&(e=as),t.startsWith("cn-")&&(e=ls),`${t}.${e}`}function Ir(t,e){return`https://${cs(e)}/cloudwatch/home?region=${e}#logs-insights:queryDetail=${is.stringify(t)}`}async function us(t,e,r,n,s,i){const a=(c,d)=>r(c,e.scopedVars,!1,d),l=c=>n(c,e.scopedVars);for(const c of t.data){const d=e.targets.find(g=>g.refId===c.refId),u=s(a(d.region??"","region"));for(const g of c.fields)if(g.name==="@xrayTraceId"&&i){s(a(d.region??"","region"));const m=await ds(i,u);m&&(g.config.links=[m])}else g.config.links=[ms(d,e.range,u,a,l)]}}async function ds(t,e){let r;try{r=await(0,It.l)().get(t)}catch(n){console.error("Could not load linked xray data source, it was probably deleted after it was linked",n);return}return{title:r.name,url:"",internal:{query:{query:"${__value.raw}",queryType:"getTrace",region:e},datasourceUid:t,datasourceName:r.name}}}function ms(t,e,r,n,s){const i=(t.logGroups??[]).filter(m=>m?.arn).map(m=>(m.arn??"").replace(/:\*$/,"")),a=t.logGroupNames??[],l=i?.length?i:a,c=t.expression?n(t.expression):"",d=l?.flatMap(s),u={end:e.to.toISOString(),start:e.from.toISOString(),timeType:"ABSOLUTE",tz:"UTC",editorString:c,isLiveTail:!1,source:d};return{url:Ir(u,r),title:"View in CloudWatch console",targetBlank:!0}}function ps(t,e,r){const n=new Date;let s=0,i,a,l={data:[],errors:[]};const c=d=>Math.pow(2,d)*1e3+Math.random()*100;return new Pt.c(d=>{function u(g){a=t(g).subscribe({next(m){if(m.errors){const{refIdsForRequestsToRetry:A,errorsNotToRetry:v}=gs(m.errors);if(A.length>0&&!r(s,n.valueOf())){l.data=[...l.data,...m.data],l.errors=[...l.errors,...v],i=setTimeout(()=>{s++,u(g.filter(R=>A.includes(R.refId)))},c(s+1));return}}l.data=[...l.data,...m.data],l.errors=[...l.errors,...m.errors&&m.errors.length>0?m.errors:[]],d.next(l),d.complete()},error(m){d.error(m)}})}return u(e),()=>{clearTimeout(i),a.unsubscribe()}})}function gs(t){const e=[],r=[];return t.map(n=>{n?.message?.includes("LimitExceededException")&&n.refId?e.push(n.refId):r.push(n)}),{refIdsForRequestsToRetry:e,errorsNotToRetry:r}}var hs=p(44838);const fs=({startPeriod:t=0,endPeriod:e=5e3,step:r=1e3},n=hs.E)=>new Pt.c(s=>{const i={subscriber:s,counter:0,period:t,step:r,endPeriod:e};return s.add(n.schedule(ys,t,i)),s});function ys(t){if(!t)return;const{subscriber:e,counter:r,period:n,step:s,endPeriod:i}=t;e.next(r);const a=Math.min(n+s,i);this.schedule({subscriber:e,counter:r+1,period:a,step:s,endPeriod:i},a)}const vs="__log__grafana_internal__",xs="__logstream__grafana_internal__";class bs extends ut{constructor(e,r){super(e,r),this.logQueries={},this.createTimeoutFn=()=>{const n=new Date;return()=>Date.now()>=n.valueOf()+St.intervalToMs(this.logsTimeout)},this.handleLogQueries=(n,s,i)=>{const l=n.filter(this.filterQuery).map(d=>{const u=Mt(this.templateSrv,(d.logGroups||this.instanceSettings.jsonData.logGroups||[]).map(v=>v.arn),s.scopedVars),g=Mt(this.templateSrv,d.logGroupNames||this.instanceSettings.jsonData.defaultLogGroups||[],s.scopedVars,"text"),m=(0,te.uniq)(u).map(v=>({arn:v,name:v})),A=(0,te.uniq)(g);return{refId:d.refId,region:this.templateSrv.replace(this.getActualRegion(d.region)),queryString:this.templateSrv.replace(d.expression||"",s.scopedVars),logGroups:m,logGroupNames:A}}),c=this.createTimeoutFn();return ps(d=>this.makeLogActionRequest("StartQuery",d,i,s),l,c).pipe((0,br.Z)(d=>this.getQueryResults({logQueries:n,timeoutFunc:c,queryFn:i,startQueryResponse:d})),(0,br.Z)(d=>(0,Sr.H)((async()=>(await us(d,s,this.replaceVariableAndDisplayWarningIfMulti.bind(this),this.expandVariableToArray.bind(this),this.getActualRegion.bind(this),this.tracingDataSourceUid),d))())))},this.getLogRowContext=async(n,{limit:s=10,direction:i=Wt.ZF.Backward}={},a,l)=>{let c=null,d=null;for(const g of n.dataFrame.fields)if(g.name===xs){if(c=g,d!==null)break}else if(g.name===vs&&(d=g,c!==null))break;const u={refId:l?.refId||"A",limit:s,startFromHead:i!==Wt.ZF.Backward,region:l?.region||"",logGroupName:As(d.values[n.rowIndex]),logStreamName:c.values[n.rowIndex]};return i===Wt.ZF.Backward?u.endTime=n.timeEpochMs:u.startTime=n.timeEpochMs,await(0,mr.s)(this.makeLogActionRequest("GetLogEvents",[u],a))},this.getQueryResults=({logQueries:n,timeoutFunc:s,queryFn:i,startQueryResponse:a})=>a.data.every(l=>[y.YZ.Complete,y.YZ.Cancelled,y.YZ.Failed].includes(l.meta?.custom?.Status))?(0,Qe.of)({key:"test-key",state:Ie.Gu.Done,...a}):this.pollForLogQueryResults(a.data.map(l=>({queryId:l.fields[0].values[0],region:l.meta?.custom?.Region??"default",refId:l.refId,statsGroups:n.find(c=>c.refId===l.refId)?.statsGroups})),s,i,a.errors||[]),this.tracingDataSourceUid=e.jsonData.tracingDatasourceUid,this.logsTimeout=e.jsonData.logsTimeout||"30m"}pollForLogQueryResults(e,r,n,s){this.logQueries={},e.forEach(g=>{this.logQueries[g.refId]={id:g.queryId,region:g.region,statsQuery:(g.statsGroups?.length??0)>0}});const i=fs({startPeriod:100,endPeriod:1e3,step:300}).pipe((0,Jn.H)(g=>this.makeLogActionRequest("GetQueryResults",e,n)),(0,_n.u)(),(0,Ar.u)());let a=[];const l=i.pipe((0,qe.T)(g=>(g.errors&&(a=g.errors),g.data))),c={failures:0,prevRecordsMatched:{}},d=l.pipe((0,qn.S)(({failures:g,prevRecordsMatched:m},A)=>{g++;for(const v of A){const R=v.meta?.stats?.find(I=>I.displayName==="Records scanned")?.value;R>(m[v.refId]??0)&&(g=0),m[v.refId]=R}return{failures:g,prevRecordsMatched:m}},c),(0,qe.T)(({failures:g})=>g),(0,Ar.u)()),u=(0,es.y)(l,d).pipe((0,ts.M)(([g])=>{for(const m of g)[y.YZ.Complete,y.YZ.Cancelled,y.YZ.Failed].includes(m.meta?.custom?.Status)&&this.logQueries.hasOwnProperty(m.refId)&&delete this.logQueries[m.refId]}),(0,qe.T)(([g,m])=>{const A=[...s,...a];if(r())for(const v of g)(0,te.set)(v,"meta.custom.Status",y.YZ.Cancelled),A.push({message:`Error: Query hit timeout before completing after ${m} attempts, partial results may be shown. To increase the timeout window update your datasource configuration.`,type:P.v2.Timeout,refId:v.refId});return{data:g,key:"test-key",state:g.every(v=>[y.YZ.Complete,y.YZ.Cancelled,y.YZ.Failed].includes(v.meta?.custom?.Status))?Ie.Gu.Done:Ie.Gu.Loading,errors:A}}),(0,rs.v)(({state:g})=>g!==Ie.Gu.Error&&g!==Ie.Gu.Done,!0));return Ss(u,()=>this.stopQueries(n))}stopQueries(e){Object.keys(this.logQueries).length>0&&this.makeLogActionRequest("StopQuery",Object.values(this.logQueries).map(r=>({queryId:r.id,region:r.region,queryString:"",refId:""})),e).pipe((0,ns.j)(()=>{this.logQueries={}}))}makeLogActionRequest(e,r,n,s){const i=s?.range||(0,ss.E2)(),a={...s,range:i,skipQueryCache:!0,requestId:s?.requestId||"",interval:s?.interval||"",intervalMs:s?.intervalMs||1,scopedVars:s?.scopedVars||{},timezone:s?.timezone||"",app:s?.app||"",startTime:s?.startTime||0,targets:r.map(l=>({...l,id:"",queryMode:"Logs",refId:l.refId||"A",intervalMs:1,maxDataPoints:1,datasource:this.ref,type:"logAction",subtype:e}))};return n(a)}filterQuery(e){const r=!e.logGroupNames?.length,n=!e.logGroups?.length,s=!e.expression?.length;return!(n&&r||s)}}function Ss(t,e){return new Pt.c(r=>{const n=t.subscribe({next:s=>r.next(s),error:s=>r.next(s),complete:()=>r.complete()});return()=>{n.unsubscribe(),e()}})}function As(t){const e=t.lastIndexOf(":");return t.slice(e+1)}var Is=p(66847),Ts=p(72724),Cs=p(11261);const Es=({region:t})=>(0,o.jsxs)("p",{children:["Please visit the\xA0",(0,o.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:`https://${t}.console.aws.amazon.com/servicequotas/home?region=${t}#!/services/monitoring/quotas/L-5E141212`,children:"AWS Service Quotas console"}),"\xA0to request a quota increase or see our\xA0",(0,o.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:"https://grafana.com/docs/grafana/latest/datasources/cloudwatch/#manage-service-quotas",children:"documentation"}),"\xA0to learn more."]});var ws=p(32017),Rs=p.n(ws);function Gt(t){const e=Os(t);return Rs()(e,t)?t:e}const Tr={metric:"PROP('MetricName')",namespace:"PROP('Namespace')",period:"PROP('Period')",region:"PROP('Region')",stat:"PROP('Stat')",label:"LABEL"};function Os(t){if(!t.hasOwnProperty("label")){const e={...t};if(!t.hasOwnProperty("label")){const r=/{{\s*(.+?)\s*}}/g;e.label=t.alias?.replace(r,(n,s)=>Tr.hasOwnProperty(s)?`\${${Tr[s]}}`:`\${PROP('Dim.${s}')}`)??""}return e}return t}const Ls=(t,e)=>`Please visit the AWS Service Quotas console at https://${t}.console.aws.amazon.com/servicequotas/home?region=${t}#!/services/monitoring/quotas/L-5E141212 to request a quota increase or see our documentation at https://grafana.com/docs/grafana/latest/datasources/cloudwatch/#manage-service-quotas to learn more. ${e}`,Ms=(t,e)=>(0,x.J7)().publish({type:ct.r1.alertError.name,payload:[`CloudWatch request limit reached in ${e} for data source ${t}`,"",void 0,(0,f.createElement)(Es,{region:e},null)]});class Fs extends ut{constructor(e,r){super(e,r),this.debouncedThrottlingAlert=xr(Ms),this.handleMetricQueries=(n,s,i)=>{const a=(0,Ts.LE)(Date.now(),{timeZone:s.timezone,format:"Z"}).replace(":",""),l=n.filter(this.filterMetricQuery).map(d=>{const u=Gt(d),g=this.replaceMetricQueryVars(u,s.scopedVars);return{timezoneUTCOffset:a,intervalMs:s.intervalMs,maxDataPoints:s.maxDataPoints,...g,type:"timeSeriesQuery",datasource:this.ref}});if((0,te.isEmpty)(l))return(0,Qe.of)({data:[]});const c={...s,targets:l};return this.performTimeSeriesQuery(c,i)}}interpolateMetricsQueryVariables(e,r){return{alias:this.replaceVariableAndDisplayWarningIfMulti(e.alias,r),metricName:this.replaceVariableAndDisplayWarningIfMulti(e.metricName,r),namespace:this.replaceVariableAndDisplayWarningIfMulti(e.namespace,r),period:this.replaceVariableAndDisplayWarningIfMulti(e.period,r),expression:this.templateSrv.replace(e.expression,r),sqlExpression:this.replaceVariableAndDisplayWarningIfMulti(e.sqlExpression,r),dimensions:this.convertDimensionFormat(e.dimensions??{},r)}}performTimeSeriesQuery(e,r){return r(e).pipe((0,qe.T)(n=>{const s=n.data||[];return s.forEach(i=>{i.fields.forEach(a=>{a.type===Cs.PU.time&&(a.config.interval=i.meta?.custom?.period*1e3)})}),n.errors?.length&&this.alertOnThrottlingErrors(n.errors,e),{data:s,errors:this.enrichThrottlingErrorMessages(e,n.errors)}}),(0,Is.W)(n=>Array.isArray(n)?(0,Qe.of)({data:[],errors:n}):(0,Qe.of)({data:[],errors:[{message:n}]})))}enrichThrottlingErrorMessages(e,r){if(!r||r.length===0)return r;const n=[];return r.forEach(s=>{if(s.message&&(/^Throttling:.*/.test(s.message)||/^Rate exceeded.*/.test(s.message))){const i=this.getActualRegion(e.targets.find(a=>a.refId===s.refId)?.region);n.push({...s,message:Ls(i,s.message)})}else n.push(s)}),n}alertOnThrottlingErrors(e,r){if(e.some(s=>s.message&&(/^Throttling:.*/.test(s.message)||/^Rate exceeded.*/.test(s.message)))){const s=e.map(i=>i.refId).filter(i=>i);s.length>0&&Object.values(r.targets).reduce((a,{refId:l,region:c})=>l&&!s.includes(l)||a.includes(c)?a:[...a,c],[]).forEach(a=>{const l=this.getActualRegion(a);l&&this.debouncedThrottlingAlert(this.instanceSettings.name,l)})}}filterMetricQuery(e){return ir(e)}replaceMetricQueryVars(e,r){return e.region=this.templateSrv.replace(this.getActualRegion(e.region),r),e.namespace=this.replaceVariableAndDisplayWarningIfMulti(e.namespace,r,!0,"namespace"),e.metricName=this.replaceVariableAndDisplayWarningIfMulti(e.metricName,r,!0,"metric name"),e.dimensions=this.convertDimensionFormat(e.dimensions??{},r),e.statistic=this.templateSrv.replace(e.statistic,r),e.period=String(this.getPeriod(e,r)),e.id=this.templateSrv.replace(e.id,r),e.expression=this.templateSrv.replace(e.expression,r),e.sqlExpression=this.templateSrv.replace(e.sqlExpression,r,"raw"),e.accountId&&(e.accountId=this.templateSrv.replace(e.accountId,r)),e}getPeriod(e,r){let n=this.templateSrv.replace(e.period,r);if(n&&n.toLowerCase()!=="auto"){let s;return/^\d+$/.test(n)?s=parseInt(n,10):s=St.intervalToSeconds(n),s<1&&(s=1),String(s)}return n}}class Ns extends ut{constructor(e,r){super(e,r),this.memoizedGetRequest=(0,te.memoize)(this.getRequest.bind(this),(n,s)=>JSON.stringify({path:n,parameters:s}))}getRequest(e,r){return(0,vr.AI)().get(`/api/datasources/${this.instanceSettings.id}/resources/${e}`,r)}async getExternalId(){return await this.memoizedGetRequest("external-id").then(({externalId:e})=>e)}getAccounts({region:e}){return this.memoizedGetRequest("accounts",{region:this.templateSrv.replace(this.getActualRegion(e))}).then(r=>r.map(n=>n.value))}isMonitoringAccount(e){return this.getAccounts({region:e}).then(r=>r.some(n=>n.isMonitoringAccount)).catch(()=>!1)}getRegions(){return this.memoizedGetRequest("regions").then(e=>[{label:"default",value:"default",text:"default"},...e.map(r=>({label:r.value.name,value:r.value.name,text:r.value.name}))].filter(r=>r.value))}getNamespaces(){return this.memoizedGetRequest("namespaces").then(e=>e.map(r=>({label:r.value,value:r.value})))}getLogGroups(e){return this.memoizedGetRequest("log-groups",{...e,region:this.templateSrv.replace(this.getActualRegion(e.region)),accountId:this.templateSrv.replace(e.accountId),listAllLogGroups:e.listAllLogGroups?"true":"false"})}getLogGroupFields({region:e,arn:r,logGroupName:n}){return this.memoizedGetRequest("log-group-fields",{region:this.templateSrv.replace(this.getActualRegion(e)),logGroupName:this.templateSrv.replace(n,{}),logGroupArn:this.templateSrv.replace(r)})}getMetrics({region:e,namespace:r,accountId:n}){return r?this.memoizedGetRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(r),accountId:this.templateSrv.replace(n)}).then(s=>s.map(i=>({label:i.value.name,value:i.value.name}))):Promise.resolve([])}getAllMetrics({region:e,accountId:r}){return this.memoizedGetRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(e)),accountId:this.templateSrv.replace(r)}).then(n=>n.map(s=>({metricName:s.value.name,namespace:s.value.namespace})))}getDimensionKeys({region:e,namespace:r="",dimensionFilters:n={},metricName:s="",accountId:i},a){return this.memoizedGetRequest("dimension-keys",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(r),accountId:this.templateSrv.replace(i),metricName:this.templateSrv.replace(s),dimensionFilters:JSON.stringify(this.convertDimensionFormat(n,{},a))}).then(l=>l.map(c=>({label:c.value,value:c.value})))}getDimensionValues({dimensionKey:e,region:r,namespace:n,dimensionFilters:s={},metricName:i="",accountId:a}){return!n||!i?Promise.resolve([]):this.memoizedGetRequest("dimension-values",{region:this.templateSrv.replace(this.getActualRegion(r)),namespace:this.templateSrv.replace(n),metricName:this.templateSrv.replace(i.trim()),dimensionKey:this.replaceVariableAndDisplayWarningIfMulti(e,{},!0),dimensionFilters:JSON.stringify(this.convertDimensionFormat(s,{})),accountId:this.templateSrv.replace(a)}).then(l=>l.map(c=>({label:c.value,value:c.value})))}getEbsVolumeIds(e,r){return this.memoizedGetRequest("ebs-volume-ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(r)})}getEc2InstanceAttribute(e,r,n){return this.memoizedGetRequest("ec2-instance-attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(r),filters:JSON.stringify(this.convertMultiFilterFormat(n,"filter key"))})}getResourceARNs(e,r,n){return this.memoizedGetRequest("resource-arns",{region:this.templateSrv.replace(this.getActualRegion(e)),resourceType:this.templateSrv.replace(r),tags:JSON.stringify(this.convertMultiFilterFormat(n,"tag name"))})}legacyDescribeLogGroups(e,r){return this.memoizedGetRequest("legacy-log-groups",{region:this.templateSrv.replace(this.getActualRegion(e)),logGroupNamePrefix:r||""})}}var Ds=p(29505);const $t=/\${(\w+):json}/g;function js(t){return typeof t!="string"&&typeof t.ec2Filters!="string"&&typeof t.tags!="string"}function dt(t){const e=t.replace($t,'"$$$1"'),r=JSON.parse(e),n={};return Object.keys(r).forEach(s=>{const i=r[s];typeof i=="string"?n[s]=[i]:i!==void 0&&(n[s]=i)}),n}function Cr(t){if(js(t))return t;if(typeof t!="string"){const d=(0,te.omit)(t,["dimensionFilters","ec2Filters","tags"]);if(d.dimensionFilters={},d.ec2Filters={},d.tags={},t.dimensionFilters!==""&&t.ec2Filters!=="[]"){const u=t.dimensionFilters.replace($t,'"$$$1"');try{d.dimensionFilters=JSON.parse(u)}catch{throw new Error(`unable to migrate poorly formed filters: ${t.dimensionFilters}`)}}if(t.ec2Filters!==""&&t.ec2Filters!=="[]")try{d.ec2Filters=dt(t.ec2Filters)}catch{throw new Error(`unable to migrate poorly formed filters: ${t.ec2Filters}`)}if(t.tags!==""&&t.tags!=="[]")try{d.tags=dt(t.tags)}catch{throw new Error(`unable to migrate poorly formed filters: ${t.tags}`)}return d}const e={refId:"CloudWatchVariableQueryEditor-VariableQuery",queryType:y.b4.Regions,namespace:"",region:"",metricName:"",dimensionKey:"",dimensionFilters:{},ec2Filters:{},instanceID:"",attributeName:"",resourceType:"",tags:{}};if(t===""||t.match(/^regions\(\)/))return e;if(t.match(/^namespaces\(\)/))return e.queryType=y.b4.Namespaces,e;const r=t.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(r)return e.queryType=y.b4.Metrics,e.namespace=r[1],e.region=r[3]||"",e;const n=t.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(n)return e.queryType=y.b4.DimensionKeys,e.namespace=n[1],e.region=n[3]||"",e;const s=t.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(s){if(e.queryType=y.b4.DimensionValues,e.region=s[1],e.namespace=s[2],e.metricName=s[3],e.dimensionKey=s[4],e.dimensionFilters={},s[6]&&s[6]!=="[]"){const d=s[6].replace($t,'"$$$1"');try{e.dimensionFilters=JSON.parse(d)}catch{throw new Error(`unable to migrate poorly formed filters: ${s[6]}`)}}return e}const i=t.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(i)return e.queryType=y.b4.EBSVolumeIDs,e.region=i[1],e.instanceID=i[2],e;const a=t.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(a){if(e.queryType=y.b4.EC2InstanceAttributes,e.region=a[1],e.attributeName=a[2],a[3]&&a[3]!=="[]")try{e.ec2Filters=dt(a[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${a[3]}`)}return e}const l=t.match(/^resource_arns\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(l){if(e.queryType=y.b4.ResourceArns,e.region=l[1],e.resourceType=l[2],l[3]&&l[3]!=="[]")try{e.tags=dt(l[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${l[3]}`)}return e}if(t.match(/^statistics\(\)/))return e.queryType=y.b4.Statistics,e;throw new Error("unable to parse old variable query")}const Ps=({filter:t,onChange:e,onDelete:r,keyPlaceholder:n,datasource:s})=>{const[i,a]=(0,f.useState)(t.key||""),[l,c]=(0,f.useState)(t.value?.join(", ")||""),d=Ye(s,t.key),u=(0,he.of)(Ws);return(0,o.jsxs)("div",{"data-testid":"cloudwatch-multifilter-item",children:[(0,o.jsxs)(Xe.M,{children:[(0,o.jsx)(pe.p,{"data-testid":"cloudwatch-multifilter-item-key","aria-label":"Filter key",value:i,placeholder:n??"key",onChange:g=>a(g.currentTarget.value),onBlur:()=>{i&&i!==t.key&&e({...t,key:i})}}),(0,o.jsx)("span",{className:(0,S.cx)(u.root),children:"="}),(0,o.jsx)(pe.p,{"data-testid":"cloudwatch-multifilter-item-value","aria-label":"Filter value",value:l,placeholder:"value1, value2,...",onChange:g=>c(g.currentTarget.value),onBlur:()=>{const g=l.split(",").map(m=>m.trim());l&&g!==t.value&&e({...t,value:g}),c(g.join(", "))}}),(0,o.jsx)(Ze.Z,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:r,type:"button"})]}),d&&(0,o.jsx)(xe.F,{title:d,severity:"error",topSpacing:1})]})},Ws=t=>({root:(0,S.css)({padding:t.spacing(0,1),alignSelf:"center"})}),Gs=t=>Object.keys(t).map(e=>({key:e,value:t[e],operator:"="})),$s=t=>{const e={};return t.forEach(({key:r,value:n})=>{r&&n&&(e[r]=n)}),e},Er=({filters:t,onChange:e,keyPlaceholder:r,datasource:n})=>{const[s,i]=(0,f.useState)([]);(0,f.useEffect)(()=>i(t?Gs(t):[]),[t]);const a=l=>{i(l);const c=$s(l);(0,te.isEqual)(c,t)||e(c)};return(0,o.jsx)(at.o,{items:s,onChange:a,renderItem:Ks(n,r)})};function Ks(t,e){function r(n,s,i){return(0,o.jsx)(Ps,{filter:n,onChange:a=>s(a),onDelete:i,keyPlaceholder:e,datasource:t})}return r}const ks=t=>({table:(0,S.css)({width:"100%",tableLayout:"fixed"}),selectedLogGroupsContainer:(0,S.css)({marginLeft:t.spacing(.5),marginBottom:t.spacing(.5),display:"flex",flexFlow:"wrap",gap:t.spacing(1),button:{margin:"unset"}}),limitLabel:(0,S.css)({color:t.colors.text.secondary,textAlign:"center",maxWidth:"none",svg:{marginRight:t.spacing(.5)},fontSize:12}),logGroupCountLabel:(0,S.css)({color:t.colors.text.secondary,maxWidth:"none"}),tableScroller:(0,S.css)({maxHeight:"40vh",overflow:"auto"}),row:(0,S.css)({borderBottom:`1px solid ${t.colors.border.weak}`,"&:last-of-type":{borderBottomColor:t.colors.border.medium}}),cell:(0,S.css)({padding:t.spacing(1,1,1,0),width:"25%","&:first-of-type":{width:"80%",padding:t.spacing(1,1,1,2)}}),nestedEntry:(0,S.css)({display:"flex",alignItems:"center"}),logGroupSearchResults:(0,S.css)({overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"90%",verticalAlign:"middle"}),modal:(0,S.css)({width:t.breakpoints.values.lg}),selectAccountId:(0,S.css)({maxWidth:"100px"}),logGroupSelectionArea:(0,S.css)({display:"flex"}),searchField:(0,S.css)({width:"100%",marginRight:t.spacing(1)}),resultLimit:(0,S.css)({margin:"4px 0",fontStyle:"italic"}),removeButton:(0,S.css)({verticalAlign:"middle",marginLeft:t.spacing(.5)})}),wr=(0,S.css)({marginBottom:8}),Rr=ks,Ge=({label:t,onChange:e,value:r,options:n,allowCustomValue:s=!1,isLoading:i=!1,inputId:a=t,error:l})=>(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(U.c,{label:t,htmlFor:a,className:wr,children:(0,o.jsx)(ne.l6,{"aria-label":t,allowCustomValue:s,value:r,onChange:({value:c})=>e(c),options:n,isLoading:i,inputId:a})}),l&&(0,o.jsx)(xe.F,{title:l,severity:"error",topSpacing:1})]}),mt=({interactive:t,label:e,onBlur:r,placeholder:n,value:s,tooltip:i})=>{const[a,l]=(0,f.useState)(s);return(0,o.jsx)(U.c,{label:e,tooltip:i,tooltipInteractive:t,className:wr,children:(0,o.jsx)(pe.p,{"aria-label":e,placeholder:n,value:a,onChange:c=>l(c.currentTarget.value),onBlur:()=>r(a)})})},Vs=[{value:y.b4.Regions,label:"Regions"},{value:y.b4.Namespaces,label:"Namespaces"},{value:y.b4.Metrics,label:"Metrics"},{value:y.b4.DimensionKeys,label:"Dimension Keys"},{value:y.b4.DimensionValues,label:"Dimension Values"},{value:y.b4.EBSVolumeIDs,label:"EBS Volume IDs"},{value:y.b4.EC2InstanceAttributes,label:"EC2 Instance Attributes"},{value:y.b4.ResourceArns,label:"Resource ARNs"},{value:y.b4.Statistics,label:"Statistics"},{value:y.b4.LogGroups,label:"Log Groups"},...q.$.featureToggles.cloudWatchCrossAccountQuerying?[{value:y.b4.Accounts,label:"Accounts"}]:[]],Bs=({query:t,datasource:e,onChange:r})=>{const n=Cr(t),{region:s,namespace:i,metricName:a,dimensionKey:l}=n,[c,d]=Et(e),u=wt(e),g=Rt(e,{region:s,namespace:i}),m=He(e,{region:s,namespace:i,metricName:a}),A=st(e.resources,t.region),v=Ye(e,l),R=async j=>{const ye=await E({...n,region:j,accountId:void 0});T(ye)},I=async j=>{const ye=await E({...n,namespace:j});T(ye)},T=j=>{r({...j,refId:"CloudWatchVariableQueryEditor-VariableQuery"})},E=async j=>{let{metricName:ye,dimensionKey:Re,dimensionFilters:ft,namespace:yt,region:vt}=j;return ye&&await e.resources.getMetrics({namespace:yt,region:vt}).then(N=>{N.find(ie=>ie.value===ye)||(ye="")}),Re&&await e.resources.getDimensionKeys({namespace:yt,region:vt}).then(N=>{N.find(ie=>ie.value===Re)||(Re="",ft={})}),{...j,metricName:ye,dimensionKey:Re,dimensionFilters:ft}},$=[y.b4.Metrics,y.b4.DimensionKeys,y.b4.DimensionValues,y.b4.EBSVolumeIDs,y.b4.EC2InstanceAttributes,y.b4.ResourceArns,y.b4.LogGroups,y.b4.Accounts].includes(n.queryType),le=[y.b4.Metrics,y.b4.DimensionKeys,y.b4.DimensionValues,y.b4.LogGroups].includes(n.queryType),Se=[y.b4.Metrics,y.b4.DimensionKeys,y.b4.DimensionValues].includes(n.queryType),$e=(0,he.of)(Qs);return(0,o.jsxs)("div",{className:$e.formStyles,children:[(0,o.jsx)(Ge,{value:n.queryType,options:Vs,onChange:j=>T({...n,queryType:j,accountId:void 0}),label:"Query type",inputId:`variable-query-type-${t.refId}`}),$&&(0,o.jsx)(Ge,{value:s,options:c,onChange:j=>R(j),label:"Region",isLoading:d,inputId:`variable-query-region-${t.refId}`}),le&&A.value&&A.value?.length>0&&q.$.featureToggles.cloudWatchCrossAccountQuerying&&(0,o.jsx)(Ge,{label:"Account",value:t.accountId??null,onChange:j=>T({...n,accountId:j}),options:[Pe,...A?.value],allowCustomValue:!1}),Se&&(0,o.jsx)(Ge,{value:i,options:u,onChange:j=>I(j),label:"Namespace",inputId:`variable-query-namespace-${t.refId}`,allowCustomValue:!0}),n.queryType===y.b4.DimensionValues&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ge,{value:a||null,options:g,onChange:j=>T({...n,metricName:j}),label:"Metric",inputId:`variable-query-metric-${t.refId}`,allowCustomValue:!0}),(0,o.jsx)(Ge,{value:l||null,options:m,onChange:j=>T({...n,dimensionKey:j}),label:"Dimension key",inputId:`variable-query-dimension-key-${t.refId}`,allowCustomValue:!0,error:v}),(0,o.jsx)(U.c,{label:"Dimensions",className:$e.dimensionsWidth,tooltip:"Dimensions to filter the returned values on",children:(0,o.jsx)(cr,{metricStat:{...n,dimensions:n.dimensionFilters},onChange:j=>{r({...n,dimensionFilters:j})},disableExpressions:!0,datasource:e})})]}),n.queryType===y.b4.EBSVolumeIDs&&(0,o.jsx)(mt,{value:t.instanceID,placeholder:"i-XXXXXXXXXXXXXXXXX",onBlur:j=>T({...n,instanceID:j}),label:"Instance ID"}),n.queryType===y.b4.EC2InstanceAttributes&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(mt,{value:n.attributeName,onBlur:j=>T({...n,attributeName:j}),label:"Attribute name",interactive:!0,tooltip:(0,o.jsxs)(o.Fragment,{children:['Attribute or tag to query on. Tags should be formatted "Tags.<name>". ',(0,o.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"See the documentation for more details"})]})}),(0,o.jsx)(U.c,{label:"Filters",tooltipInteractive:!0,tooltip:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"Pre-defined ec2:DescribeInstances filters/tags"})," and the values to filter on. Tags should be formatted tag:<name>."]}),children:(0,o.jsx)(Er,{filters:n.ec2Filters??{},onChange:j=>{r({...n,ec2Filters:j})},keyPlaceholder:"filter/tag",datasource:e})})]}),n.queryType===y.b4.ResourceArns&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(mt,{value:n.resourceType,onBlur:j=>T({...n,resourceType:j}),label:"Resource type"}),(0,o.jsx)(U.c,{label:"Tags",tooltip:"Tags to filter the returned values on.",children:(0,o.jsx)(Er,{filters:n.tags,onChange:j=>{r({...n,tags:j})},keyPlaceholder:"tag",datasource:e})})]}),n.queryType===y.b4.LogGroups&&(0,o.jsx)(mt,{value:t.logGroupPrefix??"",onBlur:j=>T({...n,logGroupPrefix:j}),label:"Log group prefix"})]})},Qs=t=>({formStyles:(0,S.css)({maxWidth:t.spacing(30)}),dimensionsWidth:(0,S.css)({width:t.spacing(50)})});class Us extends Ds.f5{constructor(e){super(),this.resources=e,this.editor=Bs,this.allMetricFindValue={text:"All",value:Pe.value,expandable:!0}}query(e){const r=Cr(e.targets[0]);return(0,Sr.H)(this.execute(r)).pipe((0,qe.T)(n=>({data:n})))}async execute(e){try{switch(e.queryType){case y.b4.Regions:return this.handleRegionsQuery();case y.b4.Namespaces:return this.handleNamespacesQuery();case y.b4.Metrics:return this.handleMetricsQuery(e);case y.b4.DimensionKeys:return this.handleDimensionKeysQuery(e);case y.b4.DimensionValues:return this.handleDimensionValuesQuery(e);case y.b4.EBSVolumeIDs:return this.handleEbsVolumeIdsQuery(e);case y.b4.EC2InstanceAttributes:return this.handleEc2InstanceAttributeQuery(e);case y.b4.ResourceArns:return this.handleResourceARNsQuery(e);case y.b4.Statistics:return this.handleStatisticsQuery();case y.b4.LogGroups:return this.handleLogGroupsQuery(e);case y.b4.Accounts:return this.handleAccountsQuery(e)}}catch(r){return console.error(`Could not run CloudWatchMetricFindQuery ${e}`,r),[]}}async handleLogGroupsQuery({region:e,logGroupPrefix:r,accountId:n}){const s=this.resources.templateSrv.replace(r);return this.resources.getLogGroups({accountId:n,region:e,logGroupNamePrefix:s,listAllLogGroups:!0}).then(i=>i.map(a=>({text:a.value.name,value:a.value.arn,expandable:!0})))}async handleRegionsQuery(){return this.resources.getRegions().then(e=>e.map(we))}async handleNamespacesQuery(){return this.resources.getNamespaces().then(e=>e.map(we))}async handleMetricsQuery({namespace:e,region:r,accountId:n}){return this.resources.getMetrics({namespace:e,region:r,accountId:n}).then(s=>s.map(we))}async handleDimensionKeysQuery({namespace:e,region:r,accountId:n}){return this.resources.getDimensionKeys({namespace:e,region:r,accountId:n}).then(s=>s.map(we))}async handleDimensionValuesQuery({namespace:e,accountId:r,region:n,dimensionKey:s,metricName:i,dimensionFilters:a}){return!s||!i?[]:this.resources.getDimensionValues({region:n,accountId:r,namespace:e,metricName:i,dimensionKey:s,dimensionFilters:a}).then(l=>l.map(we))}async handleEbsVolumeIdsQuery({region:e,instanceID:r}){return r?this.resources.getEbsVolumeIds(e,r).then(n=>n.map(we)):[]}async handleEc2InstanceAttributeQuery({region:e,attributeName:r,ec2Filters:n}){return r?this.resources.getEc2InstanceAttribute(e,r,n??{}).then(s=>s.map(we)):[]}async handleResourceARNsQuery({region:e,resourceType:r,tags:n}){return r?(await this.resources.getResourceARNs(e,r,n??{})).map(we):[]}async handleStatisticsQuery(){return ot.map(e=>({text:e,value:e,expandable:!0}))}async handleAccountsQuery({region:e}){return this.resources.getAccounts({region:e}).then(r=>{const n=r.map(s=>({text:s.label,value:s.id,expandable:!0}));return n.length?[this.allMetricFindValue,...n]:[]})}getDefaultQuery(){return En}}function we({label:t,value:e}){return{text:t??e??"",value:e,expandable:!0}}class Or extends dn.iy{constructor(e,r=(0,Te.w)()){super(e),this.instanceSettings=e,this.templateSrv=r,this.type="cloudwatch",this.defaultRegion=e.jsonData.defaultRegion,this.resources=new Ns(e,r),this.languageProvider=new Ln(this),this.sqlCompletionItemProvider=new kn(this.resources,this.templateSrv),this.metricMathCompletionItemProvider=new Yn(this.resources,this.templateSrv),this.metricsQueryRunner=new Fs(e,r),this.logsCompletionItemProviderFunc=Qn(this.resources,this.templateSrv),this.logsQueryRunner=new bs(e,r),this.annotationQueryRunner=new Zn(e,r),this.variables=new Us(this.resources),this.annotations=wn,this.defaultLogGroups=e.jsonData.defaultLogGroups}filterQuery(e){return e.hide!==!0||Le(e)&&e.id!==""}query(e){e=(0,te.cloneDeep)(e);let r=e.targets.filter(this.filterQuery);const n=[],s=[],i=[];r.forEach(l=>{sr(l)?i.push(l):Ue(l)?n.push(l):s.push(l)});const a=[];return n.length&&a.push(this.logsQueryRunner.handleLogQueries(n,e,super.query.bind(this))),s.length&&a.push(this.metricsQueryRunner.handleMetricQueries(s,e,super.query.bind(this))),i.length&&a.push(this.annotationQueryRunner.handleAnnotationQuery(i,e,super.query.bind(this))),(0,te.isEmpty)(a)?(0,Qe.of)({data:[],state:Ie.Gu.Done}):(0,un.h)(...a)}interpolateVariablesInQueries(e,r){return e.length?e.map(n=>({...n,region:this.metricsQueryRunner.replaceVariableAndDisplayWarningIfMulti(this.getActualRegion(n.region),r),...Le(n)&&this.metricsQueryRunner.interpolateMetricsQueryVariables(n,r)})):e}getLogRowContext(e,r,n){return this.logsQueryRunner.getLogRowContext(e,r,super.query.bind(this),n)}targetContainsTemplate(e){return this.templateSrv.containsTemplate(e.region)||this.templateSrv.containsTemplate(e.namespace)||this.templateSrv.containsTemplate(e.metricName)||this.templateSrv.containsTemplate(e.expression)||e.logGroupNames?.some(r=>this.templateSrv.containsTemplate(r))||(0,te.find)(e.dimensions,(r,n)=>this.templateSrv.containsTemplate(n)||this.templateSrv.containsTemplate(r))}getQueryDisplayText(e){return Ue(e)?e.expression??"":JSON.stringify(e)}getVariables(){return this.resources.getVariables()}getActualRegion(e){return e==="default"||e===void 0||e===""?this.defaultRegion??"":e}getDefaultQuery(e){return{...Cn(this.instanceSettings.jsonData.logGroups,this.instanceSettings.jsonData.defaultLogGroups),...dr}}}const zs=20,Hs=4,Ys=300,Xs=({region:t,selectedLogGroups:e,onChange:r,datasource:n,onOpenMenu:s,width:i,saved:a=!0})=>{const[l,c]=(0,f.useState)(!1),[d,u]=(0,f.useState)([]),g=(0,f.useMemo)(()=>(0,te.unionBy)(d,e?.map(re.z),"value"),[d,e]),m=(0,f.useCallback)(async(I,T)=>{if(!n)return[];try{return await n.resources.legacyDescribeLogGroups(I,T)}catch(E){return(0,x.J7)().publish({type:ct.r1.alertError.name,payload:[typeof E=="string"?E:JSON.stringify(E)]}),[]}},[n]),A=async(I,T,E)=>{if(E.action!=="input-change"||!n)return;if(!/^[\.\-_/#A-Za-z0-9]+$/.test(I)){I!==""&&(0,x.J7)().publish({type:ct.r1.alertError.name,payload:["Invalid Log Group name: "+I]});return}c(!0);const le=await m(T,I);u((0,te.unionBy)(d,le,"value")),c(!1)};(0,f.useEffect)(()=>{async function I(){if(!n||!n.getActualRegion(t)){u([]);return}return c(!0),m(n.getActualRegion(t)).then(T=>{u(T)}).finally(()=>{c(!1)})}return a&&I(),()=>{u([]),c(!1)}},[n,t,a]);const v=async()=>{s&&await s()},R=(0,te.debounce)(A,Ys);return(0,o.jsx)(ne.KF,{inputId:"default-log-groups","aria-label":"Log Groups",allowCustomValue:!0,options:n?fe(n,g):g,value:e,onChange:I=>r(I.filter(({value:T})=>T).map(({value:T})=>T)),closeMenuOnSelect:!1,isClearable:!0,isOptionDisabled:()=>e.length>=zs,placeholder:"Choose Log Groups",maxVisibleValues:Hs,noOptionsMessage:"No log groups available",isLoading:l,onOpenMenu:v,onInputChange:(I,T)=>{R(I,t,T)},width:i})},Zs=(0,S.css)`
  gap: 3px;
`,Js=({datasource:t,region:e,legacyLogGroupNames:r,onChange:n})=>(0,o.jsx)("div",{className:`gf-form gf-form--grow flex-grow-1 ${Zs}`,children:(0,o.jsx)(Xs,{region:e,selectedLogGroups:r,datasource:t,onChange:n})});var Lr=p(37390),Kt=p(14578),_s=p(39558),qs=p(10880),ei=p(60029),Fe=p(55852);const ti=({searchFn:t,searchPhrase:e})=>{const[r,n]=(0,f.useState)(e),s=(0,f.useMemo)(()=>(0,te.debounce)(t,600),[t]);return(0,f.useEffect)(()=>()=>{s?.cancel()},[s]),(0,o.jsx)(pe.p,{"aria-label":"log group search",prefix:(0,o.jsx)(Kt.I,{name:"search"}),value:r,onChange:i=>{const a=i.currentTarget.value;n(a),s(a)},placeholder:"search by log group name prefix"})},ri=({accountOptions:t=[],variables:e=[],fetchLogGroups:r,onChange:n,onBeforeOpen:s,...i})=>{const[a,l]=(0,f.useState)(!1),[c,d]=(0,f.useState)([]),[u,g]=(0,f.useState)(i.selectedLogGroups??[]),[m,A]=(0,f.useState)(""),[v,R]=(0,f.useState)(Pe.value),[I,T]=(0,f.useState)(!1),E=(0,he.of)(Rr),$=(0,f.useMemo)(()=>u.filter(N=>!N.name?.startsWith("$")).length,[u]),le=(0,f.useMemo)(()=>e.map(N=>({label:N,value:N})),[e]),Se=(0,f.useMemo)(()=>u.find(N=>N.name?.startsWith("$"))?.name,[u]),$e={label:Se,value:Se};(0,f.useEffect)(()=>{g(i.selectedLogGroups??[])},[i.selectedLogGroups]);const j=()=>{l(!a),a||(g(u),Re(m,v))},ye=(0,f.useMemo)(()=>{const N={};return t.forEach(ie=>{ie.value&&ie.label&&(N[ie.value]=ie.label)}),N},[t]),Re=async(N,ie)=>{T(!0);try{const Ke=await r({logGroupPattern:N,accountId:ie});d(Ke.map(et=>({arn:et.value.arn,name:et.value.name,accountId:et.accountId,accountLabel:et.accountId?ye[et.accountId]:void 0})))}catch{d([])}T(!1)},ft=(N,ie)=>{g(ie?[...u,N]:u.filter(Ke=>Ke.arn!==N.arn))},yt=()=>{n(u),j()},vt=()=>{g(u),j()};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(Lr.a,{className:E.modal,title:"Select log groups",isOpen:a,onDismiss:j,children:[(0,o.jsxs)("div",{className:E.logGroupSelectionArea,children:[(0,o.jsx)("div",{className:E.searchField,children:(0,o.jsx)(U.c,{label:"Log group name prefix",children:(0,o.jsx)(ti,{searchFn:N=>{Re(N,v),A(N)},searchPhrase:m})})}),(0,o.jsx)(Ot,{onChange:N=>{Re(m,N),R(N||Pe.value)},accountOptions:t,accountId:v})]}),(0,o.jsx)(be.$,{layout:"block",v:2}),(0,o.jsxs)("div",{children:[!I&&c.length>=25&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:E.limitLabel,children:[(0,o.jsx)(Kt.I,{name:"info-circle"}),"Only the first 50 results can be shown. If you do not see an expected log group, try narrowing down your search.",(0,o.jsxs)("p",{children:["A"," ",(0,o.jsxs)("a",{target:"_blank",rel:"noopener noreferrer",href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/cloudwatch_limits_cwl.html",children:["maximum"," "]})," ","of 50 Cloudwatch log groups can be queried at one time."]})]}),(0,o.jsx)(be.$,{layout:"block",v:1})]}),(0,o.jsx)("div",{className:E.tableScroller,children:(0,o.jsxs)("table",{className:E.table,children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{className:E.row,children:[(0,o.jsx)("td",{className:E.cell,children:"Log Group"}),t.length>0&&(0,o.jsx)("td",{className:E.cell,children:"Account label"}),(0,o.jsx)("td",{className:E.cell,children:"Account ID"})]})}),(0,o.jsxs)("tbody",{children:[I&&(0,o.jsx)("tr",{className:E.row,children:(0,o.jsx)("td",{className:E.cell,children:(0,o.jsx)(_s._,{text:"Loading..."})})}),!I&&c.length===0&&(0,o.jsx)("tr",{className:E.row,children:(0,o.jsx)("td",{className:E.cell,children:"No log groups found"})}),!I&&c.map(N=>(0,o.jsxs)("tr",{className:E.row,children:[(0,o.jsx)("td",{className:E.cell,children:(0,o.jsxs)("div",{className:E.nestedEntry,children:[(0,o.jsx)(qs.S,{id:N.arn,onChange:ie=>ft(N,ie.currentTarget.checked),value:!!(N.arn&&u.some(ie=>ie.arn===N.arn))}),(0,o.jsx)(be.$,{layout:"inline",h:2}),(0,o.jsx)("label",{className:E.logGroupSearchResults,htmlFor:N.arn,title:N.name,children:N.name})]})}),t.length>0&&(0,o.jsx)("td",{className:E.cell,children:N.accountLabel}),(0,o.jsx)("td",{className:E.cell,children:N.accountId})]},`${N.arn}`))]})]})})]}),(0,o.jsx)(be.$,{layout:"block",v:2}),(0,o.jsxs)(ei.J,{className:E.logGroupCountLabel,children:[$," log group",$!==1&&"s"," selected"]}),(0,o.jsx)(be.$,{layout:"block",v:1}),(0,o.jsx)(U.c,{label:"Template variable",width:26,tooltip:"Optionally you can specify a single or multi-valued template variable. Select a variable separately or in conjunction with log groups.",children:(0,o.jsx)(ne.l6,{isClearable:!0,"aria-label":"Template variable",value:$e,allowCustomValue:!0,options:le,onChange:N=>{const ie=u.filter(Ke=>!Ke.name?.startsWith("$"));N?.label&&ie.push({name:N.label,arn:N.label}),g(ie)}})}),(0,o.jsxs)(Lr.a.ButtonRow,{children:[(0,o.jsx)(Fe.$n,{onClick:vt,variant:"secondary",type:"button",fill:"outline",children:"Cancel"}),(0,o.jsx)(Fe.$n,{onClick:yt,type:"button",children:"Add log groups"})]})]}),(0,o.jsx)("div",{children:(0,o.jsx)(Fe.$n,{variant:"secondary",onClick:()=>{try{s?.(),j()}catch{}},type:"button",children:"Select log groups"})})]})};var Mr=p(96374);const Fr=6,ni=({selectedLogGroups:t=[],onChange:e,maxNoOfVisibleLogGroups:r=Fr})=>{const n=(0,he.of)(Rr),[s,i]=(0,f.useState)(!1),[a,l]=(0,f.useState)(t.slice(0,Fr));return(0,f.useEffect)(()=>{l(t.slice(0,r))},[t,r]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:n.selectedLogGroupsContainer,children:[a.map(c=>(0,o.jsx)(Fe.$n,{size:"sm",variant:"secondary",icon:"times",className:n.removeButton,onClick:()=>{e(t.filter(d=>d.arn!==c.arn))},children:`${c.name}${c.accountLabel?`(${c.accountLabel})`:""}`},c.arn)),a.length!==t.length&&(0,o.jsx)(Fe.$n,{size:"sm",variant:"secondary",icon:"plus",fill:"outline",className:n.removeButton,onClick:()=>l(t),children:"Show all"}),t.length>0&&(0,o.jsx)(Fe.$n,{size:"sm",variant:"secondary",icon:"times",fill:"outline",className:n.removeButton,onClick:()=>i(!0),children:"Clear selection"})]}),(0,o.jsx)(Mr.u,{isOpen:s,title:"Clear Log Group Selection",body:"Are you sure you want to clear all log groups?",confirmText:"Yes",dismissText:"No",icon:"exclamation-triangle",onConfirm:()=>{i(!1),e([])},onDismiss:()=>i(!1)})]})},si=(0,S.css)({display:"flex",flexDirection:"column",marginTop:8,"& div:first-child":{marginBottom:8}}),ii=({datasource:t,onChange:e,legacyLogGroupNames:r,logGroups:n,region:s,maxNoOfVisibleLogGroups:i,onBeforeOpen:a})=>{const l=st(t?.resources,s),[c,d]=(0,f.useState)(!1);return(0,f.useEffect)(()=>{if(t&&!c&&!n?.length&&r?.length){d(!0);const u=r.filter(m=>gr(t.resources.templateSrv,m)),g=r.filter(m=>!gr(t.resources.templateSrv,m));Promise.all(g.map(m=>t.resources.getLogGroups({region:s,logGroupNamePrefix:m}))).then(m=>{const A=m.flatMap(v=>v.map(R=>({arn:R.value.arn,name:R.value.name,accountId:R.accountId})));e([...A,...u.map(v=>({name:v,arn:v}))])}).catch(m=>{console.error(m)})}},[t,r,n,e,s,c]),(0,o.jsxs)("div",{className:si,children:[(0,o.jsx)(ri,{fetchLogGroups:async u=>t?.resources.getLogGroups({region:s,...u})??[],onChange:e,accountOptions:l.value,selectedLogGroups:n,onBeforeOpen:a,variables:t?.getVariables()}),(0,o.jsx)(ni,{selectedLogGroups:n??[],onChange:e,maxNoOfVisibleLogGroups:i})]})},Nr=t=>q.$.featureToggles.cloudWatchCrossAccountQuerying?(0,o.jsx)(ii,{...t}):(0,o.jsx)(Js,{...t,onChange:t.legacyOnChange,legacyLogGroupNames:t.legacyLogGroupNames||[]});var oi=p(15292);function ai({options:t,onOptionsChange:e}){return(0,o.jsx)(At.A,{title:"Secure Socks Proxy",children:(0,o.jsx)(Be.D,{label:"Enabled",description:"Connect to this datasource via the secure socks proxy.",children:(0,o.jsx)(oi.d,{value:t.jsonData.enableSecureSocksProxy??!1,onChange:r=>e({...t,jsonData:{...t.jsonData,enableSecureSocksProxy:r.currentTarget.checked}})})})})}var Dr=p(55882),li=p(14186);const ci=t=>({infoText:(0,S.css)`
    padding-bottom: ${t.spacing(2)};
    color: ${t.colors.text.secondary};
  `}),kt="grafana-x-ray-datasource";function ui({newFormStyling:t,datasourceUid:e,onChange:r}){const n=!!(0,It.l)().getList({pluginId:kt}).length,s=(0,he.of)(ci);return t?(0,o.jsxs)(At.A,{title:"X-ray trace link",description:"Grafana will automatically create a link to a trace in X-ray data source if logs contain @xrayTraceId field",children:[!n&&(0,o.jsx)(xe.F,{title:"There is no X-ray datasource to link to. First add an X-ray data source and then link it to Cloud Watch. ",severity:"info"}),(0,o.jsx)(Be.D,{htmlFor:"data-source-picker",label:"Data source",description:"X-ray data source containing traces",children:(0,o.jsx)(Dr.s,{pluginId:kt,onChange:i=>r(i.uid),current:e,noDefault:!0})})]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("h3",{className:"page-heading",children:"X-ray trace link"}),(0,o.jsx)("div",{className:s.infoText,children:"Grafana will automatically create a link to a trace in X-ray data source if logs contain @xrayTraceId field"}),!n&&(0,o.jsx)(xe.F,{title:"There is no X-ray datasource to link to. First add an X-ray data source and then link it to Cloud Watch. ",severity:"info"}),(0,o.jsx)("div",{className:"gf-form-group",children:(0,o.jsx)(li.I,{htmlFor:"data-source-picker",label:"Data source",labelWidth:28,tooltip:"X-ray data source containing traces",children:(0,o.jsx)(Dr.s,{pluginId:kt,onChange:i=>r(i.uid),current:e,noDefault:!0})})})]})}const di='Since grafana 7.3 authentication type "arn" is deprecated, falling back to default SDK provider',mi=`As of grafana 7.3 authentication type "credentials" should be used only for shared file credentials. If you don't have a credentials file, switch to the default SDK provider for extracting credentials from environment variables or IAM roles`,pi=t=>{const{options:e,onOptionsChange:r}=t,{defaultLogGroups:n,logsTimeout:s,defaultRegion:i,logGroups:a}=e.jsonData,l=gi(t),c=hi(s),d=fi(t),[u,g]=(0,f.useState)({invalid:!1});(0,f.useEffect)(()=>g({invalid:!1}),[t.options]);const m=(0,cn.G)();(0,f.useEffect)(()=>{const $=(0,x.J7)().subscribe(w.NI,()=>{m("grafana_plugin_cloudwatch_save_succeeded",{auth_type:e.jsonData.authType})}),le=(0,x.J7)().subscribe(w.LL,()=>{m("grafana_plugin_cloudwatch_save_failed",{auth_type:e.jsonData.authType})});return()=>{$.unsubscribe(),le.unsubscribe()}},[e.jsonData.authType,m]);const[A,v]=(0,f.useState)("");(0,f.useEffect)(()=>{!A&&l&&l.resources.getExternalId().then(v).catch(()=>v("Unable to fetch externalId"))},[l,A]);const[R,I]=(0,f.useState)(null),T=()=>{I(null)};(0,f.useEffect)(()=>{e.jsonData.authType==="arn"?I(di):e.jsonData.authType==="credentials"&&!e.jsonData.profile&&!e.jsonData.database&&I(mi)},[e.jsonData.authType,e.jsonData.database,e.jsonData.profile]);const E=(0,he.of)(yi);return(0,o.jsxs)("div",{className:E.formStyles,children:[R&&(0,o.jsx)(xe.F,{title:"CloudWatch Authentication",severity:"warning",onRemove:T,children:R}),(0,o.jsx)(ln.NN,{...t,loadRegions:l&&(async()=>l.resources.getRegions().then($=>$.reduce((le,Se)=>Se.value?[...le,Se.value]:le,[]))),externalId:A,children:(0,o.jsx)(Be.D,{label:"Namespaces of Custom Metrics",children:(0,o.jsx)(pe.p,{placeholder:"Namespace1,Namespace2",value:e.jsonData.customMetricsNamespaces||"",onChange:(0,Ve.PG)(t,"customMetricsNamespaces")})})}),q.$.secureSocksDSProxyEnabled&&(0,o.jsx)(ai,{options:e,onOptionsChange:r}),(0,o.jsx)(rr.c,{}),(0,o.jsxs)(At.A,{title:"Cloudwatch Logs",children:[(0,o.jsx)(Be.D,{htmlFor:"logsTimeout",label:"Query Result Timeout",description:'Grafana will poll for Cloudwatch Logs results every second until Done status is returned from AWS or timeout is exceeded, in which case Grafana will return an error. Note: For Alerting, the timeout from Grafana config file will take precedence. Must be a valid duration string, such as "30m" (default) "30s" "2000ms" etc.',invalid:!!c,children:(0,o.jsx)(pe.p,{id:"logsTimeout",width:60,placeholder:"30m",value:e.jsonData.logsTimeout||"",onChange:(0,Ve.PG)(t,"logsTimeout"),title:'The timeout must be a valid duration string, such as "15m" "30s" "2000ms" etc.'})}),(0,o.jsx)(Be.D,{label:"Default Log Groups",description:"Optionally, specify default log groups for CloudWatch Logs queries.",...u,children:l?(0,o.jsx)(Nr,{region:i??"",datasource:l,onBeforeOpen:()=>{if(d)return;let $="You need to save the data source before adding log groups.";throw t.options.version&&t.options.version>1&&($="You have unsaved connection detail changes. You need to save the data source before adding log groups."),g({invalid:!0,error:$}),new Error($)},legacyLogGroupNames:n,logGroups:a,onChange:$=>{r({...t.options,jsonData:{...t.options.jsonData,logGroups:$,defaultLogGroups:void 0}})},maxNoOfVisibleLogGroups:2,legacyOnChange:$=>{(0,Ve.lO)(t,"defaultLogGroups",$)}}):(0,o.jsx)(o.Fragment,{})})]}),(0,o.jsx)(rr.c,{}),(0,o.jsx)(ui,{newFormStyling:!0,onChange:$=>(0,Ve.lO)(t,"tracingDatasourceUid",$),datasourceUid:e.jsonData.tracingDatasourceUid})]})};function gi(t){const[e,r]=(0,f.useState)();return(0,f.useEffect)(()=>{t.options.version&&(0,It.l)().get(t.options.name).then(n=>{n instanceof Or&&r(n)})},[t.options.version,t.options.name]),e}function hi(t){const[e,r]=(0,f.useState)(void 0);return(0,an.A)(()=>{if(t)try{St.describeInterval(t),r(void 0)}catch(n){n instanceof Error&&r(n.toString())}else r(void 0)},350,[t]),e}function fi(t){const[e,r]=(0,f.useState)(!!t.options.version&&t.options.version>1);return(0,f.useEffect)(()=>{r(!1)},[t.options.jsonData.assumeRoleArn,t.options.jsonData.authType,t.options.jsonData.defaultRegion,t.options.jsonData.endpoint,t.options.jsonData.externalId,t.options.jsonData.profile,t.options.secureJsonData?.accessKey,t.options.secureJsonData?.secretKey]),(0,f.useEffect)(()=>{t.options.version&&t.options.version>1&&r(!0)},[t.options.version]),e}const yi=t=>({formStyles:(0,S.css)({maxWidth:t.spacing(50)})});function vi({data:t=[]}){const e=(0,f.useMemo)(()=>(0,te.groupBy)(t,"refId"),[t]);return(0,o.jsx)(o.Fragment,{children:(0,o.jsxs)("table",{className:"filter-table form-inline",children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{children:"RefId"}),(0,o.jsx)("th",{children:"Metric Data Query ID"}),(0,o.jsx)("th",{children:"Metric Data Query Expression"}),(0,o.jsx)("th",{children:"Period"}),(0,o.jsx)("th",{})]})}),Object.entries(e).map(([r,n],s)=>{if(!n.length)return null;const i=n[0],a=i.meta?.custom;return a?(0,o.jsx)("tbody",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:r}),(0,o.jsx)("td",{children:a.id}),(0,o.jsx)("td",{children:i.meta?.executedQueryString}),(0,o.jsx)("td",{children:a.period})]})},s):null})]})})}var xi=p(38894),bi=p(84596);function Si({panelData:t,query:e,datasource:r}){const[n,s]=(0,f.useState)(""),i=(0,bi.A)(t);return(0,f.useEffect)(()=>{if(i!==t&&t?.request?.range){const a=(e.logGroups??[]).filter(A=>A?.arn).map(A=>(A.arn??"").replace(/:\*$/,"")),l=e.logGroupNames;let c=a?.length?a:l;const d=t?.request?.range,u=d.from.toISOString(),m={end:d.to.toISOString(),start:u,timeType:"ABSOLUTE",tz:"UTC",editorString:e.expression??"",isLiveTail:!1,source:c??[]};s(Ir(m,r.resources.getActualRegion(e.region)))}},[t,i,r,e]),(0,o.jsxs)("a",{href:n,target:"_blank",rel:"noopener noreferrer",children:[(0,o.jsx)(Kt.I,{name:"share-alt"})," CloudWatch Logs Insights"]})}var pt=p(32372);const Ai=async(t,e,r,n)=>{const{id:s,loader:i}=e;return n?.dispose(),i().then(a=>t.languages.registerCompletionItemProvider(s,r.getCompletionProvider(t,e)))},gt=async(t,e,r)=>{const{id:n,loader:s}=e;if(!t.languages.getLanguages().find(a=>a.id===n))return t.languages.register({id:n}),s().then(a=>(t.languages.setMonarchTokensProvider(n,a.language),t.languages.setLanguageConfiguration(n,a.conf),t.languages.registerCompletionItemProvider(n,r.getCompletionProvider(t,e))))},Ii=/\s+by\s+/im,Vt=/([\w$@().]+)(?:(\s+as\s+)([\w$]+))?\s*,?\s*/iy;function Ti(t){let e=[],r;if(r=t.match(Ii)){Vt.lastIndex=r.index+r[0].length;let n;for(;n=Vt.exec(t);)e.push(n[2]?n[3]:n[1]),Vt.lastIndex=n.index+n[0].length}return e}const Ci=t=>{const{query:e,datasource:r,onChange:n,ExtraFieldElement:s}=t,i=(0,f.useRef)(),a=(0,f.useRef)(),l=(0,f.useCallback)(async m=>{n(m)},[n]),c=(0,f.useCallback)(async()=>{a.current=await Ai(i.current,jt,r.logsCompletionItemProviderFunc({region:e.region,logGroups:e.logGroups}),a.current)},[r,e.logGroups,e.region]),d=(0,f.useCallback)(m=>{const A={...e,expression:m,statsGroups:Ti(m)};n(A)},[n,e]),u=(0,f.useCallback)((m,A)=>{m.onDidFocusEditorText(()=>m.trigger(Z.id,Z.id,{})),m.addCommand(A.KeyMod.Shift|A.KeyCode.Enter,()=>{const v=m.getValue();d(v)})},[d]),g=async m=>{i.current=m,a.current=await gt(m,jt,r.logsCompletionItemProviderFunc({region:e.region,logGroups:e.logGroups}))};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Nr,{region:e.region,datasource:r,legacyLogGroupNames:e.logGroupNames,logGroups:e.logGroups,onChange:m=>{l({...e,logGroups:m,logGroupNames:void 0})},legacyOnChange:m=>{l({...e,logGroupNames:m})}}),(0,o.jsxs)("div",{className:"gf-form-inline gf-form-inline--nowrap flex-grow-1",children:[(0,o.jsx)("div",{className:"gf-form--grow flex-shrink-1",children:(0,o.jsx)(pt.B,{height:"150px",width:"100%",showMiniMap:!1,monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,wordWrap:"on",padding:{top:6}},language:jt.id,value:e.expression??"",onBlur:m=>{m!==e.expression&&d(m),a.current?.dispose()},onFocus:c,onBeforeEditorMount:g,onEditorDidMount:u,onEditorWillUnmount:()=>a.current?.dispose()})}),s]})]})},Ei=(0,he.cV)(Ci),wi=(0,S.css)`
  margin-left: 3px;
  flex-grow: 0;
`,Ri=(0,f.memo)(function(e){const{query:r,data:n,datasource:s}=e;return(0,o.jsx)(Ei,{...e,ExtraFieldElement:(0,o.jsx)(xi.I,{className:`gf-form-label--btn ${wi}`,width:"auto",tooltip:"Link to Graph in AWS",children:(0,o.jsx)(Si,{query:r,panelData:n,datasource:s})})})});var Oi=p(94354);const Li=(t,e)=>{const r=(0,f.useMemo)(()=>Gt(t),[t]);return(0,f.useEffect)(()=>{r!==t&&e(r)},[r,t,e]),r};var Mi=p(64698);class Fi{constructor(){this.tokenTypes={Parenthesis:"delimiter.parenthesis.cloudwatch-dynamicLabels",Whitespace:"white.cloudwatch-dynamicLabels",Keyword:"keyword.cloudwatch-dynamicLabels",Delimiter:"delimiter.cloudwatch-dynamicLabels",Operator:"operator.cloudwatch-dynamicLabels",Identifier:"identifier.cloudwatch-dynamicLabels",Type:"type.cloudwatch-dynamicLabels",Function:"predefined.cloudwatch-dynamicLabels",Number:"number.cloudwatch-dynamicLabels",String:"string.cloudwatch-dynamicLabels",Variable:"variable.cloudwatch-dynamicLabels",Comment:"comment.cloudwatch-dynamicLabels",Regexp:"regexp.cloudwatch-dynamicLabels"}}getCompletionProvider(e,r){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(n,s)=>{const i=fr(e,r,n,s,this.tokenTypes),l=i?.isWhiteSpace()||i?.isParenthesis()||!i?.range?e.Range.fromPositions(s):i?.range,c=(g,m={})=>({label:g,insertText:g,kind:e.languages.CompletionItemKind.Field,range:l,sortText:se.Medium,...m});let d=[];const u=i?.next;return!i?.isFunction()&&(!u||u.isWhiteSpace())&&(d=Mi.DYNAMIC_LABEL_PATTERNS.map(g=>c(g)),d.push(c("${PROP('Dim.')}",{sortText:se.High,insertText:"${PROP('Dim.$0')} ",insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet}))),{suggestions:d}}}}}const jr={id:"cloudwatch-dynamicLabels",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(p.bind(p,64698))},Ni=new Fi;function Di({label:t,width:e,onChange:r}){const n=(0,he.$j)(),s=(0,pe.n)({theme:n,width:e}),i=(0,f.useRef)(null),a=(0,f.useCallback)((l,c)=>{l.onDidFocusEditorText(()=>l.trigger(Z.id,Z.id,{})),l.addCommand(c.KeyMod.Shift|c.KeyCode.Enter,()=>{const u=l.getValue();r(u)});const d=i.current;d!==null&&l.layout({width:d.clientWidth,height:d.clientHeight})},[r]);return(0,o.jsx)("div",{ref:i,className:(0,S.cx)(s.wrapper),children:(0,o.jsx)(pt.B,{containerStyles:(0,S.css)`
          border: 1px solid ${n.colors.action.disabledBackground};
          &:hover {
            border-color: ${n.components.input.borderColor};
          }
        `,monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",overviewRulerLanes:0,scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,padding:{top:6}},language:jr.id,value:t,onBlur:l=>{l!==t&&r(l)},onBeforeEditorMount:l=>gt(l,jr,Ni),onEditorDidMount:a})})}const Pr={id:"cloudwatch-MetricMath",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(p.bind(p,74746))};function ji({expression:t,onChange:e,datasource:r}){const n=(0,f.useRef)(null),s=(0,f.useCallback)((i,a)=>{i.onDidFocusEditorText(()=>i.trigger(Z.id,Z.id,{})),i.addCommand(a.KeyMod.Shift|a.KeyCode.Enter,()=>{const c=i.getValue();e(c)});const l=()=>{const c=n.current;if(c!==null){const d=Math.min(200,i.getContentHeight()),u=Math.max(32,d);c.style.height=`${u}px`,c.style.width="100%";const g=c.clientWidth;i.layout({width:g,height:u})}};i.onDidContentSizeChange(l),l()},[e]);return(0,o.jsx)("div",{ref:n,children:(0,o.jsx)(pt.B,{monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,wordWrap:"on",padding:{top:6}},language:Pr.id,value:t,onBlur:i=>{i!==t&&e(i)},onBeforeEditorMount:i=>gt(i,Pr,r.metricMathCompletionItemProvider),onEditorDidMount:s})})}var O=p(91621);const Wr=t=>!!(t&&t!=="all");class Gr{constructor(e=(0,Te.w)()){this.templateSrv=e}expressionToSqlQuery({select:e,from:r,where:n,groupBy:s,orderBy:i,orderByDirection:a,limit:l},c){if(!r||!e?.name||!e?.parameters?.length)return;let d=[];return this.appendSelect(e,d),this.appendFrom(r,d),this.appendAccountId(d,c),this.appendWhere(n,d,!0,n?.expressions?.length??0,c),this.appendGroupBy(s,d),this.appendOrderBy(i,a,d),this.appendLimit(l,d),d.join(" ")}appendSelect(e,r){r.push("SELECT"),this.appendFunction(e,r)}appendFrom(e,r){r.push("FROM"),e?.type===O._W.Function?this.appendFunction(e,r):r.push(this.formatValue(e?.property?.name??""))}appendAccountId(e,r){Wr(r)&&e.push(`WHERE AWS.AccountId = '${r}'`)}appendWhere(e,r,n,s,i){if(!e)return;const a="expressions"in e&&e.expressions.length>0;if(n&&a&&(Wr(i)?r.push("AND"):r.push("WHERE")),e.type===O._W.And){const l=[];if(e.expressions.map(u=>this.appendWhere(u,l,!1,s)),l.length===0)return;const c=l.join(" AND "),d=!n&&s>1&&l.length>1;return r.push(d?`(${c})`:c)}if(e.type===O._W.Or){const l=[];if(e.expressions.map(u=>this.appendWhere(u,l,!1,s)),l.length===0)return;const c=l.join(" OR "),d=!n&&s>1&&l.length>1;r.push(d?`(${c})`:c);return}if(e.type===O._W.Operator)return this.appendOperator(e,r)}appendGroupBy(e,r){const n=[];for(const s of e?.expressions??[])s?.type!==O._W.GroupBy||!s.property.name||n.push(this.formatValue(s.property.name));n.length>0&&r.push(`GROUP BY ${n.join(", ")}`)}appendOrderBy(e,r,n){e&&(n.push("ORDER BY"),this.appendFunction(e,n),n.push(r??"ASC"))}appendLimit(e,r){e&&r.push(`LIMIT ${e}`)}appendOperator(e,r,n){const{property:s,operator:i}=e;!s.name||!i.name||!i.value||r.push(`${this.formatValue(s.name)} ${i.name} '${i.value}'`)}appendFunction(e,r){if(!e?.name)return;const n=(e.parameters??[]).map(s=>s.name&&this.formatValue(s.name)).filter(Boolean).join(", ");r.push(`${e.name}(${n})`)}formatValue(e){const r=/[/\s\.%-]/,n=/^\d/,s=this.templateSrv.replace(e,{},"raw");return s!=="AWS.AccountId"&&(r.test(s)||n.test(s))?`"${e}"`:e}}function Bt(t){return t?.parameters?.[0].name}function ht(t){if(t?.type===O._W.Property)return t.property.name;if(t?.type===O._W.Function)return t.parameters?.[0].name}function Pi(t){if(t?.type===O._W.Function&&t?.parameters?.length)return t?.parameters?.length<=1?[]:(t?.parameters.slice(1)).reduce((r,n)=>n.name?[...r,n.name]:r,[])}function Wi(t){return t?.type===O._W.Function&&t.name===b.SCHEMA}function Gi(t){const e=t.property?.name,r=t.operator?.value,n=t.operator?.name;if(e&&r&&n)return{type:O._W.Operator,property:{type:O.Dw.String,name:e},operator:{value:r,name:n}}}function $r(t){return t.flatMap(e=>e.type===O._W.Operator?e:e.type===O._W.And||e.type===O._W.Or?$r(e.expressions):[])}function $i(t){const e=t.where;return $r(e?.expressions??[])}function Ki(t){return t.flatMap(e=>e.type===O._W.GroupBy?e:[])}function ki(t){const e=t.groupBy;return Ki(e?.expressions??[])}function Vi(t){return t.reduce((e,r)=>r?{...e,[r]:null}:e,{})}function me(t,e){return{...t,sql:{...t.sql??{},...e}}}function Bi(t,e){const r=t.sql??{};if(t.namespace=e||"",e===void 0)return me(t,{from:void 0});if(!r.from||r.from.type===O._W.Property)return me(t,{from:{type:O._W.Property,property:{type:O.Dw.String,name:e}}});if(r.from.type===O._W.Function){const n={type:O._W.FunctionParameter,name:e},s=(r.from.parameters??[]).slice(1);return me(t,{from:{type:O._W.Function,name:b.SCHEMA,parameters:[n,...s]}})}return t}function Qi(t,e){const r=t.sql??{};if(e=Array.isArray(e)?e.map(n=>n.value):[e.value],r.from?.type===O._W.Function&&r.from.parameters?.length){const n=(e??[]).map(i=>({type:O._W.FunctionParameter,name:i})),s=(r.from.parameters??[])[0];return me(t,{from:{type:O._W.Function,name:b.SCHEMA,parameters:[s,...n]}})}return t}function Ui(t,e){const r={type:O._W.FunctionParameter,name:e};return me({...t,metricName:e},{select:{type:O._W.Function,...t.sql?.select??{},parameters:[r]}})}function zi(t){const e={...t};return delete e.sql?.select?.parameters,e}function Kr(t,e){return me(t,{select:{type:O._W.Function,...t.sql?.select??{},name:e}})}function Hi(t,e){return me(t,{orderBy:{type:O._W.Function,name:e}})}function Yi(t,e){const r=ht((t.sql??{}).from);if(e){const n={type:O._W.FunctionParameter,name:r};return me(t,{from:{type:O._W.Function,name:b.SCHEMA,parameters:[n]}})}return me(t,{from:{type:O._W.Property,property:{type:O.Dw.String,name:r}}})}function Xi(t,e){return{type:O._W.Operator,property:{type:O.Dw.String,name:e},operator:t.operator??{}}}function Zi(t,e){return{type:O._W.Operator,property:t.property??{type:O.Dw.String},operator:{...t.operator,name:e}}}function Ji(t,e){return{type:O._W.Operator,property:t.property??{type:O.Dw.String},operator:{...t.operator,value:e}}}function _i(t){return{type:O._W.GroupBy,property:{type:O.Dw.String,name:t}}}const qi=b.STATISTICS.map(re.z),eo=({datasource:t,query:e,onQueryChange:r})=>{const n=e.sql??{},s=n.select?.name;(0,f.useEffect)(()=>{s||r(Kr(e,b.STATISTICS[0]))},[s,r,e]);const i=Bt(n.select),a=ht(n.from),l=Pi(n.from),c=Wi(n.from),d=wt(t),u=Rt(t,{region:e.region,namespace:a,...q.$.featureToggles.cloudWatchCrossAccountQuerying&&q.$.featureToggles.cloudwatchMetricInsightsCrossAccount?{accountId:e.accountId}:{}}),g=(0,f.useMemo)(()=>Vi(l??[]),[l]),m=He(t,{region:e.region,namespace:a,metricName:i,dimensionFilters:g,...q.$.featureToggles.cloudWatchCrossAccountQuerying&&q.$.featureToggles.cloudwatchMetricInsightsCrossAccount?{accountId:e.accountId}:{}}),A=(0,f.useMemo)(()=>l?.length?[...m,...l.map(re.z)]:m,[m,l]),v=async T=>{const E=await R(T);r(E)},R=async T=>{let{region:E,sql:$,namespace:le}=T;return await t.resources.getMetrics({namespace:le,region:E}).then(Se=>{Se.some($e=>$e.value===i)||($=zi(T).sql)}),{...T,sql:$}},I=st(t.resources,e.region);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(it.B,{children:[q.$.featureToggles.cloudWatchCrossAccountQuerying&&q.$.featureToggles.cloudwatchMetricInsightsCrossAccount&&(0,o.jsx)(Ot,{accountId:e.accountId,accountOptions:I.value||[],onChange:T=>{r({...e,accountId:T})}}),(0,o.jsx)(U.c,{label:"Namespace",width:16,children:(0,o.jsx)(ne.l6,{"aria-label":"Namespace",value:a?(0,re.z)(a):null,inputId:`${e.refId}-cloudwatch-sql-namespace`,options:d,allowCustomValue:!0,onChange:({value:T})=>T&&v(Bi(e,T))})}),(0,o.jsx)(U.c,{label:"With schema",children:(0,o.jsx)(Tt.C,{id:`${e.refId}-cloudwatch-sql-withSchema`,value:c,onChange:T=>T.target instanceof HTMLInputElement&&r(Yi(e,T.target.checked))})}),c&&(0,o.jsx)(U.c,{label:"Schema labels",disabled:!a,children:(0,o.jsx)(ne.l6,{id:`${e.refId}-cloudwatch-sql-schema-label-keys`,width:"auto",isMulti:!0,value:l?l.map(re.z):null,options:A,allowCustomValue:!0,onChange:T=>T&&r(Qi(e,T))})})]}),(0,o.jsxs)(it.B,{children:[(0,o.jsx)(U.c,{label:"Metric name",width:16,children:(0,o.jsx)(ne.l6,{"aria-label":"Metric name",value:i?(0,re.z)(i):null,options:u,allowCustomValue:!0,onChange:({value:T})=>T&&r(Ui(e,T))})}),(0,o.jsx)(U.c,{label:"Aggregation",width:16,children:(0,o.jsx)(ne.l6,{"aria-label":"Aggregation",value:s?(0,re.z)(s):null,options:fe(t,qi),onChange:({value:T})=>T&&r(Kr(e,T))})})]})]})},to=b.COMPARISON_OPERATORS.map(re.z),ro=({query:t,onQueryChange:e,datasource:r})=>{const n=(0,f.useMemo)(()=>$i(t.sql??{}),[t.sql]),[s,i]=(0,f.useState)(n),a=l=>{const c=l.map(g=>({type:O._W.Operator,property:g.property??{type:O.Dw.String},operator:g.operator??{name:b.EQUALS}}));i(c);const d=[];for(const g of c){const m=Gi(g);m&&d.push(m)}const u=d.length?{type:O._W.And,expressions:d}:void 0;e(me(t,{where:u}))};return(0,o.jsx)(at.o,{items:s,onChange:a,renderItem:no(r,t)})};function no(t,e){function r(n,s,i){return(0,o.jsx)(io,{datasource:t,query:e,filter:n,onChange:s,onDelete:i})}return r}const so=ro,io=t=>{const{datasource:e,query:r,filter:n,onChange:s,onDelete:i}=t,a=(0,he.of)(oo),l=r.sql??{},c=ht(l.from),d=Bt(l.select),u=He(e,{region:r.region,namespace:c,metricName:d,...q.$.featureToggles.cloudWatchCrossAccountQuerying&&q.$.featureToggles.cloudwatchMetricInsightsCrossAccount?{accountId:r.accountId}:{}}),g=async()=>!n.property?.name||!c?[]:e.resources.getDimensionValues({region:r.region,namespace:c,metricName:d,dimensionKey:n.property.name,...q.$.featureToggles.cloudWatchCrossAccountQuerying&&q.$.featureToggles.cloudwatchMetricInsightsCrossAccount?{accountId:r.accountId}:{}}).then(I=>fe(e,I)),[m,A]=(0,Ct.A)(g,[r.region,c,d,n.property?.name]),v=Ye(e,n.property?.name),R=Ye(e,typeof n.operator?.value=="string"?n.operator?.value:void 0);return(0,o.jsxs)("div",{className:a.container,children:[(0,o.jsxs)(Xe.M,{children:[(0,o.jsx)(ne.l6,{width:"auto",value:n.property?.name?(0,re.z)(n.property?.name):null,options:u,allowCustomValue:!0,onChange:({value:I})=>I&&s(Xi(n,I))}),(0,o.jsx)(ne.l6,{width:"auto",value:n.operator?.name&&(0,re.z)(n.operator.name),options:to,onChange:({value:I})=>I&&s(Zi(n,I))}),(0,o.jsx)(ne.l6,{width:"auto",isLoading:m.loading,value:n.operator?.value&&typeof n.operator?.value=="string"?(0,re.z)(n.operator?.value):null,options:m.value,allowCustomValue:!0,onOpenMenu:A,onChange:({value:I})=>I&&s(Ji(n,I))}),(0,o.jsx)(Ze.Z,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:i})]}),v&&(0,o.jsx)(xe.F,{className:a.alert,title:v,severity:"error",topSpacing:1}),R&&(0,o.jsx)(xe.F,{className:a.alert,title:R,severity:"error",topSpacing:1})]})},oo=()=>({container:(0,S.css)({display:"inline-block"}),alert:(0,S.css)({minWidth:"100%",width:"min-content"})}),ao=({query:t,datasource:e,onQueryChange:r})=>{const n=t.sql??{},s=(0,f.useMemo)(()=>ki(t.sql??{}),[t.sql]),[i,a]=(0,f.useState)(s),l=or(e.resources,t.region),c=ht(n.from),d=Bt(n.select),u=He(e,{region:t.region,namespace:c,metricName:d}),g=(0,f.useMemo)(()=>(q.$.featureToggles.cloudWatchCrossAccountQuerying&&q.$.featureToggles.cloudwatchMetricInsightsCrossAccount&&l?[{label:"Account ID",value:"AWS.AccountId"},...u]:u).filter(R=>!s.some(I=>I.property.name===R.value)),[u,s,l]),m=A=>{const v=A.map(T=>({type:O._W.GroupBy,property:{type:O.Dw.String,name:T.property?.name}}));a(v);const R=v.filter(T=>T.property?.name),I=R.length?{type:O._W.And,expressions:R}:void 0;r(me(t,{groupBy:I}))};return(0,o.jsx)(at.o,{items:i,onChange:m,renderItem:lo(g)})};function lo(t){function e(r,n,s){return(0,o.jsx)(co,{options:t,item:r,onChange:n,onDelete:s})}return e}const co=t=>{const{options:e,item:r,onChange:n,onDelete:s}=t,i=r.property?.name;return(0,o.jsxs)(Xe.M,{children:[(0,o.jsx)(ne.l6,{"aria-label":`Group by ${i??"filter key"}`,width:"auto",value:i?(0,re.z)(i):null,options:e,allowCustomValue:!0,onChange:({value:a})=>a&&n(_i(a))}),(0,o.jsx)(Ze.Z,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:s})]})},uo=ao,kr=[{label:b.ASC,value:b.ASC},{label:b.DESC,value:b.DESC}],mo=({query:t,onQueryChange:e,datasource:r})=>{const n=t.sql??{},s=n.orderBy?.name,i=n.orderByDirection;return(0,o.jsxs)(it.B,{children:[(0,o.jsx)(U.c,{label:"Order by",optional:!0,width:16,children:(0,o.jsxs)(Xe.M,{children:[(0,o.jsx)(ne.l6,{"aria-label":"Order by",onChange:({value:a})=>a&&e(Hi(t,a)),options:fe(r,b.STATISTICS.map(re.z)),value:s?(0,re.z)(s):null}),s&&(0,o.jsx)(Ze.Z,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>e(me(t,{orderBy:void 0}))})]})}),(0,o.jsx)(U.c,{label:"Direction",disabled:!s,width:16,children:(0,o.jsx)(ne.l6,{"aria-label":"Direction",inputId:"cloudwatch-sql-order-by-direction",value:i?(0,re.z)(i):kr[0],options:fe(r,kr),onChange:a=>a&&e(me(t,{orderByDirection:a.value}))})})]})},po=({query:t,datasource:e,onChange:r})=>{const n=t.sql??{},s=(0,f.useCallback)(l=>{const d=new Gr().expressionToSqlQuery(l.sql??{},l.accountId),u={...l,sqlExpression:d};r(u)},[r]),[i,a]=(0,f.useState)();return(0,f.useEffect)(()=>{const c=new Gr().expressionToSqlQuery(t.sql??{},t.accountId);i!==c&&a(c)},[t,i,a]),(0,o.jsxs)(ar.D,{children:[(0,o.jsx)(Ce.U,{children:(0,o.jsx)(eo,{query:t,onQueryChange:s,datasource:e})}),(0,o.jsx)(Ce.U,{children:(0,o.jsx)(U.c,{label:"Filter",optional:!0,children:(0,o.jsx)(so,{query:t,onQueryChange:s,datasource:e})})}),(0,o.jsxs)(Ce.U,{children:[(0,o.jsx)(U.c,{label:"Group by",optional:!0,children:(0,o.jsx)(uo,{query:t,onQueryChange:s,datasource:e})}),(0,o.jsx)(mo,{query:t,onQueryChange:s,datasource:e}),(0,o.jsx)(U.c,{label:"Limit",optional:!0,children:(0,o.jsx)(pe.p,{id:`${t.refId}-cloudwatch-sql-builder-editor-limit`,value:n.limit,onChange:l=>{const c=l.currentTarget.valueAsNumber;s(me(t,{limit:isNaN(c)?void 0:c}))},type:"number",min:1})})]}),i&&(0,o.jsxs)(Ce.U,{children:[!1,(0,o.jsx)("pre",{children:i??""})]})]})},Vr={id:"cloudwatch-sql",extensions:[".cloudwatchSql"],aliases:["CloudWatch","cloudwatch","CloudWatchSQL"],mimetypes:[],loader:()=>Promise.resolve().then(p.bind(p,85232))},go=({region:t,sql:e,onChange:r,datasource:n})=>{(0,f.useEffect)(()=>{n.sqlCompletionItemProvider.setRegion(t)},[t,n]);const s=(0,f.useCallback)((i,a)=>{i.onDidFocusEditorText(()=>i.trigger(Z.id,Z.id,{})),i.addCommand(a.KeyMod.Shift|a.KeyCode.Enter,()=>{const l=i.getValue();r(l)})},[r]);return(0,o.jsx)(pt.B,{height:"150px",language:Vr.id,value:e,onBlur:i=>{i!==e&&r(i)},showMiniMap:!1,showLineNumbers:!0,onBeforeEditorMount:i=>gt(i,Vr,n.sqlCompletionItemProvider),onEditorDidMount:s})},Br=[{label:"Metric Search",value:y.d$.Search},{label:"Metric Insights",value:y.d$.Insights}],ho=[{label:"Builder",value:y.Rx.Builder},{label:"Code",value:y.Rx.Code}],fo=t=>{const{query:e,datasource:r,extraHeaderElementLeft:n,extraHeaderElementRight:s,onChange:i}=t,[a,l]=(0,f.useState)(!1),[c,d]=(0,f.useState)(!1),u=Li(e,t.onChange),g=(0,f.useCallback)(m=>{if(c&&e.metricQueryType===y.d$.Insights&&e.metricEditorMode===y.Rx.Code){l(!0);return}i({...e,metricEditorMode:m})},[l,i,c,e]);return(0,f.useEffect)(()=>(n?.((0,o.jsx)(nt.W,{"aria-label":"Metric editor mode",value:Br.find(m=>m.value===e.metricQueryType),options:Br,onChange:({value:m})=>{if(c&&e.metricQueryType===y.d$.Search&&e.metricEditorMode===y.Rx.Builder){l(!0);return}i({...e,metricQueryType:m})}})),s?.((0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Oi.z,{options:ho,size:"sm",value:e.metricEditorMode,onChange:g}),(0,o.jsx)(Mr.u,{isOpen:a,title:"Are you sure?",body:"You will lose changes made to the query if you change to Metric Insights Builder mode.",confirmText:"Yes, I am sure.",dismissText:"No, continue editing the query.",icon:"exclamation-triangle",onConfirm:()=>{l(!1),d(!1),i({...e,...dr,metricQueryType:y.d$.Insights,metricEditorMode:y.Rx.Builder})},onDismiss:()=>l(!1)})]})),()=>{n?.(void 0),s?.(void 0)}),[e,c,r,i,n,s,a,g]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(be.$,{v:.5}),e.metricQueryType===y.d$.Search&&(0,o.jsxs)(o.Fragment,{children:[e.metricEditorMode===y.Rx.Builder&&(0,o.jsx)(ur,{...t,refId:e.refId,metricStat:e,onChange:m=>{c||d(!0),t.onChange({...e,...m})}}),e.metricEditorMode===y.Rx.Code&&(0,o.jsx)(ji,{expression:e.expression??"",onChange:m=>t.onChange({...e,expression:m}),datasource:r})]}),e.metricQueryType===y.d$.Insights&&(0,o.jsxs)(o.Fragment,{children:[e.metricEditorMode===y.Rx.Code&&(0,o.jsx)(go,{region:e.region,sql:e.sqlExpression??"",onChange:m=>{c||d(!0),t.onChange({...u,sqlExpression:m})},datasource:r}),e.metricEditorMode===y.Rx.Builder&&(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(po,{query:e,onChange:t.onChange,datasource:r})})]}),(0,o.jsx)(be.$,{v:.5}),(0,o.jsxs)(Ce.U,{children:[(0,o.jsx)(U.c,{label:"ID",width:26,optional:!0,tooltip:"ID can be used to reference other queries in math expressions. The ID can include numbers, letters, and underscore, and must start with a lowercase letter.",invalid:!!e.id&&!/^$|^[a-z][a-zA-Z0-9_]*$/.test(e.id),children:(0,o.jsx)(pe.p,{id:`${e.refId}-cloudwatch-metric-query-editor-id`,onChange:m=>i({...u,id:m.target.value}),type:"text",value:e.id})}),(0,o.jsx)(U.c,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,o.jsx)(pe.p,{id:`${e.refId}-cloudwatch-metric-query-editor-period`,value:e.period||"",placeholder:"auto",onChange:m=>i({...u,period:m.target.value})})}),(0,o.jsx)(U.c,{label:"Label",width:26,optional:!0,tooltip:"Change time series legend name using Dynamic labels. See documentation for details.",children:(0,o.jsx)(Di,{width:52,label:u.label??"",onChange:m=>t.onChange({...e,label:m})})})]})]})};var yo=p(41987),vo=p(31347),xo=p(39938);const bo=[{label:"CloudWatch Metrics",value:"Metrics"},{label:"CloudWatch Logs",value:"Logs"}],So=({query:t,onChange:e,datasource:r,extraHeaderElementLeft:n,extraHeaderElementRight:s,dataIsStale:i,data:a,onRunQuery:l})=>{const{queryMode:c,region:d}=t,u=or(r.resources,t.region),[g,m]=Et(r),A=Ue(t)?!t.expression:!1,v=({value:E})=>{if(E&&E!==c){let $="";E==="Logs"&&($=Tn),e({...r.getDefaultQuery(yo.Jk.Unknown),...t,expression:$,queryMode:E})}},R=async E=>{if(q.$.featureToggles.cloudWatchCrossAccountQuerying&&Le(t)){const $=await r.resources.isMonitoringAccount(E);e({...t,region:E,accountId:$?t.accountId:void 0})}else e({...t,region:E})},I=q.$.featureToggles.cloudwatchMetricInsightsCrossAccount,T=q.$.featureToggles.cloudWatchCrossAccountQuerying&&u&&(t.queryMode==="Logs"||Le(t)&&t.metricQueryType===y.d$.Search||I&&Le(t)&&t.metricQueryType===y.d$.Insights);return(0,o.jsx)(o.Fragment,{children:(0,o.jsxs)(nr.X,{children:[(0,o.jsx)(nt.W,{label:"Region",value:d,placeholder:"Select region",allowCustomValue:!0,onChange:({value:E})=>E&&R(E),options:g,isLoading:m}),(0,o.jsx)(nt.W,{"aria-label":"Query mode",value:c,options:bo,onChange:v,inputId:`cloudwatch-query-mode-${t.refId}`,id:`cloudwatch-query-mode-${t.refId}`}),n,(0,o.jsx)(vo.Z,{grow:1}),T&&(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(xo.E,{text:"Monitoring account",color:"blue",tooltip:"AWS monitoring accounts view data from source accounts so you can centralize monitoring and troubleshoot activities"})}),(0,o.jsx)(Fe.$n,{variant:i?"primary":"secondary",size:"sm",onClick:l,icon:a?.state===Ie.Gu.Loading?"spinner":void 0,disabled:a?.state===Ie.Gu.Loading||A,children:"Run queries"}),s]})})},Ao=t=>{const{query:e,onChange:r,data:n}=t,[s,i]=(0,f.useState)(!1),[a,l]=(0,f.useState)(),[c,d]=(0,f.useState)();(0,f.useEffect)(()=>{i(!1)},[n]);const u=(0,f.useCallback)(g=>{i(!0),r(g)},[r]);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(So,{...t,extraHeaderElementLeft:a,extraHeaderElementRight:c,dataIsStale:s}),Le(e)&&(0,o.jsx)(fo,{...t,query:e,onRunQuery:()=>{},onChange:u,extraHeaderElementLeft:l,extraHeaderElementRight:d}),Ue(e)&&(0,o.jsx)(Ri,{...t,query:e,onChange:u})]})};var Io=p(14110),To=p(42809);const Co=({payload:{dashboardId:t,orgId:e,grafanaVersion:r,queries:n}})=>{try{const s=n[To.id];if(!s?.length)return;let i=[],a=[];for(const c of s)if(!c.hide){if(Ue(c))c.logGroupNames?.length&&i.push(c);else if(Le(c)){const d=Gt(c);ir(d)&&a.push(c)}}const l={grafana_version:r,dashboard_id:t,org_id:e,logs_queries_count:i?.length,metrics_queries_count:a?.length,metrics_search_count:0,metrics_search_builder_count:0,metrics_search_code_count:0,metrics_search_match_exact_count:0,metrics_query_count:0,metrics_query_builder_count:0,metrics_query_code_count:0,metrics_queries_with_account_count:0};for(const c of a)l.metrics_search_count+=+(c.metricQueryType===y.d$.Search),l.metrics_search_builder_count+=+Qt(c),l.metrics_search_code_count+=+(c.metricQueryType===y.d$.Search&&c.metricEditorMode===y.Rx.Code),l.metrics_search_match_exact_count+=+!!(Qt(c)&&c.matchExact),l.metrics_query_count+=+(c.metricQueryType===y.d$.Insights),l.metrics_query_builder_count+=+(c.metricQueryType===y.d$.Insights&&c.metricEditorMode===y.Rx.Builder),l.metrics_query_code_count+=+(c.metricQueryType===y.d$.Insights&&c.metricEditorMode===y.Rx.Code),l.metrics_queries_with_account_count+=+!!(q.$.featureToggles.cloudWatchCrossAccountQuerying&&Qt(c)&&c.accountId);(0,Io.rR)("grafana_ds_cloudwatch_dashboard_loaded",l)}catch(s){console.error("error in cloudwatch tracking handler",s)}},Qt=t=>t.metricQueryType===y.d$.Search&&t.metricEditorMode===y.Rx.Builder,Eo=new P.tD(Or).setQueryEditorHelp(sn).setConfigEditor(pi).setQueryEditor(Ao).setMetadataInspector(vi);(0,x.J7)().subscribe(w.gc,Co)},50287:(ge,Y,p)=>{ge.exports=p(53995)},53995:(ge,Y)=>{(function(p){"use strict";p.stringify=function w(x){function o(V){return/[^\w-.]/.test(V)?V.replace(/[^\w-.]/g,function(J){return J==="$"?"!":(J=J.charCodeAt(0),J<256?"*"+("00"+J.toString(16)).slice(-2):"**"+("0000"+J.toString(16)).slice(-4))}):V}var S;switch(typeof x){case"number":return isFinite(x)?"~"+x:"~null";case"boolean":return"~"+x;case"string":return"~'"+o(x);case"object":if(!x)return"~null";if(S=[],Array.isArray(x)){for(var k=0;k<x.length;k++)S[k]=w(x[k])||"~null";return"~("+(S.join("")||"~")+")"}else{for(var W in x)if(x.hasOwnProperty(W)){var G=w(x[W]);G&&S.push(o(W)+G)}return"~("+S.join("~")+")"}default:return}};var P={true:!0,false:!1,null:null};p.parse=function(w){if(!w)return w;w=w.replace(/%(25)*27/g,"'");var x=0,o=w.length;function S(W){if(w.charAt(x)!==W)throw new Error("bad JSURL syntax: expected "+W+", got "+(w&&w.charAt(x)));x++}function k(){for(var W=x,G,V="";x<o&&(G=w.charAt(x))!=="~"&&G!==")";)switch(G){case"*":W<x&&(V+=w.substring(W,x)),w.charAt(x+1)==="*"?(V+=String.fromCharCode(parseInt(w.substring(x+2,x+6),16)),W=x+=6):(V+=String.fromCharCode(parseInt(w.substring(x+1,x+3),16)),W=x+=3);break;case"!":W<x&&(V+=w.substring(W,x)),V+="$",W=++x;break;default:x++}return V+w.substring(W,x)}return function W(){var G,V,J;switch(S("~"),V=w.charAt(x)){case"(":if(x++,w.charAt(x)==="~")if(G=[],w.charAt(x+1)===")")x++;else do G.push(W());while(w.charAt(x)==="~");else if(G={},w.charAt(x)!==")")do{var Q=k();G[Q]=W()}while(w.charAt(x)==="~"&&++x);S(")");break;case"'":x++,G=k();break;default:for(J=x++;x<o&&/[^)~]/.test(w.charAt(x));)x++;var oe=w.substring(J,x);if(/[\d\-]/.test(V))G=parseFloat(oe);else if(G=P[oe],typeof G>"u")throw new Error("bad value keyword: "+oe)}return G}()},p.tryParse=function(w,x){try{return p.parse(w)}catch{return x}}})(Y)}}]);

//# sourceMappingURL=2651.4b1b29dde31225e5b5de.js.map