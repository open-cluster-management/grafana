"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9404],{21106:(gr,Ce,m)=>{m.r(Ce),m.d(Ce,{plugin:()=>hr});var at=m(40187),i=m(74848),p=m(2543),I=m(96540),O=m(22391),rt=m(32264),be=m(84167),B=m(88575),V=m(90182),ce=m(42418),st=m(91409),Q=m(14186),A=m(10354);const Ae="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.",G="default";var x=(a=>(a.InfluxQL="InfluxQL",a.Flux="Flux",a.SQL="SQL",a))(x||{}),K=m(39268),de=m(9226);const w=20,nt=a=>{const{options:{jsonData:e,secureJsonData:t,secureJsonFields:r}}=a,s=(0,p.uniqueId)("influxdb-flux-config");return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(K.C,{children:(0,i.jsx)(Q.I,{labelWidth:w,label:"Organization",htmlFor:`${s}-org`,children:(0,i.jsx)(A.p,{id:`${s}-org`,className:"width-20",value:e.organization||"",onChange:(0,O.PG)(a,"organization")})})}),(0,i.jsx)(K.C,{children:(0,i.jsx)(Q.I,{labelWidth:w,label:"Token",children:(0,i.jsx)(de.L4,{isConfigured:!!(r&&r.token),value:t?.token||"",label:"Token","aria-label":"Token",className:"width-20",onReset:()=>(0,O.QP)(a,"token"),onChange:(0,O.mn)(a,"token")})})}),(0,i.jsx)(K.C,{children:(0,i.jsx)(Q.I,{labelWidth:w,label:"Default Bucket",children:(0,i.jsx)(A.p,{className:"width-20",placeholder:"default bucket",value:e.defaultBucket||"",onChange:(0,O.PG)(a,"defaultBucket")})})}),(0,i.jsx)(K.C,{children:(0,i.jsx)(Q.I,{labelWidth:w,label:"Min time interval",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`,children:(0,i.jsx)(A.p,{className:"width-20",placeholder:"10s",value:e.timeInterval||"",onChange:(0,O.PG)(a,"timeInterval")})})})]})};var v=m(32196),H=m(40845),L=m(76892);const Ne=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],Re=a=>{const{options:e,onOptionsChange:t}=a,{database:r,jsonData:s,secureJsonData:n,secureJsonFields:o}=e,l=(0,H.of)(it),u=(0,p.uniqueId)("influxdb-influxql-config");return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ce.F,{severity:"info",title:"Database Access",children:(0,i.jsxs)("p",{children:["Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",(0,i.jsx)("code",{children:"SHOW MEASUREMENTS ON _internal"})," or",(0,i.jsx)("code",{children:'SELECT * FROM "_internal".."database" LIMIT 10'}),(0,i.jsx)("br",{}),(0,i.jsx)("br",{}),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB."]})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,children:"Database"}),className:l.horizontalField,htmlFor:`${u}-db`,children:(0,i.jsx)(A.p,{id:`${u}-db`,className:"width-20",value:s.dbName??r,onChange:c=>{t({...e,database:"",jsonData:{...s,dbName:c.currentTarget.value}})}})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,children:"User"}),className:l.horizontalField,htmlFor:`${u}-user`,children:(0,i.jsx)(A.p,{id:`${u}-user`,className:"width-20",value:e.user||"",onChange:(0,O.zX)(a,"user")})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,children:"Password"}),className:l.horizontalField,children:(0,i.jsx)(de.L4,{isConfigured:!!(o&&o.password),value:n?.password||"",label:"Password","aria-label":"Password",className:"width-20",onReset:()=>(0,O.QP)(a,"password"),onChange:(0,O.mn)(a,"password")})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`,children:"HTTP Method"}),htmlFor:`${u}-http-method`,className:l.horizontalField,children:(0,i.jsx)(V.l6,{inputId:`${u}-http-method`,className:"width-20",value:Ne.find(c=>c.value===e.jsonData.httpMode),options:Ne,defaultValue:e.jsonData.httpMode,onChange:(0,O.BD)(a,"httpMode")})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"}),className:l.horizontalField,children:(0,i.jsx)(A.p,{className:"width-20",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,O.PG)(a,"timeInterval")})})]})},it=a=>({horizontalField:(0,v.css)({justifyContent:"initial",margin:`0 ${a.spacing(.5)} ${a.spacing(.5)} 0`})});var ot=m(15292);const lt=a=>{const{options:e,onOptionsChange:t}=a,{jsonData:r,secureJsonData:s,secureJsonFields:n}=e,o=(0,H.of)(ut),l=(0,p.uniqueId)("influxdb-sql-config");return(0,i.jsxs)("div",{children:[(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,children:"Database"}),className:o.horizontalField,htmlFor:`${l}-dbName`,children:(0,i.jsx)(A.p,{id:`${l}-dbName`,className:"width-20","aria-label":"Database or bucket name",value:r.dbName,onChange:u=>{t({...e,jsonData:{...r,dbName:u.currentTarget.value}})}})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,children:"Token"}),className:o.horizontalField,children:(0,i.jsx)(de.L4,{label:"Token","aria-label":"Token",className:"width-20",value:s?.token||"",onReset:()=>(0,O.QP)(a,"token"),onChange:(0,O.mn)(a,"token"),isConfigured:!!(n&&n.token)})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(L.c,{width:w,children:"Insecure Connection"}),className:o.horizontalField,children:(0,i.jsx)(ot.K,{id:`${l}-insecure-grpc`,value:r.insecureGrpc??!1,onChange:u=>{t({...e,jsonData:{...r,insecureGrpc:u.currentTarget.checked}})}})})]})},ut=a=>({horizontalField:(0,v.css)({justifyContent:"initial",margin:`0 ${a.spacing(.5)} ${a.spacing(.5)} 0`})}),J={[x.InfluxQL]:{label:"InfluxQL",value:x.InfluxQL,description:"The InfluxDB SQL-like query language."},[x.SQL]:{label:"SQL",value:x.SQL,description:"Native SQL language. Supported in InfluxDB 3.0"},[x.Flux]:{label:"Flux",value:x.Flux,description:"Supported in InfluxDB 2.x and 1.8+"}},ct=[J[x.InfluxQL],J[x.SQL],J[x.Flux]];class dt extends I.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.versionNotice={Flux:"Support for Flux in Grafana is currently in beta",SQL:"Support for SQL in Grafana is currently in alpha"},this.onVersionChanged=t=>{const{options:r,onOptionsChange:s}=this.props,n={...r,jsonData:{...r.jsonData,version:t.value}};if(t.value===x.Flux){n.access="proxy",n.basicAuth=!0,n.jsonData.httpMode="POST";const{user:o,database:l,...u}=n;s(u)}else s(n)},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,p.uniqueId)("influxdb-config")}renderJsonDataOptions(){switch(this.props.options.jsonData.version){case x.InfluxQL:return(0,i.jsx)(Re,{...this.props});case x.Flux:return(0,i.jsx)(nt,{...this.props});case x.SQL:return(0,i.jsx)(lt,{...this.props});default:return(0,i.jsx)(Re,{...this.props})}}render(){const{options:e,onOptionsChange:t}=this.props,r=e.access==="direct";return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(be.n,{children:[(0,i.jsx)("h3",{className:"page-heading",children:"Query language"}),(0,i.jsx)(B.D,{children:(0,i.jsx)(V.l6,{"aria-label":"Query language",className:"width-30",value:J[e.jsonData.version??x.InfluxQL],options:ct,defaultValue:J[x.InfluxQL],onChange:this.onVersionChanged})})]}),e.jsonData.version!==x.InfluxQL&&(0,i.jsx)(ce.F,{severity:"info",title:this.versionNotice[e.jsonData.version],children:(0,i.jsxs)("p",{children:["Please report any issues to: ",(0,i.jsx)("br",{}),(0,i.jsx)("a",{href:"https://github.com/grafana/grafana/issues/new/choose",children:"https://github.com/grafana/grafana/issues"})]})}),r&&(0,i.jsx)(ce.F,{title:"Error",severity:"error",children:Ae}),(0,i.jsx)(st.t,{showAccessOptions:r,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t,secureSocksDSProxyEnabled:rt.$.secureSocksDSProxyEnabled}),(0,i.jsxs)(be.n,{children:[(0,i.jsx)("h3",{className:"page-heading",children:"InfluxDB Details"}),this.renderJsonDataOptions(),(0,i.jsx)(Q.I,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000.",children:(0,i.jsx)(A.p,{placeholder:"1000",type:"number",className:"width-20",value:this.state.maxSeries,onChange:s=>{this.setState({maxSeries:s.currentTarget.value});const n=parseInt(s.currentTarget.value,10);(0,O.lO)(this.props,"maxSeries",Number.isFinite(n)?n:void 0)}})})]})]})}}const mt=dt;var z=m(54479),E=m(1062);const me=[],S={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Oe(a){const e=me[a.type];if(!e)throw{message:"Could not find query part "+a.type};return new E.kW(a,e)}function T(a){me[a.type]=new E.tI(a),a.category.push(me[a.type])}const he=[];function ht(a,e){return e+' AS "'+a.params[0]+'"'}function Le(a){const e=a.params[0];if(e==="*")return"*";let t=`"${e}"`;return e.endsWith("::tag")&&(t=`"${e.slice(0,-5)}"::tag`),e.endsWith("::field")&&(t=`"${e.slice(0,-7)}"::field`),t}function N(a,e){for(let t=0;t<a.length;t++){const r=a[t];if(r.def.category===S.Aggregations){if(r.def.type===e.def.type)return;if(r.def.type==="count"&&e.def.type==="distinct")break;if(r.def.type==="distinct"){const s=a.length>=t+2;if(e.def.type!=="count"&&s)a[t+1].def.category===S.Aggregations&&a.splice(t+1,1);else if(e.def.type==="count"){(!s||a[t+1].def.type!=="count")&&a.splice(t+1,0,e);return}}a[t]=e;return}if(r.def.category===S.Selectors){a[t]=e;return}}a.splice(1,0,e)}function j(a,e){let t;for(t=0;t<a.length;t++){const r=a[t];if(r.def.category===S.Math||r.def.category===S.Aliasing)break}a.splice(t,0,e)}function pt(a,e){const t=a.length;if(t>0){if(a[t-1].def.type==="math"){a[t-1]=e;return}if(t>1&&a[t-2].def.type==="math"){a[t-2]=e;return}else if(a[t-1].def.type==="alias"){a.splice(t-1,0,e);return}}a.push(e)}function ft(a,e){const t=a.length;if(t>0&&a[t-1].def.type==="alias"){a[t-1]=e;return}a.push(e)}function gt(a,e,t){const r=(0,p.map)(a,s=>Oe({type:s.def.type,params:(0,p.clone)(s.params)}));t.selectModels.push(r)}T({type:"field",addStrategy:gt,category:S.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:Le}),T({type:"count",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"distinct",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"integral",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"mean",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"median",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"mode",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"sum",addStrategy:N,category:S.Aggregations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"derivative",addStrategy:j,category:S.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:E.Wn}),T({type:"spread",addStrategy:j,category:S.Transformations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"non_negative_derivative",addStrategy:j,category:S.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:E.Wn}),T({type:"difference",addStrategy:j,category:S.Transformations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"non_negative_difference",addStrategy:j,category:S.Transformations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"moving_average",addStrategy:j,category:S.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:E.Wn}),T({type:"cumulative_sum",addStrategy:j,category:S.Transformations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"stddev",addStrategy:j,category:S.Transformations,params:[],defaultParams:[],renderer:E.Wn}),T({type:"time",category:he,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:E.Wn}),T({type:"fill",category:he,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:E.Wn}),T({type:"elapsed",addStrategy:j,category:S.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:E.Wn}),T({type:"holt_winters",addStrategy:j,category:S.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:E.Wn}),T({type:"holt_winters_with_fit",addStrategy:j,category:S.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:E.Wn}),T({type:"bottom",addStrategy:N,category:S.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:E.Wn}),T({type:"first",addStrategy:N,category:S.Selectors,params:[],defaultParams:[],renderer:E.Wn}),T({type:"last",addStrategy:N,category:S.Selectors,params:[],defaultParams:[],renderer:E.Wn}),T({type:"max",addStrategy:N,category:S.Selectors,params:[],defaultParams:[],renderer:E.Wn}),T({type:"min",addStrategy:N,category:S.Selectors,params:[],defaultParams:[],renderer:E.Wn}),T({type:"percentile",addStrategy:N,category:S.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:E.Wn}),T({type:"top",addStrategy:N,category:S.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:E.Wn}),T({type:"tag",category:he,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:Le}),T({type:"math",addStrategy:pt,category:S.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:E.Dw}),T({type:"alias",addStrategy:ft,category:S.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:ht});const $={create:Oe,getCategories:()=>S,replaceAggregationAdd:N};class M{constructor(e,t,r){this.selectModels=[],this.groupByParts=[],this.target=e,this.templateSrv=t,this.scopedVars=r,e.policy=e.policy||G,e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,p.map)(this.target.select,e=>(0,p.map)(e,$.create)),this.groupByParts=(0,p.map)(this.target.groupBy,$.create)}updatePersistedParts(){this.target.select=(0,p.map)(this.selectModels,e=>(0,p.map)(e,t=>({type:t.def.type,params:t.params})))}hasGroupByTime(){return(0,p.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,p.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const r=t[1],s=t[2],n=$.create({type:r,params:[s]}),o=this.target.groupBy.length;o===0?this.target.groupBy.push(n.part):r==="time"?this.target.groupBy.splice(0,0,n.part):r==="tag"?this.target.groupBy[o-1].type==="fill"?this.target.groupBy.splice(o-1,0,n.part):this.target.groupBy.push(n.part):this.target.groupBy.push(n.part),this.updateProjection()}removeGroupByPart(e,t){const r=$.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,p.filter)(this.target.groupBy,s=>s.type!=="fill"),this.target.select=(0,p.map)(this.target.select,s=>(0,p.filter)(s,n=>{const o=$.create(n);return!(o.def.category===r.Aggregations||o.def.category===r.Selectors)}))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if(t.def.type==="field"){if(this.selectModels.length>1){const r=(0,p.indexOf)(this.selectModels,e);this.selectModels.splice(r,1)}}else{const r=(0,p.indexOf)(e,t);e.splice(r,1)}this.updatePersistedParts()}addSelectPart(e,t){const r=$.create({type:t});r.def.addStrategy(e,r,this),this.updatePersistedParts()}isOperatorTypeHandler(e,t,r){let s;if(e==="Is Not"?e="!=":e="=",r.endsWith("::tag"))return s="'"+se(t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'"))+"'",{operator:e,value:s};let n=t.toLowerCase();return isNaN(parseFloat(t))?["true","false"].includes(n)?s=n:s="'"+se(t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'"))+"'":s=t,{operator:e,value:s}}renderTagCondition(e,t,r){let s="",n=e.operator,o=e.value;if(t>0&&(s=(e.condition||"AND")+" "),n||(/^\/.*\/$/.test(o)?n="=~":n="="),n!=="=~"&&n!=="!~")if(r&&(o=this.templateSrv.replace(o,this.scopedVars)),o=se(o),n.startsWith("Is")){let u=this.isOperatorTypeHandler(n,o,e.key);n=u.operator,o=u.value}else(!n.startsWith(">")&&!n.startsWith("<")||n==="<>")&&(o="'"+o.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'");else r&&(o=this.templateSrv.replace(o,this.scopedVars,"regex"));let l=`"${e.key}"`;return e.key.endsWith("::tag")&&(l=`"${e.key.slice(0,-5)}"::tag`),e.key.endsWith("::field")&&(l=`"${e.key.slice(0,-7)}"::field`),s+l+" "+n+" "+o}getMeasurementAndPolicy(e){let t=this.target.policy,r=this.target.measurement||"measurement";return r.match("^/.*/$")?e&&(r=this.templateSrv.replace(r,this.scopedVars,"regex")):r='"'+r+'"',t!==G?t='"'+this.target.policy+'".':t="",t+r}interpolateQueryStr(e,t){return!t.multi&&!t.includeAll?e:typeof e=="string"?(0,z.$f)(e):"("+(0,p.map)(e,z.$f).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let r="SELECT ",s,n;for(s=0;s<this.selectModels.length;s++){const u=this.selectModels[s];let c="";for(n=0;n<u.length;n++)c=u[n].render(c);s>0&&(r+=", "),r+=c}r+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const o=(0,p.map)(t.tags,(u,c)=>this.renderTagCondition(u,c,e));o.length>0&&(r+="("+o.join(" ")+") AND "),r+="$timeFilter";let l="";for(s=0;s<this.groupByParts.length;s++){const u=this.groupByParts[s];s>0&&(l+=u.def.type==="fill"?" ":", "),l+=u.render("")}return l.length&&(r+=" GROUP BY "+l),t.fill&&(r+=" fill("+t.fill+")"),t.orderByTime==="DESC"&&(r+=" ORDER BY time DESC"),t.limit&&(r+=" LIMIT "+t.limit),t.slimit&&(r+=" SLIMIT "+t.slimit),t.tz&&(r+=" tz('"+t.tz+"')"),r}renderAdhocFilters(e){return(0,p.map)(e,(r,s)=>this.renderTagCondition(r,s,!0)).join(" ")}}function we(a){const e=(0,p.cloneDeep)(a);return new M(e).render(!1)}function yt(a){if(a.policy!==void 0&&a.resultFormat!==void 0&&a.orderByTime!==void 0&&a.tags!==void 0&&a.groupBy!==void 0&&a.select!==void 0)return a;const e=(0,p.cloneDeep)(a);return new M(e).target}function xt(a,e,t){const r=(0,p.cloneDeep)(a),s=new M(r);return s.addSelectPart(s.selectModels[t],e),s.target}function St(a,e,t){const r=(0,p.cloneDeep)(a),s=new M(r),n=s.selectModels[t];return s.removeSelectPart(n,n[e]),s.target}function Tt(a,e,t,r){const s=[...a.select??[]];return s[e]=[...s[e]],s[e][t]={...s[e][t],params:r},{...a,select:s}}function Et(a,e){const t=(0,p.cloneDeep)(a),r=new M(t);return r.addGroupBy(e),r.target}function vt(a,e){const t=(0,p.cloneDeep)(a),r=new M(t);return r.removeGroupByPart(r.groupByParts[e],e),r.target}function It(a,e,t){const r=[...a.groupBy??[]];return r[e]={...r[e],params:t},{...a,groupBy:r}}function se(a){const e=/\/\^(.*?)\$\//,t=a.match(e);return t&&t.length>1?t[1]:a}var Z=m(72574),q=m(19716),Ct=m(32372),ne=m(55852),bt=m(38401),U=m(38894);const At=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class Nt extends I.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e})},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:q.q.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:q.q.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:q.q.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:q.q.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:q.q.Property,detail:"org configured for the datsource"}],t=(0,Z.w)();return t.getVariables().forEach(r=>{const s="${"+r.name+"}";let n=t.replace(s);n===s&&(n=""),e.push({label:s,kind:q.q.Text,detail:`(Template Variable) ${n}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:t}=this.props,r=Rt(t),s=(0,i.jsxs)("div",{children:["Type: ",(0,i.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,i.jsx)("br",{}),"Many queries can be copied from Chronograf"]});return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(Ct.B,{height:"100%",containerStyles:r.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),(0,i.jsxs)("div",{className:(0,v.cx)("gf-form-inline",r.editorActions),children:[(0,i.jsx)(ne.z9,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/",children:"Flux language syntax"}),(0,i.jsx)(bt.Y,{options:At,value:"Sample query",onChange:this.onSampleChange,className:(0,v.css)`
              margin-top: -${t.spacing(.5)};
              margin-left: ${t.spacing(.5)};
            `}),(0,i.jsx)("div",{className:"gf-form gf-form--grow",children:(0,i.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}),(0,i.jsx)(U.I,{width:5,tooltip:s,children:"Help"})]})]})}}const Rt=a=>({editorContainerStyles:(0,v.css)`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${a.isDark?a.colors.background.canvas:a.colors.background.primary};
    padding-bottom: ${a.spacing(1)};
  `,editorActions:(0,v.css)`
    margin-top: 6px;
  `}),pe=(0,H.cV)(Nt);var Y=m(87774),C=m(98765);function Ot(a){const e=[];for(const t of a){let r="text";switch(t.type?.toUpperCase()){case"BOOLEAN":case"BOOL":{r="boolean";break}case"BYTES":case"VARCHAR":{r="text";break}case"FLOAT":case"FLOAT64":case"INT":case"INTEGER":case"INT64":case"NUMERIC":case"BIGNUMERIC":{r="number";break}case"DATE":{r="date";break}case"TIMESTAMP(NANOSECOND, NONE)":case"DATETIME":{r="datetime";break}case"TIME":{r="time";break}case"TIMESTAMP":{r="datetime";break}case"GEOGRAPHY":{r="text";break}default:break}e.push({...t,raqbFieldType:r,icon:Lt(t.type.toUpperCase())})}return e}function Lt(a){switch(a){case"TIME":case"DATETIME":case"TIMESTAMP":return"clock-nine";case"BOOLEAN":return"toggle-off";case"INTEGER":case"FLOAT":case"FLOAT64":case"INT":case"SMALLINT":case"BIGINT":case"TINYINT":case"BYTEINT":case"INT64":case"NUMERIC":case"DECIMAL":return"calculator-alt";case"CHAR":case"VARCHAR":case"STRING":case"BYTES":case"TEXT":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":return"text";case"GEOGRAPHY":return"map";default:return}}function wt(a){return a[0]==='"'&&a[a.length-1]==='"'?a.substring(1,a.length-1).replace(/""/g,'"'):a[0]==="`"&&a[a.length-1]==="`"?a.substring(1,a.length-1):a}function De(a){return"'"+a.replace(/'/g,"''")+"'"}function Pe({sql:a,table:e}){let t="";if(!a||!(0,Y.YW)(a.columns))return t;const r=a.columns.map(s=>({...s,parameters:s.parameters?.map(n=>({...n,name:Dt(n.name)}))}));if(t+=(0,Y.oF)(r),e&&(t+=`FROM "${e}" `),t+='WHERE "time" >= $__timeFrom AND "time" <= $__timeTo ',a.whereString){const s=new RegExp("(\\s?)([^\\(]\\S+)(\\s?=)","g"),o=a.whereString.replace(s,'$1"$2"$3');t+=`AND ${o} `}if(a.groupBy?.[0]?.property.name){const s=a.groupBy.map(n=>`"${n.property.name}"`).filter(n=>!(0,p.isEmpty)(n));t+=`GROUP BY ${s.join(", ")} `}return a.orderBy?.property.name&&(t+=`ORDER BY "${a.orderBy.property.name}" `),a.orderBy?.property.name&&a.orderByDirection&&(t+=`${a.orderByDirection} `),Pt(a.limit)&&(t+=`LIMIT ${a.limit}`),t}function Dt(a){return a==="*"?a:`"${a}"`}const Pt=a=>a!==void 0&&a>=0;function fe(a){return jt(a)?a:`"${a}"`}function jt(a){const e=/^[a-zA-Z_][a-zA-Z0-9_$]*$/g.test(a);return!Ft.includes(a.toUpperCase())&&e}const Ft=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CUBE","CUME_DIST","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DENSE_RANK","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","EMPTY","ENCLOSED","ESCAPED","EXCEPT","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FIRST_VALUE","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","FUNCTION","GENERATED","GET","GRANT","GROUP","GROUPING","GROUPS","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERSECT","INTERVAL","INTO","IO_AFTER_GTIDS","IO_BEFORE_GTIDS","IS","ITERATE","JOIN","JSON_TABLE","KEY","KEYS","KILL","LAG","LAST_VALUE","LATERAL","LEAD","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_BIND","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MAXVALUE","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NTH_VALUE","NTILE","NULL","NUMERIC","OF","ON","OPTIMIZE","OPTIMIZER_COSTS","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","OVER","PARTITION","PERCENT_RANK","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","RANK","READ","READS","READ_WRITE","REAL","RECURSIVE","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESIGNAL","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","ROW","ROWS","ROW_NUMBER","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SIGNAL","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STORED","STRAIGHT_JOIN","SYSTEM","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","VIRTUAL","WHEN","WHERE","WHILE","WINDOW","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"];function Mt(a){return`SELECT table_name FROM information_schema.tables WHERE table_schema = ${a!==void 0?_(a):"database()"} ORDER BY table_name`}function yr(){return"SELECT DISTINCT TABLE_SCHEMA from information_schema.TABLES where TABLE_TYPE != 'SYSTEM VIEW' ORDER BY TABLE_SCHEMA"}function Bt(a,e){let t="SELECT column_name, data_type FROM information_schema.columns WHERE ";return t+=Qt(a,e),t+=" ORDER BY column_name",t}function Qt(a,e){let t="";if(a.includes(".")){const r=a.split(".");return t="table_schema = "+_(r[0]),t+=" AND table_name = "+_(r[1]),t}else return t=`table_schema = ${e!==void 0?_(e):"database()"} AND table_name = `+_(a),t}function _(a){return De(wt(a))}var kt=m(33125);const $t=({getMeta:a})=>(e,t)=>({...t&&(0,kt.N)(e,t),customStatementPlacement:Wt,customSuggestionKinds:Vt(a)}),je={afterDatabase:"afterDatabase"},Ut={tablesWithinDatabase:"tablesWithinDatabase"},ge="FROM",Wt=()=>[{id:je.afterDatabase,resolve:(a,e,t)=>!!(a?.is(C.ks.Delimiter,".")&&e?.value===ge&&(t?.is(C.ks.IdentifierQuote)||t?.isIdentifier())&&a?.getPreviousUntil(C.ks.Keyword,[C.ks.IdentifierQuote],ge)?.filter(r=>r.isIdentifier()).length===1)}],Vt=a=>()=>[{id:C.ng.Tables,overrideDefault:!0,suggestionsResolver:async e=>{const t=xe(e.currentToken);return(await a({schema:t})).map(ye(e))}},{id:C.ng.Columns,overrideDefault:!0,suggestionsResolver:async e=>{const t=zt(e.currentToken),r=xe(t),s=Gt(t);return!r||!s?[]:(await a({schema:r,table:s})).map(ye(e))}},{id:Ut.tablesWithinDatabase,applyTo:[je.afterDatabase],suggestionsResolver:async e=>{const t=xe(e.currentToken);return(await a({schema:t})).map(ye(e))}}];function ye(a){return function(e){return{label:e.name,insertText:e.completion??e.name,command:{id:"editor.action.triggerSuggest",title:""},kind:C.Io.Field,sortText:C.mY.High,range:{...a.range,startColumn:a.range.endColumn,endColumn:a.range.endColumn}}}}function xe(a){if(a?.isIdentifier()&&a.value[a.value.length-1]!==".")return a.value;if(a?.is(C.ks.Delimiter,"."))return a.getPreviousOfType(C.ks.Identifier)?.value;if(a?.is(C.ks.IdentifierQuote))return a.getPreviousOfType(C.ks.Identifier)?.value||a.getNextOfType(C.ks.Identifier)?.value}function Gt(a){return a?.getNextOfType(C.ks.Identifier)?.value}const Ht=a=>(a?.getPreviousOfType(C.ks.Keyword,"SELECT")??null)?.getNextOfType(C.ks.Keyword,ge),zt=a=>{const t=Ht(a)?.getNextOfType(C.ks.Identifier);return t?.isKeyword()&&t.next?.is(C.ks.Parenthesis,"(")?null:t};class Yt extends Y.oK{constructor(e,t=(0,Z.w)()){super(e),this.instanceSettings=e,this.templateSrv=t}getQueryModel(){return{quoteLiteral:De}}getSqlLanguageDefinition(){if(this.sqlLanguageDefinition!==void 0)return this.sqlLanguageDefinition;const e={getMeta:t=>this.fetchMeta(t)};return this.sqlLanguageDefinition={id:"flightsql",completionProvider:$t(e),formatter:Y.se},this.sqlLanguageDefinition}async fetchDatasets(){return Promise.resolve(["iox"])}async fetchTables(e){const t=Mt(e),s=(await this.runSql(t,{refId:"tables"})).map(n=>fe(n[0]));return s.unshift(...this.getTemplateVariables()),s}async fetchFields(e){if(!e.dataset||!e.table)return[];const t=this.templateSrv.replace(e.table),r=Bt(t,e.dataset),n=(await this.runSql(r,{refId:"fields"})).map(o=>({name:o[0],text:o[0],value:fe(o[0]),type:o[1],label:o[0]}));return n.unshift(...this.getTemplateVariables().map(o=>({name:o,text:o,value:fe(o),type:"",label:o}))),Ot(n)}getTemplateVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}async fetchMeta(e){const t=this.instanceSettings.jsonData.database;return!e?.schema&&t?(await this.fetchTables(t)).map(s=>({name:s,completion:`${t}.${s}`,kind:C.Io.Class})):!e?.schema&&!t?(await this.fetchDatasets()).map(s=>({name:s,completion:`${s}.`,kind:C.Io.Module})):!e?.table&&(!t||e?.schema)?(await this.fetchTables(e?.schema)).map(s=>({name:s,completion:s,kind:C.Io.Class})):e?.table&&e.schema?(await this.fetchFields({dataset:e.schema,table:e.table})).map(s=>({name:s.name,completion:s.value,kind:C.Io.Field})):[]}getDB(){return this.db!==void 0?this.db:{datasets:()=>this.fetchDatasets(),tables:e=>this.fetchTables(e),fields:e=>this.fetchFields(e),validateQuery:(e,t)=>Promise.resolve({query:e,error:"",isError:!1,isValid:!0}),dsID:()=>this.id,toRawSql:Pe,functions:()=>["VARIANCE","STDDEV"],getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition()}}}class Kt extends I.PureComponent{constructor(e){super(e);const{datasource:t}=e;this.datasource=new Yt({url:t.urls[0],access:t.access,id:t.id,jsonData:{allowCleartextPasswords:!1,tlsAuth:!1,tlsAuthWithCACert:!1,tlsSkipVerify:!1,maxIdleConns:1,maxOpenConns:1,maxIdleConnsAuto:!0,connMaxLifetime:1,timezone:"",user:"",database:"",url:t.urls[0],timeInterval:""},meta:t.meta,name:t.name,readOnly:!1,type:t.type,uid:t.uid},t.templateSrv)}transformQuery(e){const t=(0,Y.To)(e);return{...t,dataset:"iox",sql:{...t.sql,limit:void 0}}}render(){const{query:e,theme:t,onRunQuery:r,onChange:s}=this.props,n=qt(t),o=()=>r(),l=c=>{s({...c})},u=(0,i.jsxs)("div",{children:["Type: ",(0,i.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,i.jsx)("br",{}),"Many queries can be copied from Chronograf"]});return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(Y.e_,{datasource:this.datasource,query:this.transformQuery(e),onRunQuery:o,onChange:l,queryHeaderProps:{dialect:"influx"}}),(0,i.jsxs)("div",{className:(0,v.cx)("gf-form-inline",n.editorActions),children:[(0,i.jsx)(ne.z9,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/cloud-serverless/query-data/sql/",children:"SQL language syntax"}),(0,i.jsx)("div",{className:"gf-form gf-form--grow",children:(0,i.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}),(0,i.jsx)(U.I,{width:5,tooltip:u,children:"Help"})]})]})}}const qt=a=>({editorContainerStyles:(0,v.css)`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${a.isDark?a.colors.background.canvas:a.colors.background.primary};
    padding-bottom: ${a.spacing(1)};
  `,editorActions:(0,v.css)`
    margin-top: 6px;
  `}),Xt=(0,H.cV)(Kt);var Jt=m(96374);const Zt=({isRaw:a,onChange:e})=>{const[t,r]=(0,I.useState)(!1);return(0,I.useEffect)(()=>{r(!1)},[a]),a?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ne.$n,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{r(!0)}}),(0,i.jsx)(Jt.u,{isOpen:t,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{r(!1)}})]}):(0,i.jsx)(ne.$n,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var k=m(67061),Fe=m(21744);const Me=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],Be="time_series";var _t=m(84596);function ie(a){const[e,t]=(0,I.useState)(a),r=(0,_t.A)(a);return(0,I.useEffect)(()=>{r!==a&&e!==a&&t(a)},[a,e,r]),[e,t]}const ea=({query:a,onChange:e,onRunQuery:t})=>{const[r,s]=ie(a.query),[n,o]=ie(a.alias),l=(0,I.useId)(),u=(0,I.useId)(),c=a.resultFormat??Be,h=()=>{e({...a,query:r,alias:n,resultFormat:c}),t()};return(0,i.jsxs)(k.B,{direction:"column",children:[(0,i.jsx)(Fe.f,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:h,onChange:d=>{s(d.currentTarget.value)},value:r??""}),(0,i.jsxs)(k.B,{children:[(0,i.jsx)(Q.I,{htmlFor:u,label:"Format as",children:(0,i.jsx)(V.l6,{inputId:u,onChange:d=>{e({...a,resultFormat:d.value}),t()},value:c,options:Me})}),(0,i.jsx)(Q.I,{htmlFor:l,label:"Alias by",children:(0,i.jsx)(A.p,{id:l,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:h,onChange:d=>{o(d.currentTarget.value)},value:n??""})})]})]})};var X=m(64765),Qe=m(2913);const Se=a=>{let e="",{type:t,templateService:r,scopedVars:s,database:n,measurement:o,retentionPolicy:l,tags:u,withKey:c,withMeasurementFilter:h}=a;switch(t){case"RETENTION_POLICIES":return'SHOW RETENTION POLICIES on "'+n+'"';case"FIELDS":return!o||o===""?"SHOW FIELD KEYS":(o&&!o.match(/^\/.*\/|^$/)&&(o='"'+o+'"',l&&l!==G&&(l='"'+l+'"',o=l+"."+o)),"SHOW FIELD KEYS FROM "+o);case"TAG_KEYS":e="SHOW TAG KEYS";break;case"TAG_VALUES":e="SHOW TAG VALUES";break;case"MEASUREMENTS":e="SHOW MEASUREMENTS",h&&(e+=" WITH MEASUREMENT =~ /(?i)"+(0,z.$f)(h)+"/");break;default:return e}if(o&&(!o.match("^/.*/")&&!o.match(/^merge\(.*\)/)&&(o='"'+o+'"'),l&&l!==G&&(l='"'+l+'"',o=l+"."+o),o!==""&&(e+=" FROM "+o)),c){let d=c;d.endsWith("::tag")&&(d=d.slice(0,-5)),e+=' WITH KEY = "'+d+'"'}if(u&&u.length>0){const d=(0,p.reduce)(u,(f,g)=>(g.key&&g.key===c||g.operator===">"||g.operator==="<"||f.push(ta(g,f.length,r,s,!0)),f),[]);d.length>0&&(e+=" WHERE "+d.join(" "))}return t==="MEASUREMENTS"&&(e+=" LIMIT 100"),e};function ta(a,e,t,r,s){let n="",o=a.operator,l=a.value;e>0&&(n=(a.condition||"AND")+" "),o||(/^\/.*\/$/.test(a.value)?o="=~":o="="),(l===""||o!=="=~"&&o!=="!~")&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),o!=="=~"&&o!=="!~"?s?l=t.replace(l,r):o!==">"&&o!=="<"&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"):s&&(l=t.replace(l,r,"regex"));let u=`"${a.key}"`;return a.key.endsWith("::tag")&&(u=`"${a.key.slice(0,-5)}"::tag`),a.key.endsWith("::field")&&(u=`"${a.key.slice(0,-7)}"::field`),n+u+" "+o+" "+l}const ee=async a=>{const{type:e,datasource:t,scopedVars:r,measurement:s,retentionPolicy:n,tags:o,withKey:l,withMeasurementFilter:u}=a,c=Se({type:e,scopedVars:r,measurement:s,retentionPolicy:n,tags:o,withKey:l,withMeasurementFilter:u,templateService:t.templateSrv,database:t.database}),h=n?t.templateSrv.replace(n,{},"regex"):"",d={query:c,policy:h,rawQuery:!0,refId:"metadataQuery"};if(Qe.Ay.featureToggles.influxdbBackendMigration)return t.runMetadataQuery(d);{const f={policy:d.policy};return t.metricFindQuery({refId:"run-explore-query",query:c},f)}};async function aa(a){return(await ee({type:"RETENTION_POLICIES",datasource:a})).map(t=>t.text)}async function ra(a,e,t){return(await ee({type:"MEASUREMENTS",datasource:a,tags:e,withMeasurementFilter:t})).map(s=>s.text)}async function sa(a,e,t){return(await ee({type:"TAG_KEYS",datasource:a,measurement:e,retentionPolicy:t})).map(s=>s.text)}async function na(a,e,t,r,s){return t.endsWith("::field")?[]:(await ee({type:"TAG_VALUES",tags:e,withKey:t,datasource:a,measurement:r,retentionPolicy:s})).map(o=>o.text)}async function ke(a,e,t){return(await ee({type:"FIELDS",datasource:a,measurement:e,retentionPolicy:t})).map(s=>s.text)}function $e(a,e){return a.filter(t=>t.key.endsWith("::tag")||e.has(t.key+"::tag"))}function D(a){return{label:a,value:a}}function te(a){if(a==null)throw new Error("value must not be nullish");return a}function ia(){const a=$.getCategories(),e=[];return Object.keys(a).forEach(r=>{const s=a[r].map(n=>D(n.type));e.push({label:r,options:s})}),e}async function oa(a,e){const t=await e(),r={...a},s=new M(r),n=[];return s.hasFill()||n.push(D("fill(null)")),s.hasGroupByTime()||n.push(D("time($interval)")),t.forEach(o=>{n.push(D(`tag(${o})`))}),n}function la(a,e){const t=$.create(a).def,r=(a.params??[]).map(s=>s.toString());if(r.length!==t.params.length)throw new Error("Invalid query-segment");return r.map((s,n)=>{const o=t.params[n];return o.dynamicLookup?{value:s,options:te(e.get(`${t.type}_${n}`))}:o.options!=null?{value:s,options:()=>Promise.resolve(o.options)}:{value:s,options:null}})}function Ue(a,e){return a.map(t=>({name:t.type,params:la(t,e)}))}function ua(a){return(0,Z.w)().getVariables().map(a)}function Te(a,e,t){let r=ua(e);return t&&(r=r.filter(s=>s.indexOf(t)>-1)),a.then(s=>[...r,...s])}function We(a){return`/^$${a.name}$/`}function ca(a){return`$${a.name}`}const Ee=(0,v.css)({paddingRight:"4px"}),da=(0,v.cx)("width-8",Ee),ma=({format:a,inputId:e,onChange:t})=>(0,i.jsx)(V.l6,{inputId:e,className:da,onChange:r=>{t(te(r.value))},value:a,options:Me});var ve=m(3721),ha=m(76459),pa=m.n(ha),fa=m(41053);const Ve=(0,v.css)({minWidth:"160px"}),Ge=a=>a,ga=({loadOptions:a,allowCustomValue:e,onChange:t,onClose:r})=>{const s=pa()(a,1e3,{leading:!0});return(0,i.jsx)("div",{className:Ve,children:(0,i.jsx)(V.DW,{formatCreateLabel:Ge,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:r,allowCustomValue:e,loadOptions:s,onChange:t,createOptionPosition:"first"})})},ya=({loadOptions:a,allowCustomValue:e,onChange:t,onClose:r})=>{const[s,n]=(0,fa.A)(a,[a]);return(0,I.useEffect)(()=>{n("")},[n,a]),(0,i.jsx)("div",{className:Ve,children:(0,i.jsx)(V.l6,{isLoading:s.loading,formatCreateLabel:Ge,autoFocus:!0,isOpen:!s.loading,onCloseMenu:r,allowCustomValue:e,options:s.value??[],onChange:t,createOptionPosition:"first"})})},xa=({loadOptions:a,filterByLoadOptions:e,allowCustomValue:t,onChange:r,onClose:s})=>e?(0,i.jsx)(ga,{loadOptions:a,allowCustomValue:t,onChange:r,onClose:s}):(0,i.jsx)(ya,{loadOptions:a,allowCustomValue:t,onChange:r,onClose:s}),Sa=({initialValue:a,onChange:e,onClose:t})=>{const[r,s]=ie(a);return(0,i.jsx)(A.p,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:t,onKeyDown:n=>{n.key==="Enter"&&e(r)},onChange:n=>{s(n.currentTarget.value)},value:r})},Ta=(0,v.css)({width:"auto",cursor:"pointer"}),W=({value:a,buttonClassName:e,loadOptions:t,filterByLoadOptions:r,allowCustomValue:s,onChange:n})=>{const[o,l]=(0,I.useState)(!1);if(o)return t!==void 0?(0,i.jsx)(xa,{loadOptions:t,filterByLoadOptions:r??!1,allowCustomValue:s,onChange:u=>{l(!1),n(u)},onClose:()=>{l(!1)}}):(0,i.jsx)(Sa,{initialValue:a,onClose:()=>{l(!1)},onChange:u=>{l(!1),n({value:u,label:u})}});{const u=(0,v.cx)(Ta,e);return(0,i.jsx)(L.c,{as:"button",className:u,onClick:()=>{l(!0)},children:a})}},Ea=({policy:a,measurement:e,onChange:t,getPolicyOptions:r,getMeasurementOptions:s})=>{const n=async()=>{const l=await r();return(l.some(c=>c===G)?l:[G,...l]).map(D)},o=async l=>(await s(l)).map(D);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(W,{allowCustomValue:!0,value:a??"using default policy",loadOptions:n,onChange:l=>{t(l.value,e)}}),(0,i.jsx)(W,{allowCustomValue:!0,value:e??"select measurement",loadOptions:o,filterByLoadOptions:!0,onChange:l=>{t(a,l.value)}}),e&&(0,i.jsx)(ve.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{t(a,void 0)}})]})},oe=({value:a,onChange:e,isWide:t,placeholder:r})=>{const[s,n]=ie(a),o=()=>{e(s===""?void 0:s)};return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(A.p,{placeholder:r,className:(0,v.cx)(t??!1?"width-14":"width-8",Ee),type:"text",spellCheck:!1,onBlur:o,onChange:l=>{n(l.currentTarget.value)},value:s??""})})},va=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],Ia=(0,v.cx)("width-9",Ee),Ca=({value:a,onChange:e,inputId:t})=>(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(V.l6,{inputId:t,className:Ia,onChange:r=>{e(te(r.value))},value:a,options:va})}),He=({loadOptions:a,allowCustomValue:e,onAdd:t})=>(0,i.jsx)(W,{value:"+",loadOptions:a,allowCustomValue:e,onChange:r=>{t(te(r.value))}}),ba=(0,v.css)({paddingRight:"0",marginRight:"0"}),Aa=(0,v.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),Na=a=>(0,v.cx)("gf-form-label",(0,v.css)({paddingLeft:"0",lineHeight:a.typography.body.lineHeight,fontSize:a.typography.body.fontSize})),Ra=({name:a,params:e,onChange:t})=>{const r=(0,H.$j)(),s=(0,I.useMemo)(()=>Na(r),[r]),n=(o,l)=>{const u=e.map(c=>c.value);u[l]=o,t(u)};return(0,i.jsxs)("div",{className:s,children:[(0,i.jsx)("button",{className:(0,v.cx)("gf-form-label",ba),children:a}),"(",e.map((o,l)=>{const{value:u,options:c}=o,h=l===e.length-1,d=c!==null?()=>c().then(f=>f.map(D)):void 0;return(0,i.jsxs)(I.Fragment,{children:[(0,i.jsx)(W,{allowCustomValue:!0,value:u,buttonClassName:Aa,loadOptions:d,onChange:f=>{n(te(f.value),l)}}),!h&&","]},l)}),")"]})},ze=({parts:a,getNewPartOptions:e,onAddNewPart:t,onRemovePart:r,onChange:s})=>(0,i.jsxs)(i.Fragment,{children:[a.map((n,o)=>(0,i.jsxs)(I.Fragment,{children:[(0,i.jsx)(Ra,{name:n.name,params:n.params,onRemove:()=>{r(o)},onChange:l=>{s(o,l)}}),(0,i.jsx)(ve.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{r(o)}})]},o)),(0,i.jsx)(He,{loadOptions:e,onAdd:t})]});function Ye(a){return/^\/.*\/$/.test(a)}function Ke(a){return a.operator??(Ye(a.value)?"=~":"=")}function qe(a,e){return e?void 0:a.condition??"AND"}function Oa(a,e){const t=a==="=~"||a==="!~";return Ye(e)?t?a:"=~":t?"=":a}const La=["=","!=","<>","<",">",">=","<=","=~","!~","Is","Is Not"],wa=["AND","OR"],Da=La.map(D),Pa=wa.map(D),ja=()=>Promise.resolve(Pa),Fa=()=>Promise.resolve(Da),Ma=({tag:a,isFirst:e,onRemove:t,onChange:r,getTagKeyOptions:s,getTagValueOptions:n})=>{const o=Ke(a),l=qe(a,e),u=()=>s().catch(h=>(console.error(h),[])).then(h=>h.map(D)),c=()=>n(a.key).then(h=>h.map(D));return(0,i.jsxs)("div",{className:"gf-form",children:[l!=null&&(0,i.jsx)(W,{value:l,loadOptions:ja,onChange:h=>{r({...a,condition:h.value})}}),(0,i.jsx)(W,{allowCustomValue:!0,value:a.key,loadOptions:u,onChange:h=>{const{value:d}=h;d===void 0?t():r({...a,key:d??""})}}),(0,i.jsx)(W,{value:o,loadOptions:Fa,onChange:h=>{r({...a,operator:h.value})}}),(0,i.jsx)(W,{allowCustomValue:!0,value:a.value,loadOptions:c,onChange:h=>{const d=h.value??"";r({...a,value:d,operator:Oa(o,d)})}}),(0,i.jsx)(ve.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{t()}})]})},Ba=({tags:a,onChange:e,getTagKeyOptions:t,getTagValueOptions:r})=>{const s=(u,c)=>{const h=a.map((d,f)=>c===f?u:d);e(h)},n=u=>{const c=a.filter((h,d)=>d!==u);e(c)},o=()=>t().then(u=>u.map(D)),l=(u,c)=>{const h={key:u,value:"select tag value"},d={key:h.key,value:h.value,operator:Ke(h),condition:qe(h,c)};e([...a,d])};return(0,i.jsxs)(i.Fragment,{children:[a.map((u,c)=>(0,i.jsx)(Ma,{tag:u,isFirst:c===0,onChange:h=>{s(h,c)},onRemove:()=>{n(c)},getTagKeyOptions:t,getTagValueOptions:r},c)),(0,i.jsx)(He,{allowCustomValue:!0,loadOptions:o,onAdd:u=>{l(u,a.length===0)}})]})},Qa=a=>{const e=(0,I.useId)(),t=`influxdb-qe-format-as-${e}`,r=`influxdb-qe-order-by${e}`,s=(0,H.of)(ka),n=yt(a.query),{datasource:o}=a,{measurement:l,policy:u}=n,c=(0,I.useMemo)(async()=>{const y=(await sa(o,l,u)).map(R=>`${R}::tag`),b=(await ke(o,l||"",u)).map(R=>`${R}::field`);return new Set([...y,...b])},[l,u,o]),h=(0,I.useMemo)(()=>{const y=new Map([["field_0",()=>l!==void 0?ke(o,l,u):Promise.resolve([])]]);return(n.select??[]).map(b=>Ue(b,y))},[l,u,n.select,o]),d=(0,I.useMemo)(()=>async()=>[...await c],[c]),f=(0,I.useMemo)(()=>{const y=new Map([["tag_0",d]]);return Ue(n.groupBy??[],y)},[d,n.groupBy]),g=y=>{a.onChange(y),a.onRunQuery()},P=(y,b)=>{g({...n,policy:y,measurement:b})},re=y=>{g({...n,tags:y.length===0?void 0:y})};return(0,i.jsxs)("div",{children:[(0,i.jsxs)(X.L,{label:"FROM",fill:!0,children:[(0,i.jsx)(Ea,{policy:u,measurement:l,getPolicyOptions:()=>Te(aa(o),ca),getMeasurementOptions:y=>Te(c.then(b=>ra(o,$e(n.tags??[],b),y===""?void 0:y)),We,y),onChange:P}),(0,i.jsx)(L.c,{width:"auto",className:s.inlineLabel,children:"WHERE"}),(0,i.jsx)(Ba,{tags:n.tags??[],onChange:re,getTagKeyOptions:d,getTagValueOptions:y=>Te(c.then(b=>na(o,$e(n.tags??[],b),y,l)),We)})]}),h.map((y,b)=>(0,i.jsx)(X.L,{label:b===0?"SELECT":"",fill:!0,children:(0,i.jsx)(ze,{parts:y,getNewPartOptions:()=>Promise.resolve(ia()),onChange:(R,pr)=>{const fr=Tt(n,b,R,pr);g(fr)},onAddNewPart:R=>{g(xt(n,R,b))},onRemovePart:R=>{g(St(n,R,b))}})},b)),(0,i.jsx)(X.L,{label:"GROUP BY",fill:!0,children:(0,i.jsx)(ze,{parts:f,getNewPartOptions:()=>oa(n,d),onChange:(y,b)=>{const R=It(n,y,b);g(R)},onAddNewPart:y=>{g(Et(n,y))},onRemovePart:y=>{g(vt(n,y))}})}),(0,i.jsxs)(X.L,{label:"TIMEZONE",fill:!0,children:[(0,i.jsx)(oe,{placeholder:"(optional)",value:n.tz,onChange:y=>{g({...n,tz:y})}}),(0,i.jsx)(L.c,{htmlFor:r,width:"auto",className:s.inlineLabel,children:"ORDER BY TIME"}),(0,i.jsx)(Ca,{inputId:r,value:n.orderByTime==="DESC"?"DESC":"ASC",onChange:y=>{g({...n,orderByTime:y})}})]}),(0,i.jsxs)(X.L,{label:"LIMIT",fill:!0,children:[(0,i.jsx)(oe,{placeholder:"(optional)",value:n.limit?.toString(),onChange:y=>{g({...n,limit:y})}}),(0,i.jsx)(L.c,{width:"auto",className:s.inlineLabel,children:"SLIMIT"}),(0,i.jsx)(oe,{placeholder:"(optional)",value:n.slimit?.toString(),onChange:y=>{g({...n,slimit:y})}})]}),(0,i.jsxs)(X.L,{htmlFor:t,label:"FORMAT AS",fill:!0,children:[(0,i.jsx)(ma,{inputId:t,format:n.resultFormat??Be,onChange:y=>{g({...n,resultFormat:y})}}),n.resultFormat!=="table"&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(L.c,{width:"auto",className:s.inlineLabel,children:"ALIAS"}),(0,i.jsx)(oe,{isWide:!0,placeholder:"Naming pattern",value:n.alias,onChange:y=>{g({...n,alias:y})}})]})]})]})};function ka(a){return{inlineLabel:(0,v.css)`
      color: ${a.colors.primary.text};
    `}}const $a=({query:a,onChange:e,onRunQuery:t,datasource:r})=>{switch(r.version){case x.Flux:return(0,i.jsx)("div",{className:"gf-form-query-content",children:(0,i.jsx)(pe,{query:a,onChange:e,datasource:r})});case x.SQL:return(0,i.jsx)(Xt,{datasource:r,query:a,onChange:e,onRunQuery:t});case x.InfluxQL:default:return(0,i.jsxs)("div",{className:(0,v.css)({display:"flex"}),children:[(0,i.jsx)("div",{className:(0,v.css)({flexGrow:1}),children:a.rawQuery?(0,i.jsx)(ea,{query:a,onChange:e,onRunQuery:t}):(0,i.jsx)(Qa,{query:a,onChange:e,onRunQuery:t,datasource:r})}),(0,i.jsx)(Zt,{isRaw:a.rawQuery??!1,onChange:s=>{e({...a,query:we(a),rawQuery:s}),t()}})]})}},Ua=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],Wa=()=>{const a=(0,H.of)(Va);return(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{children:"InfluxDB Cheat Sheet"}),Ua.map(e=>(0,i.jsxs)("div",{className:a.cheatSheetItem,children:[(0,i.jsx)("div",{className:a.cheatSheetItemTitle,children:e.title}),e.label]},e.title))]})},Va=a=>({cheatSheetItem:(0,v.css)({margin:a.spacing(3,0)}),cheatSheetItemTitle:(0,v.css)({fontSize:a.typography.h3.fontSize})});function Ga(){return(0,i.jsx)(Wa,{})}var Xe=m(13288),Ha=m(88483),za=m(44240),ae=m(75505),le=m(62467),ue=m(81160),Ya=m(66847),Ka=m(14236),F=m(11261),qa=m(85858),Xa=m(26657),Je=m(17172);const Ja=a=>{const{query:e,onChange:t}=a,[r,s]=(0,I.useState)(e.query??""),[n,o]=(0,I.useState)(e.textColumn??""),[l,u]=(0,I.useState)(e.tagsColumn??""),[c,h]=(0,I.useState)(e?.timeEndColumn??""),[d]=(0,I.useState)(e?.titleColumn??""),f=(g,P)=>{t({...e,[g]:P,rawQuery:!0,fromAnnotations:!0,textEditor:!0})};return(0,i.jsxs)(k.B,{gap:5,direction:"column",children:[(0,i.jsxs)(k.B,{gap:.5,direction:"column",children:[(0,i.jsxs)(k.B,{gap:0,children:[(0,i.jsx)(U.I,{width:12,children:"InfluxQL Query"}),(0,i.jsx)(A.p,{value:r,onChange:g=>s(g.currentTarget.value??""),onBlur:()=>f("query",r),placeholder:"select text from events where $timeFilter limit 1000"})]}),(0,i.jsx)(U.I,{width:12,tooltip:(0,i.jsx)("div",{children:"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage."}),children:"Field mappings"}),(0,i.jsxs)(k.B,{gap:.5,alignItems:"flex-start",wrap:"wrap",children:[(0,i.jsxs)(k.B,{gap:0,children:[(0,i.jsx)(U.I,{width:12,children:"Text"}),(0,i.jsx)(A.p,{value:n,onChange:g=>o(g.currentTarget.value??""),onBlur:()=>f("textColumn",n)})]}),(0,i.jsxs)(k.B,{gap:0,children:[(0,i.jsx)(U.I,{width:12,children:"Tags"}),(0,i.jsx)(A.p,{value:l,onChange:g=>u(g.currentTarget.value??""),onBlur:()=>f("tagsColumn",l)})]}),(0,i.jsxs)(k.B,{gap:0,children:[(0,i.jsx)(U.I,{width:12,children:"TimeEnd"}),(0,i.jsx)(A.p,{value:c,onChange:g=>h(g.currentTarget.value??""),onBlur:()=>f("timeEndColumn",c)})]}),(0,i.jsxs)("div",{className:"gf-form ng-hide",children:[(0,i.jsx)(U.I,{width:12,children:"Title"}),(0,i.jsx)(A.p,{defaultValue:d})]})]})]}),(0,i.jsx)("div",{})]})};var Ze=m(91950);class _e{constructor(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let t,r;return this.series.length===0||(0,p.each)(this.series,s=>{const n=s.columns.length,o=(0,p.map)(s.tags,(l,u)=>u+": "+l);for(r=1;r<n;r++){let l=s.name;const u=s.columns[r];u!=="value"&&(l=l+"."+u),this.alias?l=this._getSeriesName(s,r):s.tags&&(l=l+" {"+o.join(", ")+"}");const c=[];if(s.values)for(t=0;t<s.values.length;t++)c[t]=[s.values[t][r],s.values[t][0]];e.push({title:l,target:l,datapoints:c,tags:s.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,t){const r=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,s=e.name.split(".");return this.alias.replace(r,(n,o,l)=>{const u=o||l,c=parseInt(u,10);if(u==="m"||u==="measurement")return e.name;if(u==="col")return e.columns[t];if(!isNaN(c))return s[c]??n;if(u.indexOf("tag_")!==0)return n;const h=u.replace("tag_","");return e.tags?e.tags[h]:n})}getAnnotations(){const e=[];return(0,p.each)(this.series,t=>{let r=null,s=null,n=null;const o=[];let l=null;(0,p.each)(t.columns,(u,c)=>{if(u==="time"){s=c;return}if(u!=="sequence_number"){if(u===this.annotation.titleColumn){r=c;return}if((0,p.includes)((this.annotation.tagsColumn||"").replace(" ","").split(","),u)){o.push(c);return}if(u===this.annotation.textColumn){l=c;return}if(u===this.annotation.timeEndColumn){n=c;return}!r&&l!==c&&(r=c)}}),(0,p.each)(t.values,u=>{const c={annotation:this.annotation,time:+new Date(u[s]),title:u[r],timeEnd:u[n],tags:(0,p.flatten)(o.filter(h=>u[h]).map(h=>u[h].split(","))),text:u[l]};e.push(c)})}),e}getTable(){const e=new Ze.A;let t,r;return e.refId=this.refId,e.meta=this.meta,this.series.length===0||(0,p.each)(this.series,(s,n)=>{if(n===0){const o=s.columns[0],l=o==="time"?{text:"Time",type:F.PU.time}:{text:o};for(e.columns.push(l),(0,p.each)((0,p.keys)(s.tags),u=>{e.columns.push({text:u})}),r=1;r<s.columns.length;r++)e.columns.push({text:s.columns[r]})}if(s.values)for(t=0;t<s.values.length;t++){const o=s.values[t],l=[o[0]];if(s.tags)for(const u in s.tags)s.tags.hasOwnProperty(u)&&l.push(s.tags[u]);for(r=1;r<o.length;r++)l.push(o[r]);e.rows.push(l)}}),e}}const Za=a=>{const e={refId:"",query:a.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:a.tagsColumn??"",textColumn:a.textColumn??"",timeEndColumn:a.timeEndColumn??"",titleColumn:a.titleColumn??"",name:a.name??""};return a.target&&a.target.limit&&(e.limit=a.target.limit),a.target&&a.target.matchAny&&(e.matchAny=a.target.matchAny),a.target&&a.target.tags&&(e.tags=a.target.tags),a.target&&a.target.type&&(e.type=a.target.type),e},_a=a=>(a.target=a.target&&!a.target?.query?Za(a):a.target,a);var er=m(47773);class tr{parse(e,t){if(!t?.results||t.results.length===0)return[];const r=t.results[0];if(!r.series)return[];const s=e.toLowerCase(),n=s.indexOf("show retention policies")>=0,o=s.indexOf("show field keys")>=0||n,l=new Set;return(0,p.each)(r.series,u=>{(0,p.each)(u.values,c=>{(0,p.isArray)(c)?o?l.add(c[0].toString()):c[1]!==void 0?l.add(c[1].toString()):l.add(c[0].toString()):l.add(c.toString())})}),Array.from(l).map(u=>({text:u}))}getTable(e,t,r){let s=new Ze.A;if(e.length>0)if(s.meta={...r,executedQueryString:e[0].meta?.executedQueryString},s.refId=t.refId,s=rr(e,s,t),e[0].fields[1]&&e[0].fields[1].labels){let n=(0,p.groupBy)(e,u=>u.fields[1].labels?Object.values(u.fields[1].labels):null);const o=Object.keys(n),l=Object.values(n);for(let u=0;u<l.length;u++)s=et(l[u],s,[...o[u].split(",")])}else s=et(e,s,[]);return s}async transformAnnotationResponse(e,t,r){const s=(0,er.bE)(t,[r]);if(!s)return[];const n=this.getTable(s.data,r,{}),o=[];let l=0,u=0,c=0,h=0;const d=[];return(0,p.each)(n.columns,(f,g)=>{if(f.text.toLowerCase()==="time"){u=g;return}if(f.text===e.titleColumn){l=g;return}if(ar(f.text,e.tagsColumn)){d.push(g);return}if(e.textColumn&&f.text.includes(e.textColumn)){h=g;return}if(f.text===e.timeEndColumn){c=g;return}!l&&h!==g&&(l=g)}),(0,p.each)(n.rows,f=>{const g={annotation:e,time:+new Date(f[u]),title:f[l],timeEnd:f[c],tags:(0,p.flatten)(d.filter(P=>f[P]).map(P=>f[P].split(","))),text:f[h]};o.push(g)}),o}}function ar(a,e){const t=(e||"").replace(" ","").split(",");for(const r of t)if(r!==""&&a.includes(r))return!0;return!1}function rr(a,e,t){const r=sr(t);a[0].fields.forEach(s=>{s.name.toLowerCase()==="time"?e.columns.push({text:"Time",type:F.PU.time}):s.name.toLowerCase()==="value"&&s.labels&&Object.keys(s.labels).forEach(n=>{e.columns.push({text:n})})}),a[0].refId==="metricFindQuery"&&a.forEach(s=>{s.name&&e.columns.push({text:s.name})});for(let s=0;s<r.length;s++)e.columns.push({text:r[s]});return t.rawQuery&&r.length===0&&nr(t.query,a)&&a[0].refId!=="metricFindQuery"&&a.map(s=>{s.name&&e.columns.push({text:s.name})}),e}function et(a,e,t){const r=a[0].fields[0].values;for(let s=0;s<r.length;s++){const n=r[s],o=a.map(l=>l.fields[1]?l.fields[1].values[s]:null);o.indexOf(null)<0&&e.rows.push([n,...t,...o])}return e}function sr(a){let e=[];a.select?.forEach(r=>{const s=r.filter(n=>n.type!=="field");if(s.length>0){const n=s.find(o=>o.type==="alias");n?e.push(n.params?.[0].toString()??""):e.push(s[0].type)}else r[0]&&r[0].params&&r[0].params[0]&&e.push(r[0].params[0].toString())});let t=[];return e.forEach(r=>{t.push(tt(r,r,t,0))}),t}function tt(a,e,t,r){return t.indexOf(e)>-1?(r++,tt(a,a+"_"+r,t,r)):e}function nr(a,e){const r=e.map(o=>o.name).every(o=>o&&a?o.split(".").every(u=>a.toLowerCase().includes(u.toLowerCase())):!1),n=["*","SHOW"].some(o=>a?a.toLowerCase().includes(o.toLowerCase()):!1);return r||n}var ir=m(65474),or=m(29505);const Ie="InfluxVariableQueryEditor-VariableQuery",lr=({onChange:a,datasource:e,query:t})=>{const r=s=>typeof s!="string"?s:{refId:Ie,query:s,...e.version===x.Flux?{maxDataPoints:1e3}:{}};switch(e.version){case x.Flux:return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(pe,{datasource:e,query:r(t),onChange:s=>{a({...t,query:s.query??""})}}),(0,i.jsx)(K.C,{children:(0,i.jsx)(Q.I,{label:"Max Data Points",labelWidth:20,required:!0,grow:!0,"aria-labelledby":"flux-maxdatapoints",tooltip:(0,i.jsx)("div",{children:"Upper boundary of data points will return for the variable query."}),children:(0,i.jsx)(A.p,{id:"influx-sql-variable-maxdatapoints","aria-label":"flux-maxdatapoints",type:"number",defaultValue:t.maxDataPoints??1e3,placeholder:"Default is 1000",onBlur:s=>{a({refId:Ie,query:t.query,maxDataPoints:Number.parseInt(s.currentTarget.value,10)})}})})})]});default:return(0,i.jsx)(K.C,{children:(0,i.jsx)(Q.I,{label:"Query",labelWidth:20,required:!0,grow:!0,"aria-labelledby":"influx-variable-query",children:(0,i.jsx)(Fe.f,{"aria-label":"influx-variable-query",defaultValue:r(t).query,placeholder:"metric name or tags query",rows:1,onBlur:s=>{a({refId:Ie,query:s.currentTarget.value??""})}})})})}};class ur extends or.f5{constructor(e,t=(0,Z.w)()){super(),this.datasource=e,this.templateSrv=t,this.editor=lr}query(e){let t;if(typeof e.targets[0]=="string"?t=e.targets[0]:t=e.targets[0].query,!t)return(0,le.of)({data:[]});const r=this.templateSrv.replace(t,e.scopedVars,this.datasource.interpolateQueryExpr),s=this.datasource.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone}),n=r.replace("$timeFilter",s);return(0,ir.H)(this.datasource.metricFindQuery({refId:e.targets[0].refId,query:n,maxDataPoints:e.targets[0].maxDataPoints??1e3},{range:e.range})).pipe((0,ue.T)(l=>({data:l})))}}class cr extends Xa.iy{constructor(e,t=(0,Z.w)()){super(e),this.templateSrv=t,this.type="influxdb",this.urls=(e.url??"").split(",").map(s=>s.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const r=e.jsonData??{};this.database=r.dbName??e.database,this.interval=r.timeInterval,this.httpMode=r.httpMode||"GET",this.responseParser=new tr,this.version=r.version??x.InfluxQL,this.isProxyAccess=e.access==="proxy",this.variables=new ur(this,this.templateSrv),this.version===x.Flux?this.annotations={QueryEditor:pe}:this.annotations={QueryEditor:Ja,prepareAnnotation:_a}}query(e){if(!this.isProxyAccess){const t=new Error(Ae);return(0,Xe.$)(()=>t)}return this._query(e)}_query(e){const t={...e,targets:e.targets.filter(r=>r.hide!==!0)};if(t.targets.some(r=>r.fromAnnotations)){const r=[];for(const s of t.targets)s.query&&r.push(new Ha.c(n=>{this.annotationEvents(t,s).then(o=>n.next({data:[(0,Ka.Vc)(o)]})).catch(o=>n.error(new Error(o))).finally(()=>n.complete())}));return(0,za.h)(...r)}return this.version===x.InfluxQL&&!this.isMigrationToggleOnAndIsAccessProxy()?this.classicQuery(e):super.query(t)}getQueryDisplayText(e){switch(this.version){case x.Flux:return e.query;case x.SQL:return Pe(e);case x.InfluxQL:return new M(e).render(!1);default:return""}}filterQuery(e){return this.version===x.Flux?!!e.query:!0}applyTemplateVariables(e,t,r){const s=t||{};if(s.__interval={value:"$__interval"},s.__interval_ms={value:"$__interval_ms"},this.version===x.Flux)return{...e,query:this.templateSrv.replace(e.query??"",s)};if((this.version===x.SQL||this.isMigrationToggleOnAndIsAccessProxy())&&(e=this.applyVariables(e,s,r),e.adhocFilters?.length)){const n=(e.adhocFilters??[]).map(o=>{const{condition:l,...u}=o;return u});e.tags=[...e.tags??[],...n]}return e}targetContainsTemplate(e){const t=this.version===x.Flux?e.query:we(e);return this.templateSrv.containsTemplate(t)}interpolateVariablesInQueries(e,t){return!e||e.length===0?[]:e.map(r=>this.version===x.Flux?{...r,datasource:this.getRef(),query:this.templateSrv.replace(r.query??"",t,(s=[],n)=>this.interpolateQueryExpr(s,n,r.query))}:{...r,datasource:this.getRef(),...this.applyVariables(r,t)})}applyVariables(e,t,r){const s={...e};return e.groupBy&&(s.groupBy=e.groupBy.map(n=>({...n,params:n.params?.map(o=>this.templateSrv.replace(o.toString(),void 0))}))),e.select&&(s.select=e.select.map(n=>n.map(o=>({...o,params:o.params?.map(l=>this.templateSrv.replace(l.toString(),t))})))),e.tags&&(s.tags=e.tags.map(n=>(n.operator!=="=~"&&n.operator!=="!~"&&(n.value=se(n.value)),{...n,key:this.templateSrv.replace(n.key,t),value:this.templateSrv.replace(n.value??"",t,(o=[],l)=>this.interpolateQueryExpr(o,l,n.value))}))),{...s,adhocFilters:r??[],query:this.templateSrv.replace(e.query??"",t,(n=[],o)=>this.interpolateQueryExpr(n,o,e.query)),rawSql:this.templateSrv.replace(e.rawSql??"",t,(n=[],o)=>this.interpolateQueryExpr(n,o,e.rawSql)),alias:this.templateSrv.replace(e.alias??"",t),limit:this.templateSrv.replace(e.limit?.toString()??"",t),measurement:this.templateSrv.replace(e.measurement??"",t,(n=[],o)=>this.interpolateQueryExpr(n,o,e.measurement)),policy:this.templateSrv.replace(e.policy??"",t),slimit:this.templateSrv.replace(e.slimit?.toString()??"",t),tz:this.templateSrv.replace(e.tz??"",t)}}interpolateQueryExpr(e=[],t,r){if(typeof e=="string"&&!isNaN(parseFloat(e)))return e;if(t.multi)return typeof e=="string"?isNaN(parseFloat(e))?(0,z.$f)(e):e:`(${e.map(n=>(0,z.$f)(n)).join("|")})`;const s=new RegExp(`\\/(?:\\^)?(.*)(\\$${t.name})(.*)(?:\\$)?\\/`,"gm");return r&&s.test(r)?typeof e=="string"?(0,z.$f)(e):`(${e.map(n=>(0,z.$f)(n)).join("|")})`:e}async runMetadataQuery(e){return(0,ae.s)(super.query({targets:[e]})).then(this.toMetricFindValue)}async metricFindQuery(e,t){if(this.version===x.Flux||this.version===x.SQL||this.isMigrationToggleOnAndIsAccessProxy()){const s={refId:"metricFindQuery",query:e.query,rawQuery:!0,...this.version===x.SQL?{rawSql:e.query,format:Y.gv.Table}:{}};return(0,ae.s)(super.query({...t??{},maxDataPoints:e.maxDataPoints,targets:[s]})).then(this.toMetricFindValue)}const r=this.templateSrv.replace(e.query,t?.scopedVars,(s=[],n)=>this.interpolateQueryExpr(s,n,e.query));return(0,ae.s)(this._seriesQuery(r,t)).then(s=>this.responseParser.parse(e.query,s))}toMetricFindValue(e){const t=new Map;return e?.data?.forEach(r=>{if(r&&r.length>0){let s=r.fields.find(n=>n.type===F.PU.string);s||(s=r.fields.find(n=>n.type!==F.PU.time)),s&&s.values.forEach(n=>{t.set(n.toString(),{text:n.toString()})})}}),Array.from(t.values())}getTagKeys(e){const t=Se({type:"TAG_KEYS",templateService:this.templateSrv,database:this.database});return this.metricFindQuery({refId:"get-tag-keys",query:t})}getTagValues(e){const t=Se({type:"TAG_VALUES",templateService:this.templateSrv,database:this.database,withKey:e.key});return this.metricFindQuery({refId:"get-tag-values",query:t})}_seriesQuery(e,t){if(!e)return(0,le.of)({results:[]});if(t&&t.range){const r=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",r)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?(0,p.reduce)(e,(t,r,s)=>(r==null||t.push(encodeURIComponent(s)+"="+encodeURIComponent(r)),t),[]).join("&"):""}_influxRequest(e,t,r,s){const n=this.urls.shift();this.urls.push(n);const o={};this.username&&(o.u=this.username,o.p=this.password),s&&s.database?o.db=s.database:this.database&&(o.db=this.database),s?.policy&&s.policy!==G&&(o.rp=s.policy);const{q:l}=r;e==="POST"&&(0,p.has)(r,"q")?((0,p.extend)(o,(0,p.omit)(r,["q"])),r=this.serializeParams((0,p.pick)(r,["q"]))):(e==="GET"||e==="POST")&&((0,p.extend)(o,r),r=null);const u={method:e,url:n+t,params:o,data:r,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,Je.AI)().fetch(u).pipe((0,ue.T)(c=>{const{data:h}=c;if(h&&(h.executedQueryString=l,h.results)){const d=c.data.results.filter(f=>f.error);if(d.length>0)throw{message:"InfluxDB Error: "+d[0].error,data:h}}return h}),(0,Ya.W)(c=>c.cancelled?(0,le.of)(c):(0,Xe.$)(this.handleErrors(c))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){const t=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),r=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+t+" and time <= "+r}getInfluxTime(e,t,r){let s;if((0,p.isString)(e)){if(e==="now")return"now()";const n=/^now-(\d+)([dhms])$/.exec(e);if(n){const o=parseInt(n[1],10),l=n[2];return"now() - "+o+l}if(s=qa.parse(e,t,r),!s)throw new Error("unable to parse date");e=s}return e.valueOf()+"ms"}isMigrationToggleOnAndIsAccessProxy(){return Qe.Ay.featureToggles.influxdbBackendMigration&&this.access==="proxy"}classicQuery(e){let t=this.getTimeFilter(e);const r=e.scopedVars,s=(0,p.cloneDeep)(e.targets),n=[];let o,l,u=(0,p.map)(s,d=>d.hide?"":(n.push(d),r.interval=r.__interval,new M(d,this.templateSrv,r).render(!0))).reduce((d,f)=>(f!==""&&(d+=";"+f),d));if(u==="")return(0,le.of)({data:[]});const c=e.filters,h=e.targets.flatMap(d=>d.adhocFilters??[]);if(c?.length||h?.length){const d=c?.length?c:h,f=new M({refId:"A"},this.templateSrv,r);t+=" AND "+f.renderAdhocFilters(d)}return r.timeFilter={value:t},u=this.templateSrv.replace(u,r),this._seriesQuery(u,e).pipe((0,ue.T)(d=>{if(!d||!d.results)return{data:[]};const f=[];for(o=0;o<d.results.length;o++){const g=d.results[o];if(!g||!g.series)continue;const P=n[o];let re=P.alias;re&&(re=this.templateSrv.replace(P.alias,e.scopedVars));const y={executedQueryString:d.executedQueryString},b=new _e({refId:P.refId,series:d.results[o].series,alias:re,meta:y});switch(P.resultFormat){case"logs":y.preferredVisualisationType="logs";case"table":{f.push(b.getTable());break}default:{const R=b.getTimeSeries();for(l=0;l<R.length;l++)f.push(mr(R[l]));break}}}return{data:f}}))}async annotationEvents(e,t){if(this.version===x.Flux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!t.query)return Promise.reject({message:"Query missing in annotation definition"});if(this.isMigrationToggleOnAndIsAccessProxy()){const n={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(t.query,void 0,(o=[],l)=>this.interpolateQueryExpr(o,l,t.query)),rawQuery:!0};return(0,ae.s)((0,Je.AI)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[n]},requestId:t.name}).pipe((0,ue.T)(async o=>await this.responseParser.transformAnnotationResponse(t,o,n))))}const r=this.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone});let s=t.query.replace("$timeFilter",r);return s=this.templateSrv.replace(s,void 0,(n=[],o)=>this.interpolateQueryExpr(n,o,s)),(0,ae.s)(this._seriesQuery(s,e)).then(n=>{if(!n||!n.results||!n.results[0])throw{message:"No results in response from InfluxDB"};return new _e({series:n.results[0].series,annotation:t}).getAnnotations()})}}function dr(a){const e=a.find(r=>r!==null);if(e===void 0)return F.PU.number;const t=typeof e;switch(t){case"string":return F.PU.string;case"boolean":return F.PU.boolean;case"number":return F.PU.number;default:throw new Error(`InfluxQL: invalid value type ${t}`)}}function mr(a){const e=[],t=[],r=a.datapoints;for(const l of r)t.push(l[0]),e.push(l[1]);const s={name:F.LE,type:F.PU.time,config:{},values:e},n={name:F.Bc,type:dr(t),config:{displayNameFromDS:a.title},values:t,labels:a.tags},o=[s,n];return{name:a.target,refId:a.refId,meta:a.meta,fields:o,length:t.length}}const hr=new at.tD(cr).setConfigEditor(mt).setQueryEditor($a).setQueryEditorHelp(Ga)}}]);

//# sourceMappingURL=influxdbPlugin.a92455128ea404b01663.js.map