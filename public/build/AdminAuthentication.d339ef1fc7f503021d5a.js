"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5592],{51332:(ae,A,t)=>{t.r(A),t.d(A,{AuthConfigPageUnconnected:()=>ee,default:()=>ve});var e=t(74848),l=t(96540),D=t(71468),m=t(61268),k=t(14110),N=t(72109),S=t(27746),W=t(71259),O=t(69444),ne=t(2913),E=t(32196),g=t(40845),h=t(87978),d=t(94753),C=t(15292),q=t(55852),U=t(3169),H=t(60610);const Y=o=>({allowInsecureEmail:o.authConfig.settings?.auth?.oauth_allow_insecure_email_lookup.toLowerCase()==="true"}),xe={loadSettings:H.M5,saveSettings:H.DZ},ue=(0,D.connect)(Y,xe)(({allowInsecureEmail:o,loadSettings:P,onClose:w,saveSettings:b})=>{const R=(0,U._2)(),F=async()=>{try{await b({updates:{auth:{oauth_allow_insecure_email_lookup:""+!o}}}),await P(!1),R.success("Settings saved")}catch{R.error("Failed to save settings")}},V=async()=>{try{await b({removals:{auth:["oauth_allow_insecure_email_lookup"]}}),await P(!1),R.success("Settings saved")}catch{R.error("Failed to save settings")}},z=(0,e.jsxs)(e.Fragment,{children:["Configure auth settings. Find out more in our"," ",(0,e.jsx)(N.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication/#settings",children:"documentation"}),"."]}),X=(0,g.of)(ce);return(0,e.jsxs)(h._,{title:"Auth Settings",subtitle:z,size:"md",onClose:w,children:[(0,e.jsxs)("div",{className:X.advancedAuth,children:[(0,e.jsx)(d.E,{variant:"h4",children:"Advanced Auth"}),(0,e.jsx)(d.E,{variant:"h5",children:"Enable insecure email lookup"}),(0,e.jsx)(d.E,{variant:"body",color:"secondary",children:"Allow users to use the same email address to log into Grafana with different identity providers."}),(0,e.jsx)(C.d,{value:o,onChange:F})]}),(0,e.jsx)(q.$n,{size:"md",variant:"secondary",className:X.button,onClick:V,tooltip:"This action will disregard any saved changes and load the configuration from the configuration file.",children:"Reset"})]})}),ce=o=>({advancedAuth:(0,E.css)({display:"flex",flexDirection:"column",gap:o.spacing(1)}),button:(0,E.css)({marginTop:o.spacing(2)})});var he=t(67061),fe=t(14578);const Ae=()=>{const o=(0,g.of)(Se);return(0,e.jsxs)("div",{className:o.container,children:[(0,e.jsxs)(he.B,{gap:1,alignItems:"center",children:[(0,e.jsx)(fe.I,{name:"cog"}),(0,e.jsx)(d.E,{children:"Configuration required"})]}),(0,e.jsx)(d.E,{variant:"bodySmall",color:"secondary",children:"You have no authentication configuration created at the moment."}),(0,e.jsx)(N.Y,{href:"https://grafana.com/docs/grafana/latest/auth/overview/",external:!0,children:"Refer to the documentation on how to configure authentication"})]})},Se=o=>({container:(0,E.css)({display:"flex",flexDirection:"column",gap:o.spacing(2),backgroundColor:o.colors.background.secondary,borderRadius:o.shape.radius.default,padding:o.spacing(3),width:"max-content",margin:o.spacing(3,"auto")})}),Ce=Ae;var Pe=t(8887),J=t(10860),Ie=t(39938),me=t(7250),se=t(5328);function ge({providerId:o,enabled:P,configPath:w,authType:b,onClick:R}){const F=(0,se.h)({configPath:w,id:o}),[V,z]=me.L[o]||["lock",o.toUpperCase()];return(0,e.jsxs)(J.Z,{href:F,onClick:R,children:[(0,e.jsx)(J.Z.Heading,{children:z}),(0,e.jsx)(J.Z.Meta,{children:b}),(0,Pe.n6)(V)&&(0,e.jsx)(J.Z.Figure,{children:(0,e.jsx)(fe.I,{name:V,size:"xxxl"})}),(0,e.jsx)(J.Z.Actions,{children:(0,e.jsx)(Ie.E,{text:P?"Enabled":"Not enabled",color:P?"green":"blue"})})]})}var pe=t(73399);function Z(o){const{isLoading:P,providerStatuses:w,providers:b}=o.authConfig;return{isLoading:P,providerStatuses:w,providers:b}}const _={loadSettings:H.M5},ye=(0,D.connect)(Z,_),ee=({providerStatuses:o,isLoading:P,loadSettings:w,providers:b})=>{(0,l.useEffect)(()=>{w()},[w]);const[R,F]=(0,l.useState)(!1),z=(0,pe.getRegisteredAuthProviders)().filter(c=>!o[c.id]?.hide),X=(c,B)=>{(0,k.rR)("authentication_ui_provider_clicked",{provider:c,enabled:B})};b=b.filter(c=>c.provider!=="saml"),b=b.filter(c=>c.provider!=="ldap");const L=z.length?[...z.map(c=>({provider:c.id,settings:{...o[c.id],configPath:c.configPath,type:c.type}})),...b]:b;return(0,e.jsx)(O.Y,{navId:"authentication",subTitle:(0,e.jsxs)(e.Fragment,{children:["Manage your auth settings and configure single sign-on. Find out more in our"," ",(0,e.jsx)(N.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication",children:"documentation"}),"."]}),actions:ne.config.buildInfo.edition!==m.r.OpenSource&&(0,e.jsx)(S.I,{icon:"cog",variant:"canvas",onClick:()=>F(!0),children:"Auth settings"}),children:(0,e.jsx)(O.Y.Contents,{isLoading:P,children:L.length?(0,e.jsxs)(W.x,{gap:3,minColumnWidth:34,children:[L.filter(({provider:c})=>!["grafana_com"].includes(c)).map(({provider:c,settings:B})=>(0,e.jsx)(ge,{authType:B.type||"OAuth",providerId:c,enabled:B.enabled,onClick:()=>X(c,B.enabled),configPath:B.configPath},c)),R&&(0,e.jsx)(ue,{onClose:()=>F(!1)})]}):(0,e.jsx)(Ce,{})})})},ve=ye(ee)},22468:(ae,A,t)=>{t.r(A),t.d(A,{ProviderConfigPage:()=>Ue,default:()=>Ne});var e=t(74848),l=t(96540),D=t(71468),m=t(67061),k=t(94753),N=t(39938),S=t(69444),W=t(49785),O=t(26272),ne=t(3591),E=t(17172),g=t(14110),h=t(39601),d=t(38138),C=t(88575),q=t(15292),U=t(57418),H=t(90613),Y=t(55852),xe=t(83122),Oe=t(29158),Ee=t(96374),ue=t(32196),ce=t(24180),he=t(37390);const fe=({confirmRedirect:n,onDiscard:a,onLocationChange:s})=>{const[r,f]=(0,l.useState)(!1),[p,y]=(0,l.useState)(null),[x,te]=(0,l.useState)(!1);(0,l.useEffect)(()=>{const i=I=>{n&&(I.preventDefault(),I.returnValue="")};return window.addEventListener("beforeunload",i),()=>{window.removeEventListener("beforeunload",i)}},[n]);const ie=i=>{const I=window.location.pathname,u=i.pathname;if(I===u)return!0;const Q=s?.(i);let T=n&&!x;return Q!==void 0&&(T=T&&Q),T?(f(!0),y(i),!1):(Q&&a(),!0)},re=()=>{f(!1),y(null)},G=()=>{f(!1),te(!0),a()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ce.XG,{when:!0,message:ie}),p&&x&&(0,e.jsx)(ce.rd,{to:p}),(0,e.jsx)(Ae,{isOpen:r,onDiscard:G,onBackToForm:re})]})},Ae=({onDiscard:n,onBackToForm:a,isOpen:s})=>(0,e.jsxs)(he.a,{isOpen:s,title:"Leave page?",onDismiss:a,icon:"exclamation-triangle",className:(0,ue.css)({width:"500px"}),children:[(0,e.jsx)("h5",{children:"Changes that you made may not be saved."}),(0,e.jsxs)(he.a.ButtonRow,{children:[(0,e.jsx)(Y.$n,{variant:"secondary",onClick:a,fill:"outline",children:"Continue editing"}),(0,e.jsx)(Y.$n,{variant:"destructive",onClick:n,children:"Discard unsaved changes"})]})]});var Se=t(40845),Ce=t(10354),Pe=t(9226),J=t(90182),Ie=t(10880),me=t(8227),se=t(32264),ge=t(72109),pe=t(10096);function Z(n){return Array.isArray(n)&&n.every(a=>typeof a=="object"&&a!==null&&"value"in a)}var _=t(5328);const ye={azuread:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","allowedGroups","forceUseGraphApi","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],generic_oauth:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","authStyle","scopes","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["nameAttributePath","loginAttributePath","emailAttributeName","emailAttributePath","idTokenAttributeName","roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","defineAllowedGroups",{name:"allowedGroups",dependsOn:"defineAllowedGroups"},{name:"groupsAttributePath",dependsOn:"defineAllowedGroups"},"defineAllowedTeamsIds",{name:"teamIds",dependsOn:"defineAllowedTeamsIds"},{name:"teamsUrl",dependsOn:"defineAllowedTeamsIds"},{name:"teamIdsAttributePath",dependsOn:"defineAllowedTeamsIds"},"usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],google:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["validateHd","hostedDomain","allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],github:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","teamIds","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],gitlab:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],okta:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}]};function ee(n){return{clientId:{label:"Client Id",type:"text",description:"The client Id of your OAuth2 app.",validation:{required:!0,message:"This field is required"}},clientSecret:{label:"Client secret",type:"secret",description:"The client secret of your OAuth2 app."},allowedOrganizations:{label:"Allowed organizations",type:"select",description:`List of comma- or space-separated organizations. The user should be a member 
of at least one organization to log in.`,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter organizations (my-team, myteam...) and press Enter to add"},allowedDomains:{label:"Allowed domains",type:"select",description:`List of comma- or space-separated domains. The user should belong to at least 
one domain to log in.`,multi:!0,allowCustomValue:!0,options:[]},authUrl:{label:"Auth URL",type:"text",description:"The authorization endpoint of your OAuth2 provider.",validation:{required:!0,validate:a=>(0,_.K)(a),message:"This field is required and must be a valid URL."}},authStyle:{label:"Auth style",type:"select",description:"It determines how client_id and client_secret are sent to Oauth2 provider. Default is AutoDetect.",multi:!1,options:[{value:"AutoDetect",label:"AutoDetect"},{value:"InParams",label:"InParams"},{value:"InHeader",label:"InHeader"}],defaultValue:{value:"AutoDetect",label:"AutoDetect"}},tokenUrl:{label:"Token URL",type:"text",description:"The token endpoint of your OAuth2 provider.",validation:{required:!0,validate:a=>(0,_.K)(a),message:"This field is required and must be a valid URL."}},scopes:{label:"Scopes",type:"select",description:"List of comma- or space-separated OAuth2 scopes.",multi:!0,allowCustomValue:!0,options:[]},allowedGroups:{label:"Allowed groups",type:"select",description:(0,e.jsxs)(e.Fragment,{children:["List of comma- or space-separated groups. The user should be a member of at least one group to log in."," ",n==="generic_oauth"&&"If you configure allowed_groups, you must also configure groups_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],validation:n==="azuread"?{validate:a=>typeof a=="string"?(0,me.A)(a):Z(a)?a.every(s=>s?.value&&(0,me.A)(s.value)):!0,message:"Allowed groups must be Object Ids."}:void 0},apiUrl:{label:"API URL",type:"text",description:(0,e.jsxs)(e.Fragment,{children:["The user information endpoint of your OAuth2 provider. Information returned by this endpoint must be compatible with"," ",(0,e.jsx)(ge.Y,{href:"https://connect2id.com/products/server/docs/api/userinfo",external:!0,variant:"bodySmall",children:"OpenID UserInfo"}),"."]}),validation:{required:!1,validate:a=>typeof a!="string"?!1:a.length?(0,_.K)(a):!0,message:"This field must be a valid URL if set."}},roleAttributePath:{label:"Role attribute path",description:"JMESPath expression to use for Grafana role lookup.",type:"text",validation:{required:!1}},name:{label:"Display name",description:'Will be displayed on the login page as "Sign in with ...". Helpful if you use more than one identity providers or SSO protocols.',type:"text"},allowSignUp:{label:"Allow sign up",description:"If not enabled, only existing Grafana users can log in using OAuth.",type:"switch"},autoLogin:{label:"Auto login",description:"Log in automatically, skipping the login screen.",type:"switch"},signoutRedirectUrl:{label:"Sign out redirect URL",description:"The URL to redirect the user to after signing out from Grafana.",type:"text",validation:{required:!1}},emailAttributeName:{label:"Email attribute name",description:"Name of the key to use for user email lookup within the attributes map of OAuth2 ID token.",type:"text"},emailAttributePath:{label:"Email attribute path",description:"JMESPath expression to use for user email lookup from the user information.",type:"text"},nameAttributePath:{label:"Name attribute path",description:`JMESPath expression to use for user name lookup from the user ID token. 
This name will be used as the user\u2019s display name.`,type:"text"},loginAttributePath:{label:"Login attribute path",description:"JMESPath expression to use for user login lookup from the user ID token.",type:"text"},idTokenAttributeName:{label:"ID token attribute name",description:"The name of the key used to extract the ID token from the returned OAuth2 token.",type:"text"},roleAttributeStrict:{label:"Role attribute strict mode",description:"If enabled, denies user login if the Grafana role cannot be extracted using Role attribute path.",type:"switch"},allowAssignGrafanaAdmin:{label:"Allow assign Grafana admin",description:"If enabled, it will automatically sync the Grafana server administrator role.",type:"switch",hidden:!pe.TP.isGrafanaAdmin},skipOrgRoleSync:{label:"Skip organization role sync",description:"Prevent synchronizing users\u2019 organization roles from your IdP.",type:"switch"},orgMapping:{label:"Organization mapping",description:o(n),type:"select",hidden:!pe.TP.isGrafanaAdmin,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter mappings (my-team:1:Viewer...) and press Enter to add"},orgAttributePath:{label:"Organization attribute path",description:"JMESPath expression to use for organization lookup.",type:"text",hidden:!["generic_oauth","okta"].includes(n)},defineAllowedGroups:{label:"Define allowed groups",type:"switch"},defineAllowedTeamsIds:{label:"Define allowed teams ids",type:"switch"},forceUseGraphApi:{label:"Force use Graph API",description:"If enabled, Grafana will fetch the users' groups using the Microsoft Graph API.",type:"checkbox"},usePkce:{label:"Use PKCE",description:(0,e.jsxs)(e.Fragment,{children:["If enabled, Grafana will use"," ",(0,e.jsx)(ge.Y,{external:!0,variant:"bodySmall",href:"https://datatracker.ietf.org/doc/html/rfc7636",children:"Proof Key for Code Exchange (PKCE)"})," ","with the OAuth2 Authorization Code Grant."]}),type:"checkbox"},useRefreshToken:{label:"Use refresh token",description:"If enabled, Grafana will fetch a new access token using the refresh token provided by the OAuth2 provider.",type:"checkbox"},tlsClientCa:{label:"TLS client ca",description:"The file path to the trusted certificate authority list. Is not applicable on Grafana Cloud.",type:"text",hidden:!se.$.localFileSystemAvailable},tlsClientCert:{label:"TLS client cert",description:"The file path to the certificate. Is not applicable on Grafana Cloud.",type:"text",hidden:!se.$.localFileSystemAvailable},tlsClientKey:{label:"TLS client key",description:"The file path to the key. Is not applicable on Grafana Cloud.",type:"text",hidden:!se.$.localFileSystemAvailable},tlsSkipVerifyInsecure:{label:"TLS skip verify",description:`If enabled, the client accepts any certificate presented by the server and any host 
name in that certificate. You should only use this for testing, because this mode leaves 
SSL/TLS susceptible to man-in-the-middle attacks.`,type:"switch"},groupsAttributePath:{label:"Groups attribute path",description:`JMESPath expression to use for user group lookup. If you configure allowed_groups, 
you must also configure groups_attribute_path.`,type:"text"},teamsUrl:{label:"Teams URL",description:(0,e.jsxs)(e.Fragment,{children:["The URL used to query for Team Ids. If not set, the default value is /teams."," ",n==="generic_oauth"&&"If you configure teams_url, you must also configure team_ids_attribute_path."]}),type:"text",validation:{validate:(a,s)=>{let r=!0;return s.teamIds.length&&(r=!!a),typeof a=="string"&&a.length&&(r=(0,_.K)(a)),r},message:"This field must be set if Team Ids are configured and must be a valid URL."}},teamIdsAttributePath:{label:"Team Ids attribute path",description:"The JMESPath expression to use for Grafana Team Id lookup within the results returned by the teams_url endpoint.",type:"text",validation:{validate:(a,s)=>s.teamIds.length?!!a:!0,message:"This field must be set if Team Ids are configured."}},teamIds:{label:"Team Ids",type:"select",description:(0,e.jsxs)(e.Fragment,{children:[n==="github"?"Integer":"String"," list of Team Ids. If set, the user must be a member of one of the given teams to log in."," ",n==="generic_oauth"&&"If you configure team_ids, you must also configure teams_url and team_ids_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter Team Ids and press Enter to add",validation:n==="github"?{validate:a=>typeof a=="string"?ve(a):Z(a)?a.every(s=>s?.value&&ve(s.value)):!0,message:"Team Ids must be numbers."}:void 0},hostedDomain:{label:"Hosted domain",description:"The domain under which Grafana is hosted and accessible.",type:"text"},validateHd:{label:"Validate hosted domain",description:"If enabled, Grafana will match the Hosted Domain retrieved from the Google ID Token against the Allowed Domains list specified by the user.",type:"checkbox"}}}function ve(n){return/^-?\d+$/.test(n)}function o(n){switch(n){case"azuread":return'List of "<GroupID>:<OrgIdOrName>:<Role>" mappings.';case"github":return'List of "<GitHubTeamName>:<OrgIdOrName>:<Role>" mappings.';case"gitlab":return'List of "<GitlabGroupName>:<OrgIdOrName>:<Role>';case"google":return'List of "<GoogleGroupName>:<OrgIdOrName>:<Role>';default:return'List of "<ExternalName>:<OrgIdOrName>:<Role>" mappings.'}}const P=({field:n,register:a,errors:s,watch:r,setValue:f,control:p,unregister:y,secretConfigured:x,provider:te})=>{const[ie,re]=(0,l.useState)(x),G=typeof n!="string",i=G?n.name:n,I=G?r(n.dependsOn):null,u=ee(te)[i],Q=(0,Se.$j)();if((0,l.useEffect)(()=>{G&&(I||y(i))},[y,i,I,G]),!n)return console.log("missing field:",i),null;if(u.hidden||G&&!r(n.dependsOn))return null;const T={label:u.label,required:!!u.validation?.required,invalid:!!s[i],error:u.validation?.message,description:u.description,defaultValue:u.defaultValue?.value};switch(u.type){case"text":return(0,e.jsx)(C.D,{...T,children:(0,e.jsx)(Ce.p,{...a(i,u.validation),type:u.type,id:i,autoComplete:"off"})},i);case"secret":return(0,e.jsx)(C.D,{...T,htmlFor:i,children:(0,e.jsx)(W.xI,{name:i,control:p,rules:u.validation,render:({field:{ref:Te,value:M,...de}})=>(0,e.jsx)(Pe.L4,{...de,autoComplete:"off",id:i,value:typeof M=="string"?M:"",isConfigured:ie,onReset:()=>{re(!1),f(i,"")}})})},i);case"select":const oe=r(i);let le=u.options;return u.options?.length||(le=Z(oe)?oe:[]),(0,e.jsx)(C.D,{...T,htmlFor:i,children:(0,e.jsx)(W.xI,{rules:u.validation,name:i,control:p,render:({field:{ref:Te,onChange:M,...de},fieldState:{invalid:je}})=>(0,e.jsx)(J.l6,{...de,placeholder:u.placeholder,isMulti:u.multi,invalid:je,inputId:i,options:le,allowCustomValue:!!u.allowCustomValue,defaultValue:u.defaultValue,onChange:M,onCreateOption:be=>{const K={value:be,label:be};M([...le||[],K])}})})},i);case"switch":return(0,e.jsx)(C.D,{...T,children:(0,e.jsx)(q.d,{...a(i),id:i})},i);case"checkbox":return(0,e.jsx)(Ie.S,{...a(i),id:i,...T,className:(0,ue.css)({marginBottom:Q.spacing(2)})},i);default:return console.error(`Unknown field type: ${u.type}`),null}},w={allowAssignGrafanaAdmin:!1,allowSignUp:!1,allowedDomains:[],allowedGroups:[],allowedOrganizations:[],apiUrl:"",authStyle:"",authUrl:"",autoLogin:!1,clientId:"",clientSecret:"",emailAttributeName:"",emailAttributePath:"",emptyScopes:!1,enabled:!1,extra:{},groupsAttributePath:"",hostedDomain:"",icon:"shield",name:"",roleAttributePath:"",roleAttributeStrict:!1,scopes:[],signoutRedirectUrl:"",skipOrgRoleSync:!1,teamIds:[],teamIdsAttributePath:"",teamsUrl:"",tlsClientCa:"",tlsClientCert:"",tlsClientKey:"",tlsSkipVerify:!1,tokenUrl:"",type:"",usePkce:!1,useRefreshToken:!1},b=n=>n?.length?Array.isArray(n)?n.map(a=>({label:a,value:a})):n.startsWith("[")&&n.endsWith("]")?JSON.parse(n).map(a=>({label:a,value:a})):n.split(/[\s,]/).map(a=>({label:a,value:a})):[];function R(n){if(!n)return w;const a=V(n.provider),s=X(ee(n.provider),a),r={...n.settings};for(const f of s)r[f]=b(r[f]);return r}const F=n=>n.length<=1?n.map(({value:a})=>a).join(","):JSON.stringify(n.map(({value:a})=>a)),V=n=>{const a=ye[n],s=["enabled"];return Object.values(a).reduce((r,f)=>[...r,...f.fields.map(p=>typeof p=="string"?p:p.name)],s)};function z(n,a){let s=n;const r=V(a),f=X(ee(a),r),p=Object.keys(s).filter(y=>r.includes(y)).reduce((y,x)=>({...y,[x]:s[x]}),{});for(const y of f){const x=s[y];x&&(Z(x)?p[y]=F(x):Z([x])&&(p[y]=x.value))}return p}function X(n,a){return Object.entries(n).filter(([s,r])=>a.includes(s)&&r.type==="select").map(([s])=>s)}const L=(0,ne.J7)(),c=({config:n,provider:a,isLoading:s})=>{const{register:r,handleSubmit:f,control:p,reset:y,watch:x,setValue:te,unregister:ie,formState:{errors:re,dirtyFields:G,isSubmitted:i}}=(0,W.mN)({defaultValues:R(n),mode:"onSubmit",reValidateMode:"onChange"}),[I,u]=(0,l.useState)(!1),[Q,T]=(0,l.useState)(!1),oe=i&&!Q,le=ye[a],[Te,M]=(0,l.useState)(!1),de=(0,e.jsx)(d.W,{children:(0,e.jsx)(d.W.Item,{label:"Reset to default values",icon:"history-alt",onClick:()=>{M(!0)}})}),je=async v=>{u(!0),T(!1);const $=z(v,a);try{await(0,E.AI)().put(`/api/v1/sso-settings/${a}`,{id:n?.id,provider:n?.provider,settings:{...$}},{showErrorAlert:!1}),(0,g.rR)("grafana_authentication_ssosettings_saved",{provider:a,enabled:$.enabled}),L.publish({type:O.r1.alertSuccess.name,payload:["Settings saved"]}),y(v),setTimeout(()=>{h.Ny.push("/admin/authentication")},300)}catch(j){let De="";(0,E.NF)(j)?De=j.data.message:j instanceof Error&&(De=j.message),L.publish({type:O.r1.alertError.name,payload:[De]}),T(!0),u(!1)}},be=async()=>{try{await(0,E.AI)().delete(`/api/v1/sso-settings/${a}`,void 0,{showSuccessAlert:!1}),(0,g.rR)("grafana_authentication_ssosettings_removed",{provider:a}),L.publish({type:O.r1.alertSuccess.name,payload:["Settings reset to defaults"]}),setTimeout(()=>{h.Ny.push("/admin/authentication")})}catch(v){let $="";(0,E.NF)(v)?$=v.data.message:v instanceof Error&&($=v.message),L.publish({type:O.r1.alertError.name,payload:[$]})}},K=n?.settings.enabled,we=v=>{(0,g.rR)("grafana_authentication_ssosettings_save_attempt",{provider:a,enabled:v?!K:K}),v&&te("enabled",!K)};return(0,e.jsxs)(S.Y.Contents,{isLoading:s,children:[(0,e.jsxs)("form",{onSubmit:f(je),style:{maxWidth:"600px"},children:[(0,e.jsx)(fe,{confirmRedirect:!!Object.keys(G).length&&!oe,onDiscard:()=>{(0,g.rR)("grafana_authentication_ssosettings_abandoned",{provider:a}),y()}}),(0,e.jsx)(C.D,{label:"Enabled",hidden:!0,children:(0,e.jsx)(q.d,{...r("enabled"),id:"enabled",label:"Enabled"})}),(0,e.jsx)(m.B,{gap:2,direction:"column",children:le.filter(v=>!v.hidden).map((v,$)=>(0,e.jsx)(U.M,{label:v.name,isOpen:$===0,children:v.fields.filter(j=>typeof j!="string"?!j.hidden:!0).map(j=>(0,e.jsx)(P,{field:j,control:p,errors:re,setValue:te,register:r,watch:x,unregister:ie,provider:a,secretConfigured:!!n?.settings.clientSecret},typeof j=="string"?j:j.name))},v.name))}),(0,e.jsx)(H.a,{display:"flex",gap:2,marginTop:5,children:(0,e.jsxs)(m.B,{alignItems:"center",gap:2,children:[(0,e.jsx)(Y.$n,{type:"submit",disabled:I,onClick:()=>we(!0),variant:K?"secondary":void 0,children:I?K?"Disabling...":"Saving...":K?"Disable":"Save and enable"}),(0,e.jsx)(Y.$n,{type:"submit",disabled:I,variant:"secondary",onClick:()=>we(!1),children:I?"Saving...":"Save"}),(0,e.jsx)(Y.z9,{href:"/admin/authentication",variant:"secondary",children:"Discard"}),(0,e.jsx)(xe.m,{overlay:de,placement:"bottom-start",children:(0,e.jsx)(Oe.K,{tooltip:"More actions",title:"More actions",tooltipPlacement:"top",size:"md",variant:"secondary",name:"ellipsis-v",hidden:n?.source==="system"})})]})})]}),Te&&(0,e.jsx)(Ee.u,{isOpen:!0,icon:"trash-alt",title:"Reset",body:(0,e.jsxs)(m.B,{direction:"column",gap:3,children:[(0,e.jsx)("span",{children:"Are you sure you want to reset this configuration?"}),(0,e.jsx)("small",{children:"After resetting these settings Grafana will use the provider configuration from the system (config file/environment variables) if any."})]}),confirmText:"Reset",onDismiss:()=>M(!1),onConfirm:async()=>{await be(),M(!1)}})]})};var B=t(7250),Re=t(60610);const Le=n=>{if(!n)return{text:"Authentication",subTitle:"Configure authentication providers",icon:"shield",id:"authentication"};const a=B.L[n.provider][1]||n.provider.toUpperCase();return{text:a||"",subTitle:`To configure ${a} OAuth2 you must register your application with ${a}. The provider will generate a Client ID and Client Secret for you to use.`,icon:n.settings.icon||"shield",id:n.provider}};function Ge(n,a){const{isLoading:s,providers:r}=n.authConfig,{provider:f}=a.match.params;return{config:r.find(y=>y.provider===f),isLoading:s,provider:f}}const Me={loadProviders:Re.TD},ke=(0,D.connect)(Ge,Me),Ue=({config:n,loadProviders:a,isLoading:s,provider:r})=>{const f=Le(n);return(0,l.useEffect)(()=>{a(r)},[a,r]),n?(0,e.jsx)(S.Y,{navId:"authentication",pageNav:f,renderTitle:p=>(0,e.jsxs)(m.B,{gap:2,alignItems:"center",children:[(0,e.jsx)(k.E,{variant:"h1",children:p}),(0,e.jsx)(N.E,{text:n.settings.enabled?"Enabled":"Not enabled",color:n.settings.enabled?"green":"blue",icon:n.settings.enabled?"check":void 0})]}),children:(0,e.jsx)(c,{config:n,isLoading:s,provider:r})}):null},Ne=ke(Ue)},7250:(ae,A,t)=>{t.d(A,{L:()=>l,o:()=>e});const e="admin/authentication/",l={github:["github","GitHub"],gitlab:["gitlab","GitLab"],google:["google","Google"],generic_oauth:["lock","Generic OAuth"],grafana_com:["grafana","Grafana.com"],azuread:["microsoft","Azure AD"],okta:["okta","Okta"]}},60610:(ae,A,t)=>{t.d(A,{DZ:()=>E,M5:()=>W,TD:()=>O});var e=t(75505),l=t(17172),D=t(32264),m=t(10096),k=t(31678),N=t(73399),S=t(20604);function W(g=!0){return async h=>{if(m.TP.hasPermission(k.AccessControlAction.SettingsRead)){g&&h((0,S.sr)()),h(O());const d=await(0,l.AI)().get("/api/admin/settings");return h((0,S.jA)(d)),await h(ne()),g&&h((0,S.MH)()),d}}}function O(g=""){return async h=>{if(!D.$.featureToggles.ssoSettingsApi)return[];const d=await(0,l.AI)().get(`/api/v1/sso-settings${g?`/${g}`:""}`);return h((0,S.Oy)(g?[d]:d)),d}}function ne(){return async g=>{const h=(0,N.getRegisteredAuthProviders)(),d={},C=[];for(const U of h)C.push((0,N.getAuthProviderStatus)(U.id));const q=await Promise.all(C);for(let U=0;U<h.length;U++){const H=h[U];d[H.id]=q[U]}g((0,S.TO)(d))}}function E(g){return async h=>{if(m.TP.hasPermission(k.AccessControlAction.SettingsWrite))try{return await(0,e.s)((0,l.AI)().fetch({url:"/api/admin/settings",method:"PUT",data:g,showSuccessAlert:!1,showErrorAlert:!1})),h((0,S.SH)()),!0}catch(d){if(console.log(d),(0,l.NF)(d)){d.isHandled=!0;const C={message:d.data?.message,errors:d.data?.errors};return h((0,S.Nh)(C)),!1}}return!1}}},5328:(ae,A,t)=>{t.d(A,{K:()=>D,h:()=>l});var e=t(7250);function l(m){return e.o+(m.configPath||m.id)}const D=m=>{if(typeof m!="string")return!1;try{return new URL(m).protocol.includes("http")}catch{return!1}}},8227:(ae,A,t)=>{t.d(A,{A:()=>D});const e=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function l(m){return typeof m=="string"&&e.test(m)}const D=l}}]);

//# sourceMappingURL=AdminAuthentication.d339ef1fc7f503021d5a.js.map