{"version":3,"file":"7455.bca247a9e0a594d32cf8.js","mappings":"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","sources":["webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/CloudCommonChannelSettings.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/CloudReceiverForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/GrafanaCommonChannelSettings.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/TestContactPointModal.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/GrafanaReceiverForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/ChannelOptions.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/ChannelSubForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/fields/DeletedSubform.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/util.ts","webpack://grafana/./public/app/features/alerting/unified/components/receivers/form/ReceiverForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/receivers/grafanaAppReceivers/onCall/useOnCallIntegration.ts"],"sourcesContent":["import { useFormContext } from 'react-hook-form';\n\nimport { Checkbox, Field } from '@grafana/ui';\n\nimport { CommonSettingsComponentProps } from '../../../types/receiver-form';\n\nexport const CloudCommonChannelSettings = ({\n  pathPrefix,\n  className,\n  readOnly = false,\n}: CommonSettingsComponentProps) => {\n  const { register } = useFormContext();\n  return (\n    <div className={className}>\n      <Field disabled={readOnly}>\n        <Checkbox\n          {...register(`${pathPrefix}sendResolved`)}\n          label=\"Send resolved\"\n          disabled={readOnly}\n          description=\"Whether or not to notify about resolved alerts.\"\n        />\n      </Field>\n    </div>\n  );\n};\n","import { useMemo } from 'react';\n\nimport { Alert } from '@grafana/ui';\nimport { AlertManagerCortexConfig, Receiver } from 'app/plugins/datasource/alertmanager/types';\nimport { useDispatch } from 'app/types';\n\nimport { alertmanagerApi } from '../../../api/alertmanagerApi';\nimport { updateAlertManagerConfigAction } from '../../../state/actions';\nimport { CloudChannelValues, ReceiverFormValues, CloudChannelMap } from '../../../types/receiver-form';\nimport { cloudNotifierTypes } from '../../../utils/cloud-alertmanager-notifier-types';\nimport { isVanillaPrometheusAlertManagerDataSource } from '../../../utils/datasource';\nimport {\n  cloudReceiverToFormValues,\n  formValuesToCloudReceiver,\n  updateConfigWithReceiver,\n} from '../../../utils/receiver-form';\n\nimport { CloudCommonChannelSettings } from './CloudCommonChannelSettings';\nimport { ReceiverForm } from './ReceiverForm';\nimport { Notifier } from './notifiers';\n\ninterface Props {\n  alertManagerSourceName: string;\n  config: AlertManagerCortexConfig;\n  existing?: Receiver;\n  readOnly?: boolean;\n}\n\nconst defaultChannelValues: CloudChannelValues = Object.freeze({\n  __id: '',\n  sendResolved: true,\n  secureSettings: {},\n  settings: {},\n  secureFields: {},\n  type: 'email',\n});\n\nconst cloudNotifiers = cloudNotifierTypes.map<Notifier>((n) => ({ dto: n }));\n\nexport const CloudReceiverForm = ({ existing, alertManagerSourceName, config, readOnly = false }: Props) => {\n  const dispatch = useDispatch();\n  const isVanillaAM = isVanillaPrometheusAlertManagerDataSource(alertManagerSourceName);\n\n  // transform receiver DTO to form values\n  const [existingValue] = useMemo((): [ReceiverFormValues<CloudChannelValues> | undefined, CloudChannelMap] => {\n    if (!existing) {\n      return [undefined, {}];\n    }\n    return cloudReceiverToFormValues(existing, cloudNotifierTypes);\n  }, [existing]);\n\n  const onSubmit = async (values: ReceiverFormValues<CloudChannelValues>) => {\n    const newReceiver = formValuesToCloudReceiver(values, defaultChannelValues);\n    await dispatch(\n      updateAlertManagerConfigAction({\n        newConfig: updateConfigWithReceiver(config, newReceiver, existing?.name),\n        oldConfig: config,\n        alertManagerSourceName,\n        successMessage: existing ? 'Contact point updated.' : 'Contact point created.',\n        redirectPath: '/alerting/notifications',\n      })\n    ).then(() => {\n      dispatch(alertmanagerApi.util.invalidateTags(['AlertmanagerConfiguration']));\n    });\n  };\n\n  const takenReceiverNames = useMemo(\n    () => config.alertmanager_config.receivers?.map(({ name }) => name).filter((name) => name !== existing?.name) ?? [],\n    [config, existing]\n  );\n\n  // this basically checks if we can manage the selected alert manager data source, either because it's a Grafana Managed one\n  // or a Mimir-based AlertManager\n  const isManageableAlertManagerDataSource =\n    !readOnly ?? !isVanillaPrometheusAlertManagerDataSource(alertManagerSourceName);\n\n  return (\n    <>\n      {!isVanillaAM && (\n        <Alert title=\"Info\" severity=\"info\">\n          Note that empty string values will be replaced with global defaults where appropriate.\n        </Alert>\n      )}\n      <ReceiverForm<CloudChannelValues>\n        isEditable={isManageableAlertManagerDataSource}\n        isTestable={isManageableAlertManagerDataSource}\n        config={config}\n        onSubmit={onSubmit}\n        initialValues={existingValue}\n        notifiers={cloudNotifiers}\n        alertManagerSourceName={alertManagerSourceName}\n        defaultItem={defaultChannelValues}\n        takenReceiverNames={takenReceiverNames}\n        commonSettingsComponent={CloudCommonChannelSettings}\n      />\n    </>\n  );\n};\n","import { useFormContext } from 'react-hook-form';\n\nimport { Checkbox, Field } from '@grafana/ui';\n\nimport { CommonSettingsComponentProps } from '../../../types/receiver-form';\n\nexport const GrafanaCommonChannelSettings = ({\n  pathPrefix,\n  className,\n  readOnly = false,\n}: CommonSettingsComponentProps) => {\n  const { register } = useFormContext();\n  return (\n    <div className={className}>\n      <Field>\n        <Checkbox\n          {...register(`${pathPrefix}disableResolveMessage`)}\n          label=\"Disable resolved message\"\n          description=\"Disable the resolve message [OK] that is sent when alerting state returns to false\"\n          disabled={readOnly}\n        />\n      </Field>\n    </div>\n  );\n};\n","import { css } from '@emotion/css';\nimport { useState } from 'react';\nimport { FormProvider, useForm } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, Label, Modal, RadioButtonGroup, useStyles2 } from '@grafana/ui';\nimport { TestReceiversAlert } from 'app/plugins/datasource/alertmanager/types';\nimport { Annotations, Labels } from 'app/types/unified-alerting-dto';\n\nimport { defaultAnnotations } from '../../../utils/constants';\nimport AnnotationsStep from '../../rule-editor/AnnotationsStep';\nimport LabelsField from '../../rule-editor/labels/LabelsField';\n\ninterface Props {\n  isOpen: boolean;\n  onDismiss: () => void;\n  onTest: (alert?: TestReceiversAlert) => void;\n}\n\ntype AnnoField = {\n  key: string;\n  value: string;\n};\n\ninterface FormFields {\n  annotations: AnnoField[];\n  labels: AnnoField[];\n}\n\nenum NotificationType {\n  predefined = 'Predefined',\n  custom = 'Custom',\n}\n\nconst notificationOptions = Object.values(NotificationType).map((value) => ({ label: value, value: value }));\n\nconst defaultValues: FormFields = {\n  annotations: [...defaultAnnotations],\n  labels: [{ key: '', value: '' }],\n};\n\nexport const TestContactPointModal = ({ isOpen, onDismiss, onTest }: Props) => {\n  const [notificationType, setNotificationType] = useState<NotificationType>(NotificationType.predefined);\n  const styles = useStyles2(getStyles);\n  const formMethods = useForm<FormFields>({ defaultValues, mode: 'onBlur' });\n\n  const onSubmit = (data: FormFields) => {\n    if (notificationType === NotificationType.custom) {\n      const alert = {\n        annotations: data.annotations\n          .filter(({ key, value }) => !!key && !!value)\n          .reduce<Annotations>((acc, { key, value }) => {\n            return { ...acc, [key]: value };\n          }, {}),\n        labels: data.labels\n          .filter(({ key, value }) => !!key && !!value)\n          .reduce<Labels>((acc, { key, value }) => {\n            return { ...acc, [key]: value };\n          }, {}),\n      };\n      onTest(alert);\n    } else {\n      onTest();\n    }\n  };\n\n  return (\n    <Modal onDismiss={onDismiss} isOpen={isOpen} title={'Test contact point'}>\n      <div className={styles.section}>\n        <Label>Notification message</Label>\n        <RadioButtonGroup\n          options={notificationOptions}\n          value={notificationType}\n          onChange={(value) => setNotificationType(value)}\n        />\n      </div>\n\n      <FormProvider {...formMethods}>\n        <form onSubmit={formMethods.handleSubmit(onSubmit)}>\n          {notificationType === NotificationType.predefined && (\n            <div className={styles.section}>\n              You will send a test notification that uses a predefined alert. If you have defined a custom template or\n              message, for better results switch to <strong>custom</strong> notification message, from above.\n            </div>\n          )}\n          {notificationType === NotificationType.custom && (\n            <>\n              <div className={styles.section}>\n                You will send a test notification that uses the annotations defined below. This is a good option if you\n                use custom templates and messages.\n              </div>\n              <div className={styles.section}>\n                <AnnotationsStep />\n              </div>\n              <div className={styles.section}>\n                <LabelsField />\n              </div>\n            </>\n          )}\n\n          <Modal.ButtonRow>\n            <Button type=\"submit\">Send test notification</Button>\n          </Modal.ButtonRow>\n        </form>\n      </FormProvider>\n    </Modal>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    alignItems: 'flex-start',\n    marginBottom: theme.spacing(1),\n  }),\n  section: css({\n    marginBottom: theme.spacing(2),\n  }),\n});\n","import { useMemo, useState } from 'react';\n\nimport { Alert, LoadingPlaceholder } from '@grafana/ui';\nimport {\n  AlertManagerCortexConfig,\n  GrafanaManagedContactPoint,\n  GrafanaManagedReceiverConfig,\n  TestReceiversAlert,\n} from 'app/plugins/datasource/alertmanager/types';\nimport { useDispatch } from 'app/types';\n\nimport { alertmanagerApi } from '../../../api/alertmanagerApi';\nimport { testReceiversAction, updateAlertManagerConfigAction } from '../../../state/actions';\nimport { GrafanaChannelValues, ReceiverFormValues } from '../../../types/receiver-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../../utils/datasource';\nimport {\n  formChannelValuesToGrafanaChannelConfig,\n  formValuesToGrafanaReceiver,\n  grafanaReceiverToFormValues,\n  updateConfigWithReceiver,\n} from '../../../utils/receiver-form';\nimport { ProvisionedResource, ProvisioningAlert } from '../../Provisioning';\nimport { ReceiverTypes } from '../grafanaAppReceivers/onCall/onCall';\nimport { useOnCallIntegration } from '../grafanaAppReceivers/onCall/useOnCallIntegration';\n\nimport { GrafanaCommonChannelSettings } from './GrafanaCommonChannelSettings';\nimport { ReceiverForm } from './ReceiverForm';\nimport { TestContactPointModal } from './TestContactPointModal';\nimport { Notifier } from './notifiers';\n\ninterface Props {\n  alertManagerSourceName: string;\n  config: AlertManagerCortexConfig;\n  existing?: GrafanaManagedContactPoint;\n  readOnly?: boolean;\n}\n\nconst defaultChannelValues: GrafanaChannelValues = Object.freeze({\n  __id: '',\n  secureSettings: {},\n  settings: {},\n  secureFields: {},\n  disableResolveMessage: false,\n  type: 'email',\n});\n\nexport const GrafanaReceiverForm = ({ existing, alertManagerSourceName, config, readOnly = false }: Props) => {\n  const dispatch = useDispatch();\n\n  const {\n    onCallNotifierMeta,\n    extendOnCallNotifierFeatures,\n    extendOnCallReceivers,\n    onCallFormValidators,\n    createOnCallIntegrations,\n    isLoadingOnCallIntegration,\n    hasOnCallError,\n  } = useOnCallIntegration();\n\n  const { useGrafanaNotifiersQuery } = alertmanagerApi;\n  const { data: grafanaNotifiers = [], isLoading: isLoadingNotifiers } = useGrafanaNotifiersQuery();\n\n  const [testChannelValues, setTestChannelValues] = useState<GrafanaChannelValues>();\n\n  // transform receiver DTO to form values\n  const [existingValue, id2original] = useMemo((): [\n    ReceiverFormValues<GrafanaChannelValues> | undefined,\n    Record<string, GrafanaManagedReceiverConfig>,\n  ] => {\n    if (!existing || isLoadingNotifiers || isLoadingOnCallIntegration) {\n      return [undefined, {}];\n    }\n\n    return grafanaReceiverToFormValues(extendOnCallReceivers(existing), grafanaNotifiers);\n  }, [existing, isLoadingNotifiers, grafanaNotifiers, extendOnCallReceivers, isLoadingOnCallIntegration]);\n\n  const onSubmit = async (values: ReceiverFormValues<GrafanaChannelValues>) => {\n    const newReceiver = formValuesToGrafanaReceiver(values, id2original, defaultChannelValues, grafanaNotifiers);\n    const receiverWithOnCall = await createOnCallIntegrations(newReceiver);\n\n    const newConfig = updateConfigWithReceiver(config, receiverWithOnCall, existing?.name);\n    await dispatch(\n      updateAlertManagerConfigAction({\n        newConfig: newConfig,\n        oldConfig: config,\n        alertManagerSourceName: GRAFANA_RULES_SOURCE_NAME,\n        successMessage: existing ? 'Contact point updated.' : 'Contact point created',\n        redirectPath: '/alerting/notifications',\n      })\n    ).then(() => {\n      dispatch(alertmanagerApi.util.invalidateTags(['AlertmanagerConfiguration']));\n    });\n  };\n\n  const onTestChannel = (values: GrafanaChannelValues) => {\n    setTestChannelValues(values);\n  };\n\n  const testNotification = (alert?: TestReceiversAlert) => {\n    if (testChannelValues) {\n      const existing: GrafanaManagedReceiverConfig | undefined = id2original[testChannelValues.__id];\n      const chan = formChannelValuesToGrafanaChannelConfig(testChannelValues, defaultChannelValues, 'test', existing);\n\n      const payload = {\n        alertManagerSourceName,\n        receivers: [\n          {\n            name: 'test',\n            grafana_managed_receiver_configs: [chan],\n          },\n        ],\n        alert,\n      };\n\n      dispatch(testReceiversAction(payload));\n    }\n  };\n\n  const takenReceiverNames = useMemo(\n    () => config.alertmanager_config.receivers?.map(({ name }) => name).filter((name) => name !== existing?.name) ?? [],\n    [config, existing]\n  );\n\n  // if any receivers in the contact point have a \"provenance\", the entire contact point should be readOnly\n  const hasProvisionedItems = existing\n    ? (existing.grafana_managed_receiver_configs ?? []).some((item) => Boolean(item.provenance))\n    : false;\n\n  const isEditable = !readOnly && !hasProvisionedItems;\n  const isTestable = !readOnly;\n\n  if (isLoadingNotifiers || isLoadingOnCallIntegration) {\n    return <LoadingPlaceholder text=\"Loading notifiers...\" />;\n  }\n\n  const notifiers: Notifier[] = grafanaNotifiers.map((n) => {\n    if (n.type === 'oncall') {\n      return {\n        dto: extendOnCallNotifierFeatures(n),\n        meta: onCallNotifierMeta,\n      };\n    }\n\n    return { dto: n };\n  });\n\n  return (\n    <>\n      {hasOnCallError && (\n        <Alert severity=\"error\" title=\"Loading OnCall integration failed\">\n          Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the\n          plugin configuration\n        </Alert>\n      )}\n\n      {hasProvisionedItems && <ProvisioningAlert resource={ProvisionedResource.ContactPoint} />}\n\n      <ReceiverForm<GrafanaChannelValues>\n        isEditable={isEditable}\n        isTestable={isTestable}\n        config={config}\n        onSubmit={onSubmit}\n        initialValues={existingValue}\n        onTestChannel={onTestChannel}\n        notifiers={notifiers}\n        alertManagerSourceName={alertManagerSourceName}\n        defaultItem={{ ...defaultChannelValues }}\n        takenReceiverNames={takenReceiverNames}\n        commonSettingsComponent={GrafanaCommonChannelSettings}\n        customValidators={{ [ReceiverTypes.OnCall]: onCallFormValidators }}\n      />\n      <TestContactPointModal\n        onDismiss={() => setTestChannelValues(undefined)}\n        isOpen={!!testChannelValues}\n        onTest={(alert) => testNotification(alert)}\n      />\n    </>\n  );\n};\n","import * as React from 'react';\nimport { useFormContext, FieldError, FieldErrors, DeepMap } from 'react-hook-form';\n\nimport { Button, Field, Input } from '@grafana/ui';\nimport { NotificationChannelOption, NotificationChannelSecureFields } from 'app/types';\n\nimport { ChannelValues, ReceiverFormValues } from '../../../types/receiver-form';\n\nimport { OptionField } from './fields/OptionField';\n\nexport interface Props<R extends ChannelValues> {\n  defaultValues: R;\n  selectedChannelOptions: NotificationChannelOption[];\n  secureFields: NotificationChannelSecureFields;\n\n  onResetSecureField: (key: string) => void;\n  errors?: FieldErrors<R>;\n  pathPrefix?: string;\n  readOnly?: boolean;\n\n  customValidators?: Record<string, React.ComponentProps<typeof OptionField>['customValidator']>;\n}\n\nexport function ChannelOptions<R extends ChannelValues>({\n  defaultValues,\n  selectedChannelOptions,\n  onResetSecureField,\n  secureFields,\n  errors,\n  pathPrefix = '',\n  readOnly = false,\n  customValidators = {},\n}: Props<R>): JSX.Element {\n  const { watch } = useFormContext<ReceiverFormValues<R>>();\n  const currentFormValues = watch(); // react hook form types ARE LYING!\n  return (\n    <>\n      {selectedChannelOptions.map((option: NotificationChannelOption, index: number) => {\n        const key = `${option.label}-${index}`;\n        // Some options can be dependent on other options, this determines what is selected in the dependency options\n        // I think this needs more thought.\n        // pathPrefix = items.index.\n        const paths = pathPrefix.split('.');\n        const selectedOptionValue =\n          paths.length >= 2 ? currentFormValues.items?.[Number(paths[1])].settings?.[option.showWhen.field] : undefined;\n\n        if (option.showWhen.field && selectedOptionValue !== option.showWhen.is) {\n          return null;\n        }\n\n        if (secureFields && secureFields[option.propertyName]) {\n          return (\n            <Field key={key} label={option.label} description={option.description || undefined}>\n              <Input\n                readOnly={true}\n                value=\"Configured\"\n                suffix={\n                  readOnly ? null : (\n                    <Button onClick={() => onResetSecureField(option.propertyName)} fill=\"text\" type=\"button\" size=\"sm\">\n                      Clear\n                    </Button>\n                  )\n                }\n              />\n            </Field>\n          );\n        }\n\n        const error: FieldError | DeepMap<any, FieldError> | undefined = (\n          (option.secure ? errors?.secureSettings : errors?.settings) as DeepMap<any, FieldError> | undefined\n        )?.[option.propertyName];\n\n        const defaultValue = defaultValues?.settings?.[option.propertyName];\n\n        return (\n          <OptionField\n            defaultValue={defaultValue}\n            readOnly={readOnly}\n            key={key}\n            error={error}\n            pathPrefix={pathPrefix}\n            pathSuffix={option.secure ? 'secureSettings.' : 'settings.'}\n            option={option}\n            customValidator={customValidators[option.propertyName]}\n          />\n        );\n      })}\n    </>\n  );\n}\n","import { css } from '@emotion/css';\nimport { sortBy } from 'lodash';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport * as React from 'react';\nimport { Controller, FieldErrors, FieldValues, useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { Alert, Button, Field, Select, Text, useStyles2 } from '@grafana/ui';\nimport { Trans, t } from 'app/core/internationalization';\n\nimport { useUnifiedAlertingSelector } from '../../../hooks/useUnifiedAlertingSelector';\nimport { ChannelValues, CommonSettingsComponentType } from '../../../types/receiver-form';\nimport { OnCallIntegrationType } from '../grafanaAppReceivers/onCall/useOnCallIntegration';\n\nimport { ChannelOptions } from './ChannelOptions';\nimport { CollapsibleSection } from './CollapsibleSection';\nimport { Notifier } from './notifiers';\n\ninterface Props<R extends FieldValues> {\n  defaultValues: R;\n  initialValues?: R;\n  pathPrefix: string;\n  notifiers: Notifier[];\n  onDuplicate: () => void;\n  onTest?: () => void;\n  commonSettingsComponent: CommonSettingsComponentType;\n\n  secureFields?: Record<string, boolean>;\n  errors?: FieldErrors<R>;\n  onDelete?: () => void;\n  isEditable?: boolean;\n  isTestable?: boolean;\n\n  customValidators?: React.ComponentProps<typeof ChannelOptions>['customValidators'];\n}\n\nexport function ChannelSubForm<R extends ChannelValues>({\n  defaultValues,\n  initialValues,\n  pathPrefix,\n  onDuplicate,\n  onDelete,\n  onTest,\n  notifiers,\n  errors,\n  secureFields,\n  commonSettingsComponent: CommonSettingsComponent,\n  isEditable = true,\n  isTestable,\n  customValidators = {},\n}: Props<R>): JSX.Element {\n  const styles = useStyles2(getStyles);\n\n  const fieldName = useCallback((fieldName: string) => `${pathPrefix}${fieldName}`, [pathPrefix]);\n\n  const { control, watch, register, trigger, formState, setValue } = useFormContext();\n  const selectedType = watch(fieldName('type')) ?? defaultValues.type; // nope, setting \"default\" does not work at all.\n  const parse_mode = watch(fieldName('settings.parse_mode'));\n  const { loading: testingReceiver } = useUnifiedAlertingSelector((state) => state.testReceivers);\n\n  // TODO I don't like integration specific code here but other ways require a bigger refactoring\n  const onCallIntegrationType = watch(fieldName('settings.integration_type'));\n  const isTestAvailable = onCallIntegrationType !== OnCallIntegrationType.NewIntegration;\n\n  useEffect(() => {\n    register(`${pathPrefix}.__id`);\n    /* Need to manually register secureFields or else they'll\n     be lost when testing a contact point */\n    register(`${pathPrefix}.secureFields`);\n  }, [register, pathPrefix]);\n\n  // Prevent forgetting about initial values when switching the integration type and the oncall integration type\n  useEffect(() => {\n    // Restore values when switching back from a changed integration to the default one\n    const subscription = watch((v, { name, type }) => {\n      const value = name ? v[name] : '';\n      if (initialValues && name === fieldName('type') && value === initialValues.type && type === 'change') {\n        setValue(fieldName('settings'), initialValues.settings);\n      }\n      // Restore initial value of an existing oncall integration\n      if (\n        initialValues &&\n        name === fieldName('settings.integration_type') &&\n        value === OnCallIntegrationType.ExistingIntegration\n      ) {\n        setValue(fieldName('settings.url'), initialValues.settings.url);\n      }\n    });\n\n    return () => subscription.unsubscribe();\n  }, [selectedType, initialValues, setValue, fieldName, watch]);\n\n  const [_secureFields, setSecureFields] = useState(secureFields ?? {});\n\n  const onResetSecureField = (key: string) => {\n    if (_secureFields[key]) {\n      const updatedSecureFields = { ...secureFields };\n      delete updatedSecureFields[key];\n      setSecureFields(updatedSecureFields);\n      setValue(`${pathPrefix}.secureFields`, updatedSecureFields);\n    }\n  };\n\n  const typeOptions = useMemo(\n    (): SelectableValue[] =>\n      sortBy(notifiers, ({ dto, meta }) => [meta?.order ?? 0, dto.name])\n        // .notifiers.sort((a, b) => a.dto.name.localeCompare(b.dto.name))\n        .map<SelectableValue>(({ dto: { name, type }, meta }) => ({\n          label: name,\n          value: type,\n          description: meta?.description,\n          isDisabled: meta ? !meta.enabled : false,\n          imgUrl: meta?.iconUrl,\n        })),\n    [notifiers]\n  );\n\n  const handleTest = async () => {\n    await trigger();\n    const isValid = Object.keys(formState.errors).length === 0;\n\n    if (isValid && onTest) {\n      onTest();\n    }\n  };\n\n  const notifier = notifiers.find(({ dto: { type } }) => type === selectedType);\n  const isTelegram = selectedType === 'telegram';\n  // Grafana AM takes \"None\" value and maps to an empty string,\n  // Cloud AM takes no value at all\n  const isParseModeNone = parse_mode === 'None' || !parse_mode;\n  const showTelegramWarning = isTelegram && !isParseModeNone;\n  // if there are mandatory options defined, optional options will be hidden by a collapse\n  // if there aren't mandatory options, all options will be shown without collapse\n  const mandatoryOptions = notifier?.dto.options.filter((o) => o.required);\n  const optionalOptions = notifier?.dto.options.filter((o) => !o.required);\n\n  const contactPointTypeInputId = `contact-point-type-${pathPrefix}`;\n  return (\n    <div className={styles.wrapper} data-testid=\"item-container\">\n      <div className={styles.topRow}>\n        <div>\n          <Field label=\"Integration\" htmlFor={contactPointTypeInputId} data-testid={`${pathPrefix}type`}>\n            <Controller\n              name={fieldName('type')}\n              defaultValue={defaultValues.type}\n              render={({ field: { ref, onChange, ...field } }) => (\n                <Select\n                  disabled={!isEditable}\n                  inputId={contactPointTypeInputId}\n                  {...field}\n                  width={37}\n                  options={typeOptions}\n                  onChange={(value) => onChange(value?.value)}\n                />\n              )}\n              control={control}\n              rules={{ required: true }}\n            />\n          </Field>\n        </div>\n        <div className={styles.buttons}>\n          {isTestable && onTest && isTestAvailable && (\n            <Button\n              disabled={testingReceiver}\n              size=\"xs\"\n              variant=\"secondary\"\n              type=\"button\"\n              onClick={() => handleTest()}\n              icon={testingReceiver ? 'spinner' : 'message'}\n            >\n              Test\n            </Button>\n          )}\n          {isEditable && (\n            <>\n              <Button size=\"xs\" variant=\"secondary\" type=\"button\" onClick={() => onDuplicate()} icon=\"copy\">\n                Duplicate\n              </Button>\n              {onDelete && (\n                <Button\n                  data-testid={`${pathPrefix}delete-button`}\n                  size=\"xs\"\n                  variant=\"secondary\"\n                  type=\"button\"\n                  onClick={() => onDelete()}\n                  icon=\"trash-alt\"\n                >\n                  Delete\n                </Button>\n              )}\n            </>\n          )}\n        </div>\n      </div>\n      {notifier && (\n        <div className={styles.innerContent}>\n          {showTelegramWarning && (\n            <Alert\n              title={t(\n                'alerting.contact-points.telegram.parse-mode-warning-title',\n                'Telegram messages are limited to 4096 UTF-8 characters.'\n              )}\n              severity=\"warning\"\n            >\n              <Trans i18nKey=\"alerting.contact-points.telegram.parse-mode-warning-body\">\n                If you use a <Text variant=\"code\">parse_mode</Text> option other than <Text variant=\"code\">None</Text>,\n                truncation may result in an invalid message, causing the notification to fail. For longer messages, we\n                recommend using an alternative contact method.\n              </Trans>\n            </Alert>\n          )}\n          <ChannelOptions<R>\n            defaultValues={defaultValues}\n            selectedChannelOptions={mandatoryOptions?.length ? mandatoryOptions! : optionalOptions!}\n            secureFields={_secureFields}\n            errors={errors}\n            onResetSecureField={onResetSecureField}\n            pathPrefix={pathPrefix}\n            readOnly={!isEditable}\n            customValidators={customValidators}\n          />\n          {!!(mandatoryOptions?.length && optionalOptions?.length) && (\n            <CollapsibleSection label={`Optional ${notifier.dto.name} settings`}>\n              {notifier.dto.info !== '' && (\n                <Alert title=\"\" severity=\"info\">\n                  {notifier.dto.info}\n                </Alert>\n              )}\n              <ChannelOptions<R>\n                defaultValues={defaultValues}\n                selectedChannelOptions={optionalOptions!}\n                secureFields={_secureFields}\n                onResetSecureField={onResetSecureField}\n                errors={errors}\n                pathPrefix={pathPrefix}\n                readOnly={!isEditable}\n                customValidators={customValidators}\n              />\n            </CollapsibleSection>\n          )}\n          <CollapsibleSection label=\"Notification settings\">\n            <CommonSettingsComponent pathPrefix={pathPrefix} readOnly={!isEditable} />\n          </CollapsibleSection>\n        </div>\n      )}\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  buttons: css({\n    '& > * + *': {\n      marginLeft: theme.spacing(1),\n    },\n  }),\n  innerContent: css({\n    maxWidth: '536px',\n  }),\n  wrapper: css({\n    margin: theme.spacing(2, 0),\n    padding: theme.spacing(1),\n    border: `solid 1px ${theme.colors.border.medium}`,\n    borderRadius: theme.shape.radius.default,\n    maxWidth: `${theme.breakpoints.values.xl}${theme.breakpoints.unit}`,\n  }),\n  topRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n  }),\n  channelSettingsHeader: css({\n    marginTop: theme.spacing(2),\n  }),\n});\n","import { useEffect } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\ninterface Props {\n  pathPrefix: string;\n}\n\n// we can't drop the deleted item from list entirely because\n// there will be a rece condition with register/unregister calls in react-hook-form\n// and fields will become randomly erroneously unregistered\nexport function DeletedSubForm({ pathPrefix }: Props): JSX.Element {\n  const { register } = useFormContext();\n\n  // required to be registered or react-hook-form will randomly drop the values when it feels like it\n  useEffect(() => {\n    register(`${pathPrefix}.__id`);\n    register(`${pathPrefix}.__deleted`);\n  }, [register, pathPrefix]);\n\n  return <></>;\n}\n","import { omit } from 'lodash';\n\nimport { ChannelValues, ReceiverFormValues } from '../../../types/receiver-form';\n\nexport interface DeprecatedAuthHTTPConfig {\n  bearer_token?: string;\n  bearer_token_file?: string;\n}\n\nexport interface HTTPAuthConfig {\n  authorization?: {\n    type: string;\n    credentials?: string;\n    credentials_file?: string;\n  };\n}\n\n// convert the newer http_config to the older (deprecated) format\nexport function normalizeFormValues(\n  values?: ReceiverFormValues<ChannelValues>\n): ReceiverFormValues<ChannelValues> | undefined {\n  if (!values) {\n    return;\n  }\n\n  return {\n    ...values,\n    items: values.items.map((item) => ({\n      ...item,\n      settings: {\n        ...item.settings,\n        http_config: item.settings?.http_config ? normalizeHTTPConfig(item.settings?.http_config) : undefined,\n      },\n    })),\n  };\n}\n\nfunction normalizeHTTPConfig(config: HTTPAuthConfig | DeprecatedAuthHTTPConfig): DeprecatedAuthHTTPConfig {\n  if (isDeprecatedHTTPAuthConfig(config)) {\n    return config;\n  }\n\n  return {\n    ...omit(config, 'authorization'),\n    bearer_token: config.authorization?.credentials,\n    bearer_token_file: config.authorization?.credentials_file,\n  };\n}\n\nfunction isDeprecatedHTTPAuthConfig(\n  config: HTTPAuthConfig | DeprecatedAuthHTTPConfig\n): config is DeprecatedAuthHTTPConfig {\n  return ['bearer_token', 'bearer_token_file'].some((prop) => prop in config);\n}\n","import { css } from '@emotion/css';\nimport { useCallback } from 'react';\nimport * as React from 'react';\nimport { FieldErrors, FormProvider, SubmitErrorHandler, useForm, Validate } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { isFetchError } from '@grafana/runtime';\nimport { Alert, Button, Field, Input, LinkButton, useStyles2 } from '@grafana/ui';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { useCleanup } from 'app/core/hooks/useCleanup';\nimport { AlertManagerCortexConfig } from 'app/plugins/datasource/alertmanager/types';\n\nimport { getMessageFromError } from '../../../../../../core/utils/errors';\nimport { logError } from '../../../Analytics';\nimport { isOnCallFetchError } from '../../../api/onCallApi';\nimport { useControlledFieldArray } from '../../../hooks/useControlledFieldArray';\nimport { ChannelValues, CommonSettingsComponentType, ReceiverFormValues } from '../../../types/receiver-form';\nimport { makeAMLink } from '../../../utils/misc';\nimport { initialAsyncRequestState } from '../../../utils/redux';\n\nimport { ChannelSubForm } from './ChannelSubForm';\nimport { DeletedSubForm } from './fields/DeletedSubform';\nimport { Notifier } from './notifiers';\nimport { normalizeFormValues } from './util';\n\ninterface Props<R extends ChannelValues> {\n  config: AlertManagerCortexConfig;\n  notifiers: Notifier[];\n  defaultItem: R;\n  alertManagerSourceName: string;\n  onTestChannel?: (channel: R) => void;\n  onSubmit: (values: ReceiverFormValues<R>) => Promise<void>;\n  takenReceiverNames: string[]; // will validate that user entered receiver name is not one of these\n  commonSettingsComponent: CommonSettingsComponentType;\n  initialValues?: ReceiverFormValues<R>;\n  isEditable: boolean;\n  isTestable?: boolean;\n  customValidators?: Record<string, React.ComponentProps<typeof ChannelSubForm>['customValidators']>;\n}\n\nexport function ReceiverForm<R extends ChannelValues>({\n  config,\n  initialValues,\n  defaultItem,\n  notifiers,\n  alertManagerSourceName,\n  onSubmit,\n  onTestChannel,\n  takenReceiverNames,\n  commonSettingsComponent,\n  isEditable,\n  isTestable,\n  customValidators,\n}: Props<R>): JSX.Element {\n  const notifyApp = useAppNotification();\n  const styles = useStyles2(getStyles);\n\n  // normalize deprecated and new config values\n  const normalizedConfig = normalizeFormValues(initialValues);\n\n  const defaultValues = normalizedConfig ?? {\n    name: '',\n    items: [\n      {\n        ...defaultItem,\n        __id: String(Math.random()),\n      } as any,\n    ],\n  };\n\n  const formAPI = useForm<ReceiverFormValues<R>>({\n    // making a copy here beacuse react-hook-form will mutate these, and break if the object is frozen. for real.\n    defaultValues: structuredClone(defaultValues),\n  });\n\n  useCleanup((state) => (state.unifiedAlerting.saveAMConfig = initialAsyncRequestState));\n\n  const {\n    handleSubmit,\n    register,\n    formState: { errors, isSubmitting },\n    getValues,\n  } = formAPI;\n\n  const { fields, append, remove } = useControlledFieldArray<R>({ name: 'items', formAPI, softDelete: true });\n\n  const validateNameIsAvailable: Validate<string, ReceiverFormValues<R>> = useCallback(\n    (name: string) =>\n      takenReceiverNames.map((name) => name.trim().toLowerCase()).includes(name.trim().toLowerCase())\n        ? 'Another receiver with this name already exists.'\n        : true,\n    [takenReceiverNames]\n  );\n\n  const submitCallback = async (values: ReceiverFormValues<R>) => {\n    try {\n      await onSubmit({\n        ...values,\n        items: values.items.filter((item) => !item.__deleted),\n      });\n    } catch (e) {\n      if (e instanceof Error || isFetchError(e)) {\n        notifyApp.error('Failed to save the contact point', getErrorMessage(e));\n\n        const error = new Error('Failed to save the contact point');\n        error.cause = e;\n        logError(error);\n      }\n      throw e;\n    }\n  };\n\n  const onInvalid: SubmitErrorHandler<ReceiverFormValues<R>> = () => {\n    notifyApp.error('There are errors in the form. Please correct them and try again!');\n  };\n\n  return (\n    <FormProvider {...formAPI}>\n      {!config.alertmanager_config.route && (\n        <Alert severity=\"warning\" title=\"Attention\">\n          Because there is no default policy configured yet, this contact point will automatically be set as default.\n        </Alert>\n      )}\n      <form onSubmit={handleSubmit(submitCallback, onInvalid)}>\n        <h4 className={styles.heading}>\n          {!isEditable ? 'Contact point' : initialValues ? 'Update contact point' : 'Create contact point'}\n        </h4>\n        <Field label=\"Name\" invalid={!!errors.name} error={errors.name && errors.name.message} required>\n          <Input\n            readOnly={!isEditable}\n            id=\"name\"\n            {...register('name', {\n              required: 'Name is required',\n              validate: { nameIsAvailable: validateNameIsAvailable },\n            })}\n            width={39}\n            placeholder=\"Name\"\n          />\n        </Field>\n        {fields.map((field, index) => {\n          const pathPrefix = `items.${index}.`;\n          if (field.__deleted) {\n            return <DeletedSubForm key={field.__id} pathPrefix={pathPrefix} />;\n          }\n          const initialItem = initialValues?.items.find(({ __id }) => __id === field.__id);\n          return (\n            <ChannelSubForm<R>\n              defaultValues={field}\n              initialValues={initialItem}\n              key={field.__id}\n              onDuplicate={() => {\n                const currentValues: R = getValues().items[index];\n                append({ ...currentValues, __id: String(Math.random()) });\n              }}\n              onTest={\n                onTestChannel\n                  ? () => {\n                      const currentValues: R = getValues().items[index];\n                      onTestChannel(currentValues);\n                    }\n                  : undefined\n              }\n              onDelete={() => remove(index)}\n              pathPrefix={pathPrefix}\n              notifiers={notifiers}\n              secureFields={initialItem?.secureFields}\n              errors={errors?.items?.[index] as FieldErrors<R>}\n              commonSettingsComponent={commonSettingsComponent}\n              isEditable={isEditable}\n              isTestable={isTestable}\n              customValidators={customValidators ? customValidators[field.type] : undefined}\n            />\n          );\n        })}\n        <>\n          {isEditable && (\n            <Button\n              type=\"button\"\n              icon=\"plus\"\n              variant=\"secondary\"\n              onClick={() => append({ ...defaultItem, __id: String(Math.random()) })}\n            >\n              Add contact point integration\n            </Button>\n          )}\n          <div className={styles.buttons}>\n            {isEditable && (\n              <>\n                {isSubmitting && (\n                  <Button disabled={true} icon=\"spinner\" variant=\"primary\">\n                    Saving...\n                  </Button>\n                )}\n                {!isSubmitting && <Button type=\"submit\">Save contact point</Button>}\n              </>\n            )}\n            <LinkButton\n              disabled={isSubmitting}\n              variant=\"secondary\"\n              data-testid=\"cancel-button\"\n              href={makeAMLink('alerting/notifications', alertManagerSourceName)}\n            >\n              Cancel\n            </LinkButton>\n          </div>\n        </>\n      </form>\n    </FormProvider>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  heading: css({\n    margin: theme.spacing(4, 0),\n  }),\n  buttons: css({\n    marginTop: theme.spacing(4),\n\n    '& > * + *': {\n      marginLeft: theme.spacing(1),\n    },\n  }),\n});\n\nfunction getErrorMessage(error: unknown) {\n  if (isOnCallFetchError(error)) {\n    return error.data.detail;\n  }\n\n  return getMessageFromError(error);\n}\n","import { produce } from 'immer';\nimport { useCallback, useMemo } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { isFetchError } from '@grafana/runtime';\n\nimport { useAppNotification } from '../../../../../../../core/copy/appNotification';\nimport { Receiver } from '../../../../../../../plugins/datasource/alertmanager/types';\nimport { NotifierDTO } from '../../../../../../../types';\nimport { ONCALL_INTEGRATION_V2_FEATURE, onCallApi } from '../../../../api/onCallApi';\nimport { usePluginBridge } from '../../../../hooks/usePluginBridge';\nimport { SupportedPlugin } from '../../../../types/pluginBridges';\nimport { option } from '../../../../utils/notifier-types';\nimport { GRAFANA_APP_RECEIVERS_SOURCE_IMAGE } from '../types';\n\nimport { GRAFANA_ONCALL_INTEGRATION_TYPE, ReceiverTypes } from './onCall';\n\nexport enum OnCallIntegrationType {\n  NewIntegration = 'new_oncall_integration',\n  ExistingIntegration = 'existing_oncall_integration',\n}\n\nexport enum OnCallIntegrationSetting {\n  IntegrationType = 'integration_type',\n  IntegrationName = 'integration_name',\n}\n\nenum OnCallIntegrationStatus {\n  Disabled = 'disabled',\n  // The old integration done exclusively on the OnCall side\n  // Relies on automatic creation of contact points and altering notification policies\n  // If enabled Alerting UI should not enable any OnCall integration features\n  V1 = 'v1',\n  // The new integration - On Alerting side we create OnCall integrations and use theirs URLs\n  // as parameters for oncall contact points\n  V2 = 'v2',\n}\n\nfunction useOnCallPluginStatus() {\n  const {\n    installed: isOnCallEnabled,\n    loading: isPluginBridgeLoading,\n    error: pluginError,\n  } = usePluginBridge(SupportedPlugin.OnCall);\n\n  const {\n    data: onCallFeatures = [],\n    error: onCallFeaturesError,\n    isLoading: isOnCallFeaturesLoading,\n  } = onCallApi.endpoints.features.useQuery(undefined, { skip: !isOnCallEnabled });\n\n  const integrationStatus = useMemo((): OnCallIntegrationStatus => {\n    if (!isOnCallEnabled) {\n      return OnCallIntegrationStatus.Disabled;\n    }\n    // TODO Support for V2 integration should be added when the OnCall team introduces the necessary changes\n\n    return onCallFeatures.includes(ONCALL_INTEGRATION_V2_FEATURE)\n      ? OnCallIntegrationStatus.V2\n      : OnCallIntegrationStatus.V1;\n  }, [isOnCallEnabled, onCallFeatures]);\n\n  const isAlertingV2IntegrationEnabled = useMemo(\n    () => integrationStatus === OnCallIntegrationStatus.V2,\n    [integrationStatus]\n  );\n\n  return {\n    isOnCallEnabled,\n    integrationStatus,\n    isAlertingV2IntegrationEnabled,\n    isOnCallStatusLoading: isPluginBridgeLoading || isOnCallFeaturesLoading,\n    onCallError: pluginError ?? onCallFeaturesError,\n  };\n}\n\nexport function useOnCallIntegration() {\n  const notifyApp = useAppNotification();\n\n  const { isOnCallEnabled, integrationStatus, isAlertingV2IntegrationEnabled, isOnCallStatusLoading, onCallError } =\n    useOnCallPluginStatus();\n\n  const { useCreateIntegrationMutation, useGrafanaOnCallIntegrationsQuery, useLazyValidateIntegrationNameQuery } =\n    onCallApi;\n\n  const [validateIntegrationNameQuery, { isFetching: isValidating }] = useLazyValidateIntegrationNameQuery();\n  const [createIntegrationMutation] = useCreateIntegrationMutation();\n\n  const {\n    data: grafanaOnCallIntegrations = [],\n    isLoading: isLoadingOnCallIntegrations,\n    isError: isIntegrationsQueryError,\n  } = useGrafanaOnCallIntegrationsQuery(undefined, { skip: !isAlertingV2IntegrationEnabled });\n\n  const onCallFormValidators = useMemo(() => {\n    return {\n      integration_name: async (value: string) => {\n        try {\n          await validateIntegrationNameQuery(value).unwrap();\n          return true;\n        } catch (error) {\n          if (isFetchError(error) && error.status === 409) {\n            return 'Integration of this name already exists in OnCall';\n          }\n\n          notifyApp.error('Failed to validate OnCall integration name. Is the OnCall API available?');\n          throw error;\n        }\n      },\n      url: (value: string) => {\n        if (!isAlertingV2IntegrationEnabled) {\n          return true;\n        }\n\n        return grafanaOnCallIntegrations.map((i) => i.integration_url).includes(value)\n          ? true\n          : 'Selection of existing OnCall integration is required';\n      },\n    };\n  }, [grafanaOnCallIntegrations, validateIntegrationNameQuery, isAlertingV2IntegrationEnabled, notifyApp]);\n\n  const extendOnCallReceivers = useCallback(\n    (receiver: Receiver): Receiver => {\n      if (!isAlertingV2IntegrationEnabled) {\n        return receiver;\n      }\n\n      return produce(receiver, (draft) => {\n        draft.grafana_managed_receiver_configs?.forEach((config) => {\n          if (config.type === ReceiverTypes.OnCall) {\n            config.settings[OnCallIntegrationSetting.IntegrationType] = OnCallIntegrationType.ExistingIntegration;\n          }\n        });\n      });\n    },\n    [isAlertingV2IntegrationEnabled]\n  );\n\n  const createOnCallIntegrations = useCallback(\n    async (receiver: Receiver): Promise<Receiver> => {\n      if (!isAlertingV2IntegrationEnabled) {\n        return receiver;\n      }\n\n      const onCallIntegrations = receiver.grafana_managed_receiver_configs?.filter((c) => c.type === 'oncall') ?? [];\n      const newOnCallIntegrations = onCallIntegrations.filter(\n        (c) => c.settings[OnCallIntegrationSetting.IntegrationType] === OnCallIntegrationType.NewIntegration\n      );\n\n      const createNewOnCallIntegrationJobs = newOnCallIntegrations.map(async (c) => {\n        const newIntegration = await createIntegrationMutation({\n          integration: GRAFANA_ONCALL_INTEGRATION_TYPE,\n          verbal_name: c.settings[OnCallIntegrationSetting.IntegrationName],\n        }).unwrap();\n\n        c.settings.url = newIntegration.integration_url;\n      });\n\n      await Promise.all(createNewOnCallIntegrationJobs);\n\n      return produce(receiver, (draft) => {\n        draft.grafana_managed_receiver_configs?.forEach((c) => {\n          // Clean up the settings before sending the receiver to the backend\n          // The settings object can contain any additional data but integration type and name are purely frontend thing\n          // and should not be sent and kept in the backend\n          if (c.type === ReceiverTypes.OnCall) {\n            delete c.settings[OnCallIntegrationSetting.IntegrationType];\n            delete c.settings[OnCallIntegrationSetting.IntegrationName];\n          }\n        });\n      });\n    },\n    [isAlertingV2IntegrationEnabled, createIntegrationMutation]\n  );\n\n  const extendOnCallNotifierFeatures = useCallback(\n    (notifier: NotifierDTO): NotifierDTO => {\n      // If V2 integration is not enabled the receiver will not be extended\n      // We still allow users to use this contact point but they need to provide URL manually\n      // As they do for webhook integration\n      // Removing the oncall notifier from the list of available notifiers has drawbacks - it's tricky to define what should happen\n      // if someone turned off or downgraded the OnCall plugin but had some receivers configured with OnCall notifier\n      // By falling back to plain URL input we allow users to change the config with OnCall disabled/not supporting V2 integration\n      if (notifier.type === ReceiverTypes.OnCall && isAlertingV2IntegrationEnabled) {\n        const options = notifier.options.filter((o) => o.propertyName !== 'url');\n\n        const newIntegrationOption: SelectableValue<string> = {\n          value: OnCallIntegrationType.NewIntegration,\n          label: 'New OnCall integration',\n          description: 'A new OnCall integration without escalation chains will be automatically created',\n        };\n        const existingIntegrationOption: SelectableValue<string> = {\n          value: OnCallIntegrationType.ExistingIntegration,\n          label: 'Existing OnCall integration',\n          description: 'Use an existing OnCall integration',\n        };\n\n        options.unshift(\n          option(OnCallIntegrationSetting.IntegrationType, 'How to connect to OnCall', '', {\n            required: true,\n            element: 'radio',\n            defaultValue: newIntegrationOption,\n            selectOptions: [newIntegrationOption, existingIntegrationOption],\n          }),\n          option(\n            OnCallIntegrationSetting.IntegrationName,\n            'Integration name',\n            'The name of the new OnCall integration',\n            {\n              required: true,\n              showWhen: { field: 'integration_type', is: OnCallIntegrationType.NewIntegration },\n            }\n          ),\n          option('url', 'OnCall Integration', 'The OnCall integration to send alerts to', {\n            element: 'select',\n            required: true,\n            showWhen: { field: 'integration_type', is: OnCallIntegrationType.ExistingIntegration },\n            selectOptions: grafanaOnCallIntegrations.map((i) => ({\n              label: i.display_name,\n              description: i.integration_url,\n              value: i.integration_url,\n            })),\n          })\n        );\n\n        return { ...notifier, options };\n      }\n\n      return notifier;\n    },\n    [grafanaOnCallIntegrations, isAlertingV2IntegrationEnabled]\n  );\n\n  return {\n    integrationStatus,\n    onCallNotifierMeta: {\n      enabled: !!isOnCallEnabled,\n      order: -1, // The default is 0. We want OnCall to be the first on the list\n      description: isOnCallEnabled\n        ? 'Connect effortlessly to Grafana OnCall'\n        : 'Enable Grafana OnCall plugin to use this integration',\n      iconUrl: GRAFANA_APP_RECEIVERS_SOURCE_IMAGE[SupportedPlugin.OnCall],\n    },\n    extendOnCallNotifierFeatures,\n    extendOnCallReceivers,\n    createOnCallIntegrations,\n    onCallFormValidators,\n    isLoadingOnCallIntegration: isLoadingOnCallIntegrations || isOnCallStatusLoading,\n    isValidating,\n    hasOnCallError: Boolean(onCallError) || isIntegrationsQueryError,\n  };\n}\n"],"names":["CloudCommonChannelSettings","pathPrefix","className","readOnly","register","Field","Checkbox","defaultChannelValues","cloudNotifiers","n","CloudReceiverForm","existing","alertManagerSourceName","config","dispatch","isVanillaAM","existingValue","onSubmit","values","newReceiver","alertmanagerApi","takenReceiverNames","name","isManageableAlertManagerDataSource","Alert","ReceiverForm","GrafanaCommonChannelSettings","NotificationType","notificationOptions","value","defaultValues","TestContactPointModal","isOpen","onDismiss","onTest","notificationType","setNotificationType","styles","getStyles","formMethods","data","alert","key","acc","Modal","Label","RadioButtonGroup","AnnotationsStep","LabelsField","Button","theme","GrafanaReceiverForm","onCallNotifierMeta","extendOnCallNotifierFeatures","extendOnCallReceivers","onCallFormValidators","createOnCallIntegrations","isLoadingOnCallIntegration","hasOnCallError","useOnCallIntegration","useGrafanaNotifiersQuery","grafanaNotifiers","isLoadingNotifiers","testChannelValues","setTestChannelValues","id2original","receiverWithOnCall","newConfig","onTestChannel","testNotification","chan","payload","hasProvisionedItems","item","isEditable","isTestable","LoadingPlaceholder","notifiers","Provisioning","ChannelOptions","selectedChannelOptions","onResetSecureField","secureFields","errors","customValidators","watch","currentFormValues","option","index","paths","selectedOptionValue","Input","error","defaultValue","OptionField","ChannelSubForm","initialValues","onDuplicate","onDelete","CommonSettingsComponent","fieldName","control","trigger","formState","setValue","selectedType","parse_mode","testingReceiver","useUnifiedAlertingSelector","state","isTestAvailable","subscription","v","type","_secureFields","setSecureFields","updatedSecureFields","typeOptions","dto","meta","handleTest","notifier","showTelegramWarning","mandatoryOptions","o","optionalOptions","contactPointTypeInputId","ref","onChange","field","Select","Text","CollapsibleSection","DeletedSubForm","normalizeFormValues","normalizeHTTPConfig","isDeprecatedHTTPAuthConfig","prop","defaultItem","commonSettingsComponent","notifyApp","formAPI","useCleanup","handleSubmit","isSubmitting","getValues","fields","append","remove","useControlledFieldArray","validateNameIsAvailable","submitCallback","e","getErrorMessage","onInvalid","initialItem","__id","currentValues","OnCallIntegrationType","OnCallIntegrationSetting","OnCallIntegrationStatus","useOnCallPluginStatus","isOnCallEnabled","isPluginBridgeLoading","pluginError","onCallFeatures","onCallFeaturesError","isOnCallFeaturesLoading","integrationStatus","isAlertingV2IntegrationEnabled","isOnCallStatusLoading","onCallError","useCreateIntegrationMutation","useGrafanaOnCallIntegrationsQuery","useLazyValidateIntegrationNameQuery","validateIntegrationNameQuery","isValidating","createIntegrationMutation","grafanaOnCallIntegrations","isLoadingOnCallIntegrations","isIntegrationsQueryError","i","receiver","draft","createNewOnCallIntegrationJobs","c","newIntegration","options","newIntegrationOption","existingIntegrationOption"],"sourceRoot":""}